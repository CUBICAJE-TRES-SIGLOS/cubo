Fecha	Unidad	Econ√≥mico	Nombre	Llantas	Descripcion	Volumen	Peso																																																										<!DOCTYPE html>
<html lang="es">
<head>
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <meta charset="UTF-8" />
    <title>Sistema de cubicaje - Comercializadora de Llantas Tres Siglos</title>
    <link rel="icon" type="image/png" href="https://http2.mlstatic.com/storage/mshops-appearance-api/images/13/1184895213/logo-2022082314215812800.png">
    <script src="js/distribucionOptima.js"></script>
    <style>
    body {
        background-image: url('https://www.romacarabs.com/wp-content/uploads/2024/05/Llantas-de-un-coche.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
    }

    /* Ajustar opacidad del fondo de las secciones para mejor legibilidad */
    section {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(5px);
    }

    /* Mejorar visibilidad del header */
    header {
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
    }

    /* Ajustar nav para que se vea mejor con el fondo */
    nav {
        background: rgba(176, 218, 185, 0.95);
        border-radius: 10px;
        backdrop-filter: blur(5px);
    }

    /* Agregar aqu√≠ los nuevos estilos */
    #tablaPedidosActuales td:last-child {
        min-width: 400px; /* Ancho m√≠nimo para los botones */
        white-space: nowrap; /* Evita que los botones se envuelvan */
   }

       #tablaPedidosActuales .btn {
           margin: 2px; /* Espacio entre botones */
           display: inline-block; /* Asegura que los botones se muestren en l√≠nea */
     }
    section {
        background: rgba(255,255,255,0.65); /* Menos opaco, se ve m√°s la imagen */
        border-radius: 16px;
        margin: 32px auto 16px auto;
        max-width: 1200px;
        box-shadow: 0 8px 32px rgba(72,144,81,0.13);
        padding: 28px 22px;
    }
    header img {
        height: 44px;
        margin-right: 12px;
        opacity: 0.7;
    }
    nav {
        display: flex;
        background: #b0dab9e6;
    }
    nav button {
        flex: 1;
        padding: 12px 0;
        color: #24412b;
        background: transparent;
        border: none;
        cursor: pointer;
        font-weight: bold;
        letter-spacing: 1px;
        transition: background 0.3s;
    }
    nav button:hover, nav button.active {
        background: #d9efe0;
    }
        .tabcontent {
            display: none;
            background: transparent;
        }
        .tabcontent.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e2e2e2;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background: #f7fcf8;
        }
        .search-bar {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 7px;
            font-size: 17px;
            border-radius: 5px;
            border: 1px solid #cde5d4;
            flex-grow: 1;
        }
        button.primary {
            background: #489051;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 18px;
            font-weight: bold;
            margin-top: 0;
            transition: background 0.3s;
            white-space: nowrap;
        }
        button.primary:hover {
            background: #75c286;
        }
        .highlight-yellow {
            background-color: #fffa8b;
            transition: background-color 1s;
        }
        .graph-container {
            width: 30%;
            background: #f5fdf7;
            padding: 16px;
            border-radius: 14px;
            border: 1px solid #e2e2e2;
            margin: 8px 5px 16px 0;
            display: inline-block;
            vertical-align: top;
            box-shadow: 0 3px 12px #d6eedd83;
        }
        @media (max-width: 900px){
            .graph-container{ width: 95%; margin:auto; margin-bottom:16px;}
        }
        /* Estilos para la secci√≥n de b√∫squeda de bloques */
        #modoBusqueda .accordion-button {
            padding: 0.75rem 1rem;
            background-color: #f8f9fa;
            border: none;
        }

        #modoBusqueda .accordion-button:not(.collapsed) {
            background-color: #e9ecef;
            color: #212529;
            box-shadow: none;
        }

        #modoBusqueda .list-group-item {
            border-radius: 0;
            border-left: none;
            border-right: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        #modoBusqueda .list-group-item:hover {
            background-color: #f8f9fa;
        }

        #modoBusqueda .table-sm td {
            padding: 0.5rem;
            vertical-align: middle;
        }

        #modoBusqueda .badge {
            font-weight: normal;
            font-size: 0.85em;
        }

        #resultadosBusqueda {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-and-button {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            max-width: 700px;
            flex-wrap: wrap;
        }

        /* Estilos para las eficiencias */
        .eficiencia-badge {
            min-width: 60px;
            text-align: center;
            padding: 0.25em 0.6em;
            border-radius: 12px;
        }

        .eficiencia-alta { background-color: #28a745; color: white; }
        .eficiencia-media { background-color: #ffc107; color: black; }
        .eficiencia-baja { background-color: #dc3545; color: white; }
        /* Modal and Form Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }
        .close:hover {
            color: #000;
        }
        form.add-form label {
            display: block;
            margin: 12px 0 5px 0;
            font-weight: bold;
            color: #35672b;
        }
        form.add-form input[type=text], 
        form.add-form input[type=number] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #a3d087;
            border-radius: 6px;
            box-sizing: border-box;
            margin-bottom: 12px;
            font-size: 16px;
            color: #24412b;
        }
        form.add-form button.submit-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: #489051;
            color: white;
            border: none;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            font-size: 17px;
        }
        form.add-form button.submit-btn:hover {
            background: #75c286;
        }
        .msg {
            margin: 8px 0 0 0;
            font-size: 15px;
            min-height: 20px;
        }
        .msg.success { color: green; }
        .msg.error { color: red; }
        /* Agregar dentro de la secci√≥n <style> existente */
        .alerta-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 2px solid #75c286;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .alerta-flotante button {
            position: absolute;
            top: 5px;
            right: 5px;
            border: none;
            background: none;
            cursor: pointer;
        }
        /* --- Estilos modernos para Facturas --- */
        .btn-gradient {
            background: linear-gradient(90deg, #2193b0 0%, #6dd5ed 100%);
            color: #fff;
            border: none;
            font-weight: bold;
            transition: background 0.3s;
        }
        .btn-gradient:hover {
            background: linear-gradient(90deg, #6dd5ed 0%, #2193b0 100%);
            color: #fff;
        }
        .card {
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(33,147,176,0.15);
        }
        #facturaResult {
            animation: fadeIn 0.7s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @import url('https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css');

        /* Estilos para la secci√≥n de b√∫squeda de bloques */
        .accordion-button:not(.collapsed) {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .accordion-button:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
        }

        #seccionUnidadSugeridaBusqueda .table {
            font-size: 0.9rem;
        }

        #seccionUnidadSugeridaBusqueda .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        #seccionUnidadSugeridaBusqueda .badge {
            font-size: 0.8rem;
            padding: 0.4em 0.6em;
        }

        .eficiencia-badge {
            background: linear-gradient(45deg, #4caf50, #81c784);
            color: white;
            border-radius: 12px;
            padding: 0.3em 0.8em;
        }

        #totalLlantas {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .accordion-body {
            padding: 0.5rem;
        }

        .table-sm td, .table-sm th {
            padding: 0.5rem;
        }
    </style>
</head>
<body>
<!-- Modal instrucciones -->
<div id="modalInstrucciones" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 30px;">
        <span class="close" onclick="cerrarInstrucciones()">&times;</span>
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://cdn.prod.website-files.com/62b4e3084bb69b3cbd747e80/62b4e344650db7626d857053_TS_ORGINAL_LOGO.png" 
                 alt="Logo Tres Siglos" 
                 style="height: 60px; margin-bottom: 20px;">
            <h2 style="color: #489051;">Bienvenido al Sistema de Cubicaje Tres Siglos</h2>
        </div>
        <button onclick="cerrarInstrucciones()" class="btn btn-lg btn-success">
               Cerrar instrucciones
        </button>
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üè≠ Gesti√≥n de Inventario</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li>‚úì Consulta el inventario actual</li>
                            <li>‚úì Agrega nuevas llantas</li>
                            <li>‚úì Edita informaci√≥n existente</li>
                            <li>‚úì Calcula vol√∫menes autom√°ticamente</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üöõ Control de Flota</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li>‚úì Administra unidades de transporte</li>
                            <li>‚úì Controla capacidades y l√≠mites</li>
                            <li>‚úì Asigna responsables</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üì¶ Gesti√≥n de Pedidos</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li>‚úì Calcula de manera rapida capacidades</li>
                            <li>‚úì Control de volumen y peso</li>
                            <li>‚úì Sugerencias autom√°ticas</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">üìÑ Escaneo de Documentos</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li>‚úì Escanea traspasos y facturas</li>
                            <li>‚úì Procesamiento autom√°tico</li>
                            <li>‚úì Gesti√≥n de bloques</li>
                            <li>‚úì Historial de documentos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <h5>üí° Tips r√°pidos:</h5>
            <ul>
                <li>Usa la barra de b√∫squeda para filtrar informaci√≥n r√°pidamente</li>
                <li>El bot√≥n de ayuda (‚ùî) estar√° siempre disponible en la esquina inferior izquierda</li>
                <li>Monitorea las alertas de capacidad en tiempo real</li>
                <li>Guarda frecuentemente los cambios importantes</li>
            </ul>
        </div>

        <div class="text-center mt-4">
        </div>
    </div>
</div>

<style>
/* Estilos para el modal de instrucciones */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: slideIn 0.3s;
    max-height: 95vh;
    overflow-y: auto;
}

.close {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #666;
    transition: color 0.3s;
}

.close:hover {
    color: #000;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.list-unstyled li {
    margin-bottom: 8px;
    padding-left: 20px;
    position: relative;
}

.list-unstyled li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: #489051;
}
</style>

<script>
// Scripts para el modal

// Funci√≥n para cargar las descripciones de llantas
async function cargarDescripcionesLlantas() {
    try {
        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados');
        if (!response.ok) {
            throw new Error('Error al cargar datos de llantas');
        }
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error al cargar descripciones de llantas:', error);
        throw error;
    }
}
// Funci√≥n para inicializar la aplicaci√≥n
async function inicializarAplicacion() {
    try {
        await cargarDatosDesdeSheetDB();
        console.log('Datos cargados correctamente');
    } catch (error) {
        console.error('Error al inicializar la aplicaci√≥n:', error);
    }
}

// App Initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize app core
    const appInitializer = {
        init: async function() {
            await inicializarAplicacion();
            this.setupInstructions();
            this.setupHelpButton();
            this.setupEventListeners();
        },

        setupInstructions: function() {
            window.mostrarInstrucciones = () => {
                document.getElementById('modalInstrucciones').style.display = 'block';
            };

            window.cerrarInstrucciones = () => {
                document.getElementById('modalInstrucciones').style.display = 'none';
                localStorage.setItem('instruccionesVistas', 'true');
            };

            // Show instructions modal with delay
            setTimeout(mostrarInstrucciones, 500);
        },

        setupHelpButton: function() {
            const btnAyuda = document.createElement('button');
            btnAyuda.innerHTML = '‚ùî Ayuda';
            btnAyuda.className = 'help-button';
            btnAyuda.onclick = mostrarInstrucciones;
            
            // Add button styles via CSS class instead of inline styles
            const style = document.createElement('style');
            style.textContent = `
                .help-button {
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: #489051;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    padding: 10px 15px;
                    cursor: pointer;
                    z-index: 999;
                    transition: all 0.3s ease;
                }
                .help-button:hover {
                    transform: scale(1.1);
                    background: #5aad64;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(btnAyuda);
        },

        setupEventListeners: function() {
            // Add any additional event listeners here
        }
    };

    // Initialize the application
    appInitializer.init();
});
</script>    

<header>
    <img src="https://cdn.prod.website-files.com/62b4e3084bb69b3cbd747e80/62b4e344650db7626d857053_TS_ORGINAL_LOGO.png" alt="Logo Tres Siglos" />
    <h1>Sistema de cubicaje - Comercializadora de Llantas Tres Siglos</h1>
</header>

<nav>
    <button class="tablink active" data-tab="inventario">Inventario</button>
    <button class="tablink" data-tab="flota">Flota</button>
    <button class="tablink" data-tab="facturas" onclick="actualizarBloquesFacturas()">Escaneo de traspasos o facturas</button> 
    <button class="tablink" data-tab="pedidos">Pedidos</button>
    <button class="tablink" data-tab="sugerencia-unidad">Sugerencia de Unidad</button>
    <button class="tablink" data-tab="pedidos-Apartados">Pedidos Apartados</button>
</nav>

<!-- Pedidos Apartados -->
<div id="pedidos-Apartados" class="tabcontent">
    <h3>Pedidos Apartados</h3>
    <div class="card">
        <div class="card-body">
            <!-- Agregar barra de b√∫squeda -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" 
                           class="form-control" 
                           id="busquedaApartados" 
                           placeholder="Buscar por n√∫mero econ√≥mico..." 
                           oninput="buscarPedidoConfirmado()">
                     </div>
                </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Unidad</th>
                            <th>Econ√≥mico</th>
                            <th>Nombre</th>
                            <th>Llantas</th>
                            <th>Descripci√≥n</th>
                            <th>Volumen</th>
                            <th>Peso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaPedidosApartados">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<section>

    <!-- Inventario -->
    <div id="inventario" class="tabcontent active">
        <div class="search-and-button">
            <input type="text" id="searchInventario" class="search-bar" placeholder="Buscar por ID Llanta..." oninput="searchInventario()" />
            <button class="primary" onclick="openModal('modalInventario')">Agregar Llanta</button>
            <button class="primary" onclick="calcularPesosInventario()">Calcular Pesos Aproximados</button>
            <button class="primary" onclick="calcularVolumenInventario()">Calcular Vol√∫menes</button>
        </div>

        <div id="loadingMessage" style="display:none;">Calculando vol√∫menes...</div>

        <table id="tablaInventario">
            <thead>
                <tr>
                    <th>clave</th>
                    <th>Descripci√≥n</th>
                    <th>L√≠nea</th>
                    <th>Peso (kg)</th>
                    <th>Volumen (m¬≥)</th>
                    <th>Valor ($)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Inventario -->
    <div id="modalInventario" class="modal">
    <div id="loadingMessage" style="display:none;">Calculando vol√∫menes...</div>
    <div class="modal-content">
        <span class="close" onclick="closeModal('modalInventario')">&times;</span>
        <form id="formAgregarLlanta" class="add-form" onsubmit="event.preventDefault(); agregarNuevaLlanta();">
            <h3>Agregar Nueva Llanta</h3>
            
            <!-- Campos requeridos -->
            <label for="agregarId">ID (requerido) *</label>
            <input type="text" 
                   id="agregarId" 
                   placeholder="Ejemplo: 1001" 
                   required />

            <label for="agregarDescripcion">Descripci√≥n (requerido) *</label>
            <input type="text" 
                   id="agregarDescripcion" 
                   placeholder="Descripci√≥n de la llanta" 
                   required />

            <!-- Campos opcionales -->
            <label for="agregarPeso">Peso (kg) (opcional)</label>
            <input type="number" 
                   id="agregarPeso" 
                   step="0.01" 
                   min="0" 
                   placeholder="Ejemplo: 12.5" />

            <label for="agregarVolumen">Volumen unitario (m¬≥) (opcional)</label>
            <input type="number" 
                   id="agregarVolumen" 
                   step="0.0001" 
                   min="0" 
                   placeholder="Ejemplo: 0.0035" />

            <label for="agregarValor">Valor unitario ($) (opcional)</label>
            <input type="number" 
                   id="agregarValor" 
                   step="0.01" 
                   min="0" 
                   placeholder="Ejemplo: 1500.00" />

            <label for="agregarLinea">L√≠nea (opcional)</label>
            <input type="text" 
                   id="agregarLinea" 
                   placeholder="Ejemplo: Industrial" />

            <button type="submit" class="submit-btn">Agregar Llanta</button>
            <div id="msgInventario" class="msg"></div>
        </form>
    </div>
</div>

    <!-- Flota -->
    <div id="flota" class="tabcontent">
        <div class="search-and-button">
            <input type="text" id="searchFlota" class="search-bar" placeholder="Buscar por N√∫mero Econ√≥mico..." oninput="searchFlota()" />
            <button class="primary" onclick="openModal('modalFlota')">Agregar Cami√≥n</button>
            <button class="primary" onclick="fetchFlota()">Actualizar flota</button>
        </div>

        <table id="tablaFlota">
            <thead>
                <tr>
                    <th>Econ√≥mico</th>
                    <th>Unidad</th>
                    <th>Asignado</th>
                    <th>Modelo</th>
                    <th>identificacion</th>
                    <th>Ubicaci√≥n</th>
                    <th>capacidad de carga (kg)</th>
                    <th>Volumen (m¬≥)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Flota -->
    <div id="modalFlota" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modalFlota')">&times;</span>
            <form id="formAgregarCamion" class="add-form" onsubmit="event.preventDefault(); agregarNuevoCamion();">
                <h3>Agregar Nuevo Cami√≥n</h3>

                <label for="agregarEconomico">N√∫mero Econ√≥mico (dejar vac√≠o para autogenerar)</label>
                <input type="text" id="agregarEconomico" placeholder="Ejemplo: 101 o dejar vac√≠o para auto" />

                <label for="agregarUnidad">Unidad</label>
                <input type="text" id="agregarUnidad" placeholder="Unidad/veh√≠culo" required />

                <label for="agregarAsignado">Asignado</label>
                <input type="text" id="agregarAsignado" placeholder="Nombre responsable" required />

                <label for="agregarModelo">Modelo</label>
                <input type="text" id="agregarModelo" placeholder="Modelo del cami√≥n" required />

                <label for="agregarPlacas">Placas</label>
                <input type="text" id="agregarPlacas" placeholder="Placas del cami√≥n" required />

                <label for="agregarUbicacion">Ubicaci√≥n</label>
                <input type="text" id="agregarUbicacion" placeholder="Ubicaci√≥n del cami√≥n" required />

                <label for="agregarCarga">Capacidad de Carga (kg)</label>
                <input type="number" id="agregarCarga" step="0.01" min="0" placeholder="Ejemplo: 15000" required />

                <label for="agregarVolumenCamion">Capacidad de Volumen (m¬≥)</label>
                <input type="number" id="agregarVolumenCamion" step="0.0001" min="0" placeholder="Ejemplo: 40.5" required />

                <button type="submit" class="submit-btn">Agregar Cami√≥n</button>
                <div id="msgFlota" class="msg"></div>
            </form>      
        </div>
    </div>
          
    <!-- Pedidos -->    
    <div id="pedidos" class="tabcontent" style="max-width: 1000px;">
        <div>
            <label for="inputPedidoNumEconomico">N√∫mero Econ√≥mico Cami√≥n:</label>
            <input type="text" id="inputPedidoNumEconomico" oninput="llenarDatosCamionPedido()" placeholder="Ingrese n√∫mero econ√≥mico" />
        </div>                
        <div id="datosCamionPedido" style="margin-top:10px; font-weight:bold; min-height: 50px;"></div>
        <!-- Reemplazar la secci√≥n actual de verificaci√≥n r√°pida con esto -->
        <div style="margin-top:10px;">
        <button class="btn btn-info" onclick="toggleVerificacionRapida()">
            <i class="bi bi-calculator"></i> Mostrar Calculadora R√°pida
        </button>
    
        <div id="verificacionRapidaPanel" style="display:none;">
            <div class="card mb-3 mt-3">
               <div class="card-header">
                   <h5>Verificaci√≥n R√°pida de Capacidad</h5>
              </div>
              <div class="card-body">
                  <div class="row">
                      <div class="col-md-3">
                          <label>Cantidad</label>
                          <input type="number" id="quickCheckCantidad" class="form-control" value="1" min="1">
                     </div>
                     <div class="col-md-3">
                         <label>Tipo de Llanta</label>
                         <select class="form-control tipo-llanta">
                             <option value="AUTO">Auto peque√±o/compacto</option>
                             <option value="SUV_CAMIONETA">Camioneta / SUV</option>
                             <option value="COMERCIAL_LIGERO">Comerciales ligeros</option>
                             <option value="PESADO">Camiones pesados</option>
                             <option value="AGRICOLA_MINERO">Agr√≠colas / especiales</option>
                             <option value="CAMARAS">C√°maras y otros</option>
                        </select>
                     </div>
                     <div class="col-md-4 d-flex align-items-end">
                         <button onclick="verificacionRapida()" class="btn btn-primary">
                             Verificar Capacidad
                         </button>
                     </div>
                 </div>
             </div>
         </div>
     </div>
 </div>
          
        <div style="margin-top: 20px;">
            <div class="graph-container">
                <canvas id="graphVolumen" width="150" height="50"></canvas>
                <p style="text-align:center">Espacio usado</p>
           </div>
           <div class="graph-container">
               <canvas id="graphCarga" width="150" height="50"></canvas>
               <p style="text-align:center">Carga Usada</p>
           </div>
       </div>

        <h3>Agregar Llanta al Pedido</h3>

        <!-- Formulario para agregar llanta individual al pedido (necesario para las funciones JS) -->
        <div style="margin-bottom:12px; display:flex; gap:8px; align-items:end; flex-wrap:wrap;">
            <div style="display:flex;flex-direction:column;">
                <label for="pedidoCodigoLlanta">C√≥digo / Clave</label>
                <input type="text" id="pedidoCodigoLlanta" placeholder="C√≥digo o clave" oninput="autoCompletarLlantaPedidoPorCodigo()" />
            </div>
            <div style="display:flex;flex-direction:column;">
                <label for="pedidoDescripcionLlantaInput">Descripci√≥n</label>
                <input type="text" id="pedidoDescripcionLlantaInput" placeholder="Descripci√≥n" oninput="autoCompletarLlantaPedidoPorDescripcion()" />
            </div>
            <div style="display:flex;flex-direction:column;">
                <label>L√≠nea</label>
                <div id="pedidoLineaLlanta"></div>
           </div>
            <div style="display:flex;flex-direction:column; width:90px;">
                <label for="pedidoCantidadLlanta">Cantidad</label>
                <input type="number" id="pedidoCantidadLlanta" value="1" min="1" onchange="calcularTotalesPedido()" />
            </div>
            <div style="display:flex;flex-direction:column;">
                <label>Peso total</label>
                <div id="pedidoPesoLlanta">0</div>
            </div>
            <div style="display:flex;flex-direction:column;">
                <label>Volumen total</label>
                <div id="pedidoVolumenLlanta">0</div>
            </div>
            <div style="display:flex;flex-direction:column;">
                <label>Valor unitario</label>
                <div id="pedidoValorUnitarioLlanta">0</div>
            </div>
            <div>
                <button class="primary" onclick="agregarPedido()">Agregar al pedido</button>
            </div>
        </div>

        <!-- Campo para agregar bloque por folio -->
        <div style="margin-bottom: 10px;">
             <label for="inputFolioFacturaPedido"><b>Folio de Factura:</b></label>
             <div class="input-group" style="margin: 10px 0;">
                 <input type="text" id="inputFolioFacturaPedido" class="form-control" placeholder="Escribe el folio para buscar" style="margin-left:8px;"/>
                 <div class="input-group-append" style="display: flex; gap: 5px; margin-left: 5px;">
                     <button class="primary" onclick="buscarBloquePorFolio()">Buscar bloque</button>
                     <button class="primary" onclick="agregarBloquePorFolioPedido(false)">Agregar bloque</button>
                     <button class="primary" onclick="limpiarPedidosActuales()" style="background:#d9534f;">
                         <i class="bi bi-trash"></i> Limpiar
                     </button>
                 </div>
             </div>
             <div id="bloqueBuscadoPedido"></div>
             <div id="bloquesPendientes" class="mt-2"></div>
              <div style="margin-top: 10px; font-weight: bold;">
            <span id="totalesPedido"></span>
        </div>
        <button class="primary" onclick="aceptarPedido()" style="margin-top: 10px;">Aceptar Pedido</button>
        </div>

        <h3>Pedidos actuales del cami√≥n</h3>
        <table id="tablaPedidosActuales" style="max-width:700px;">
            <thead>
                <tr>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                    <th>L√≠nea</th>
                    <th>Cantidad</th>
                    <th>Volumen Total</th>
                    <th>Peso Total</th>
                    <th>Valor Total ($)</th>
                    <th>Quitar</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Sugerencia de Unidad -->
    <div id="sugerencia-unidad" class="tabcontent" style="max-width: 1000px;">
        <h3>Sugerencia de Unidad</h3>
        
        <!-- Botones de modo -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group" aria-label="Modo de sugerencia">
                <button type="button" class="btn btn-primary active" id="btnModoCalculadora" onclick="cambiarModoSugerencia('calculadora')">
                    Calculadora
                </button>
                <button type="button" class="btn btn-primary" id="btnModoBusqueda" onclick="cambiarModoSugerencia('busqueda')">
                    B√∫squeda de Bloques
                </button>
            </div>
        </div>

        <!-- Modo Calculadora -->
        <div id="modoCalculadora">
            <!-- Secci√≥n de Unidad Sugerida para modo calculadora -->
            <div id="seccionUnidadSugeridaCalculadora" class="card mb-3" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Unidad Sugerida</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="bg-light">
                                <tr>
                                    <th>Unidad</th>
                                    <th>Econ√≥mico</th>
                                    <th>Cap. Volumen</th>
                                    <th>Cap. Peso</th>
                                    <th style="width: 120px">Uso Volumen</th>
                                    <th style="width: 120px">Uso Peso</th>
                                    <th style="width: 120px">Eficiencia</th>
                                    <th style="width: 150px">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaUnidadesSugeridasCalculadora">
                                <!-- Las unidades sugeridas se insertar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Agregar Llantas al C√°lculo</h5>
                <button class="btn btn-outline-danger" onclick="limpiarCalculadora()">
                    <i class="bi bi-trash"></i> Limpiar Todo
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Cantidad</label>
                        <input type="number" id="sugestionCantidad" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-6">
                        <label>Descripci√≥n de Llanta</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="busquedaLlanta" placeholder="Escriba para buscar llanta...">
                            <div id="sugerenciasLlantas" class="position-absolute w-100 bg-white shadow-sm border rounded-bottom" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000;">
                            </div>
                        </div>
                        <input type="hidden" id="descripcionLlanta" value="">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary" onclick="agregarTipoLlanta()">
                            <i class="bi bi-plus-circle"></i> Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5>Llantas Agregadas</h5>
            </div>
            <div class="card-body">
                <table class="table" id="tablaLlantasAgregadas">
                    <thead>
                        <tr>
                            <th>Tipo de Llanta</th>
                            <th>Cantidad</th>
                            <th>Volumen Total</th>
                            <th>Peso Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="totalLlantas" style="font-weight: bold; margin-top: 10px;"></div>
            </div>
        </div>

        <div id="resultadoSugerencia" class="card d-none">
            <div class="card-body">
                <h5 class="card-title">Unidad Sugerida</h5>
                <div id="unidadSugeridaDetalles"></div>
            </div>
        </div>
    </div>

    <!-- Modo B√∫squeda de Bloques -->
    <div id="modoBusqueda" style="display: none;">
        <!-- Barra de b√∫squeda y tabla de llantas -->
        <div class="row g-3 mb-3">
            <!-- Buscador de Bloques -->
            <div style="margin-bottom: 20px;">
                <label for="inputBusquedaBloqueNuevo"><b>Buscar Bloque:</b></label>
                <div class="input-group" style="margin: 10px 0;">
                    <input type="text" 
                           id="inputBusquedaBloqueNuevo" 
                           class="form-control" 
                           placeholder="Escribe el folio para buscar" 
                           style="margin-left:8px;"/>
                    <div class="input-group-append" style="display: flex; gap: 5px; margin-left: 5px;">
                        <button class="primary" onclick="buscarBloqueEnModo()">
                            <i class="bi bi-search"></i> Buscar bloque
                        </button>
                        <button class="primary" onclick="agregarBloqueEnModo(true)">
                            <i class="bi bi-plus-circle"></i> Agregar
                        </button>
                        <button class="primary" onclick="limpiarBusquedaBloqueEnModo()" style="background:#d9534f;">
                            <i class="bi bi-trash"></i> Limpiar
                        </button>
                    </div>
                </div>
                <!-- √Årea para mostrar bloques pendientes -->
                <div id="bloquesPendientesNuevoModo" class="mt-3"></div>
                <div id="resultadoBusquedaBloqueNuevo"></div>
                <div id="bloquesPendientesNuevo" class="mt-2"></div>
            </div>

            <!-- Acorde√≥n de Llantas del Bloque -->
            <div class="accordion mb-4" id="acordeonLlantasBloque">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button bg-success text-white" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseLlantasBloque" 
                                aria-expanded="true" 
                                aria-controls="collapseLlantasBloque">
                            <div class="d-flex align-items-center w-100">
                                <i class="bi bi-stack me-2"></i>
                                <span class="me-auto">Llantas en el Bloque</span>
                                <span class="badge bg-light text-success ms-2" id="contadorLlantasBloque">0</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapseLlantasBloque" 
                         class="accordion-collapse collapse show" 
                         data-bs-parent="#acordeonLlantasBloque">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Descripci√≥n</th>
                                            <th>L√≠nea</th>
                                            <th>Cantidad</th>
                                            <th>Volumen Total</th>
                                            <th>Peso Total</th>
                                            <th>Valor Total ($)</th>
                                            <th>Quitar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaLlantasBloque"></tbody>
                                    <tfoot class="table-light fw-bold">
                                        <tr>
                                            <td colspan="3" class="text-end">Totales:</td>
                                            <td id="totalCantidadLlantas" class="text-center">0</td>
                                            <td id="totalVolumenLlantas" class="text-end">0</td>
                                            <td id="totalPesoLlantas" class="text-end">0</td>
                                            <td id="totalValorLlantas" class="text-end">$0</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nueva secci√≥n de Unidades Disponibles -->
            <div class="accordion mb-4" id="acordeonUnidadesDisponibles">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button bg-primary text-white" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseUnidadesDisponibles" 
                                aria-expanded="true" 
                                aria-controls="collapseUnidadesDisponibles">
                            <div class="d-flex align-items-center w-100">
                                <i class="bi bi-truck me-2"></i>
                                <span class="me-auto">Unidades Disponibles</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapseUnidadesDisponibles" 
                         class="accordion-collapse collapse show" 
                         data-bs-parent="#acordeonUnidadesDisponibles">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Unidad</th>
                                            <th>Econ√≥mico</th>
                                            <th>Cap. Volumen</th>
                                            <th>Cap. Peso</th>
                                            <th>Uso Volumen</th>
                                            <th>Uso Peso</th>
                                            <th>Eficiencia</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaUnidadesDisponibles">
                                        <!-- Las unidades disponibles se insertar√°n aqu√≠ din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de Unidad Sugerida -->
                <div id="seccionUnidadSugeridaPrincipal" class="card mb-3" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Unidad Sugerida</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Unidad</th>
                                        <th>Econ√≥mico</th>
                                        <th>Cap. Volumen</th>
                                        <th>Cap. Peso</th>
                                        <th style="width: 120px">Uso Volumen</th>
                                        <th style="width: 120px">Uso Peso</th>
                                        <th style="width: 120px">Eficiencia</th>
                                        <th style="width: 150px">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaUnidadesPrincipal">
                                    <!-- Las unidades sugeridas se insertar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                        <div id="unidadSugeridaDetalles" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
                </table>
                <div id="totalLlantas" class="alert alert-info mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Pedidos Apartados -->
    <div id="pedidos-Apartados" class="tabcontent" style="max-width: 1200px;">
        <h3>Pedidos Apartados</h3>
        <table id="tabla">
            <thead>
                <tr>
                    <th>Cami√≥n</th>
                    <th>Llantas</th>
                    <th>Descripci√≥n</th>
                    <th>Cantidad</th>
                    <th>Total,Cantidad</th>
                    <th>L√≠nea</th>
                    <th>Volumen</th>
                    <th>Peso</th>
                    <th>Valor ($)</th>
                    <th>Fecha</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
  <!-- OCR PDF para Facturas -->
<!-- Modernizado: OCR PDF para Facturas -->
<!-- Dentro del div id="facturas" existente -->
<div class="tabcontent" id="facturas">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <!-- Pesta√±as para los diferentes tipos de facturas -->
               <!-- Pesta√±as para los diferentes tipos de facturas -->
               <ul class="nav nav-tabs mb-4" id="facturasTab" role="tablist">
                   <li class="nav-item" role="presentation">
                       <button class="nav-link active" id="facturas-normales-tab" data-bs-toggle="tab" data-bs-target="#facturasNormales" type="button" role="tab">
                           Traspasos
                       </button>
                   </li>
                   <li class="nav-item" role="presentation">
                       <button class="nav-link" id="facturas-especiales-tab" data-bs-toggle="tab" data-bs-target="#facturasEspeciales" type="button" role="tab">
                           Facturas
                       </button>
                   </li>
               </ul>

                <!-- Contenido de las pesta√±as -->
                <div class="tab-content">
                    <!-- Pesta√±a 1: Sistema actual -->
                    <div class="tab-pane fade show active" id="facturasNormales">
                        <div class="card shadow-lg border-0 rounded-4">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="me-2" style="font-size:2rem;color:#2193b0;">
                                        <i class="bi bi-file-earmark-pdf"></i>
                                    </span>
                                    <h2 class="mb-0 text-center flex-grow-1" style="color:#2193b0;">
                                        Escanea tus traspasos para ser m√°s √°gil el proceso de acomodo
                                    </h2>
                                </div>
                                <div class="mb-3">
                                    <label for="facturaPdfInput" class="form-label">
                                        Selecciona tu archivo PDF de factura
                                    </label>
                                    <input type="file" id="facturaPdfInput" accept="application/pdf" 
                                           class="form-control" multiple>
                                </div>
                                <button id="facturaScanBtn" class="btn btn-gradient w-100 mb-3">
                                    <i class="bi bi-search"></i> Escanear y extraer texto
                                </button>
                                <button id="facturaCacheClearBtn" class="btn btn-warning w-100 mb-3">
                                    <i class="bi bi-trash"></i> Limpiar Cach√©
                                </button>
                                <button id="facturaClearBtn" class="btn btn-outline-danger w-100 mb-3">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                                <div class="mb-3 d-flex gap-2 align-items-center">
                                    <input type="text" id="facturaSearchFolio" class="form-control" 
                                           placeholder="Buscar por n√∫mero de folio..." />
                                    <input type="text" id="nombreBloqueFactura" class="form-control" 
                                           placeholder="Nombre del bloque (ej: Facturas Julio 2025)">
                                    <button id="btnTerminarBloqueFactura" class="btn btn-success">
                                        Terminar y guardar bloque
                                    </button>
                                </div>
                                <div id="facturaLoading" class="text-center" style="display:none;">
                                    <div class="spinner-border text-info"></div>
                                    <p>Procesando...</p>
                                </div>
                                <progress id="facturaProgressBar" value="0" max="100" 
                                          style="width:100%;height:22px;display:none;"></progress>
                                <div id="facturaResult" class="mt-3" style="white-space:pre-wrap; 
                                     background:#f7f7f7; border-radius:8px; padding:16px; min-height:80px;">
                                </div>
                                <div id="facturaGroupsContainer"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pesta√±a 2: Nuevo sistema -->
                    <!-- Pesta√±a 2: Facturas Especiales -->
                    <div class="tab-pane fade" id="facturasEspeciales">
                        <div class="card shadow-lg border-0 rounded-4">
                            <div class="card-body p-4">
                                <h3>Escanea tus Facturas para ser m√°s √°gil en el proceso</h3>
                                <div class="mb-3">
                                    <input type="file" id="fileInput" accept="application/pdf" 
                                           class="form-control" multiple>
                                </div>
                                <button onclick="processFiles()" class="btn btn-primary w-100 mb-3">
                                    Escanear PDFs
                                </button>
                                <button id="facturasEspecialesCacheClearBtn" class="btn btn-warning w-100 mb-3">
                                   <i class="bi bi-trash"></i> Limpiar Cach√©
                               </button>
                               <div class="input-group mb-3">
                                   <span class="input-group-text">
                                       <i class="bi bi-search"></i>
                                   </span>
                                   <input type="text" 
                                          class="form-control" 
                                          placeholder="Buscar escaneos guardados..." 
                                          oninput="cargarEscaneosGuardados(this.value)">
                               </div>
                                <button onclick="limpiarModales()" class="btn btn-warning" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: none;" id="btnLimpiarModales">
                                   Limpiar interfaz
                               </button>
                               <div id="log" class="alert alert-info mt-3" style="display:none;"></div>
                               <div id="extractedData"></div>
                               <div id="escaneosGuardados" class="mt-4"></div>
                          </div>
                     </div>
                </div> 

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Variables de datos
    let inventario = [];
    let flota = [];
    let pedidosApartados = [];
    let pedidosEnCurso = [];
    let pedidoCamion = null;
    let autoUpdateInterval;


    class CacheSystem {
    constructor(ttl = 300000) { // 5 minutos por defecto
        this.cache = new Map();
        this.ttl = ttl;
    }
    
    // ... resto del c√≥digo
}

// Funci√≥n para iniciar actualizaciones autom√°ticas
// Modificar el intervalo de actualizaci√≥n a 2 minutos en lugar de 30 segundos
function iniciarActualizacionesAutomaticas() {
    autoUpdateInterval = setInterval(async () => {
        const tabActiva = document.querySelector('.tablink.active')?.dataset.tab;
        if (!tabActiva) return;
        
        try {
            switch(tabActiva) {
                case 'inventario':
                    await fetchInventario();
                    break;
                case 'flota':
                    await fetchFlota();
                    break;
                case 'pedidos-Apartados':
                    await fetchPedidosApartados();
                    break;
                case 'facturas':
                    await actualizarBloquesFacturas();
                    break;
            }
        } catch (error) {
            console.error('Error en actualizaci√≥n autom√°tica:', error);
        }
    }, 120000); // 2 minutos
}

// Remover el c√≥digo duplicado de event listeners de tablinks
// Y mover este c√≥digo al final del archivo
document.addEventListener('DOMContentLoaded', () => {
    iniciarActualizacionesAutomaticas();
    
    // Restaurar funcionalidad de pesta√±as
    const tablinks = document.querySelectorAll('.tablink');
    tablinks.forEach(button => {
        button.addEventListener('click', () => {
            tablinks.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tabcontent').forEach(tc => tc.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
        });
    });
});
function mostrarEstado(mensaje, tipo = 'info') {
    console.log(mensaje);
    const statusDiv = document.createElement('div');
    statusDiv.textContent = mensaje;
    statusDiv.style.position = 'fixed';
    statusDiv.style.bottom = '20px';
    statusDiv.style.right = '20px';
    statusDiv.style.padding = '10px';
    statusDiv.style.backgroundColor = tipo === 'error' ? '#ffebee' : '#f0f4ff';
    statusDiv.style.border = '1px solid #ccc';
    statusDiv.style.borderRadius = '4px';
    statusDiv.style.zIndex = '1000';
    document.body.appendChild(statusDiv);
    setTimeout(() => statusDiv.remove(), 3000);
}
// Funciones utilitarias
function mostrarMensaje(mensaje, tipo = 'info') {
    const div = document.createElement('div');
    div.className = `alert alert-${tipo}`;
    div.textContent = mensaje;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

function validarDatos(obj, campos) {
    return campos.every(campo => {
        const valor = obj[campo];
        return valor !== undefined && valor !== null && valor !== '';
    });
}

// Helper: parsea valores que vienen de la hoja y devuelve n√∫mero seguro (0 si no es num√©rico)
function safeNum(v) {
    if (v === null || v === undefined) return 0;
    let s = String(v).trim();
    if (s === '') return 0;
        // Quita s√≠mbolo de moneda y espacios
        s = s.replace(/\$/g, '').replace(/\s+/g, '');
        // Si contiene ambos separadores, asumimos que las comas son separador de miles
        if (s.includes(',') && s.includes('.')) {
            s = s.replace(/,/g, '');
        } else if (s.includes(',') && !s.includes('.')) {
            // Probablemente usan coma como decimal
            s = s.replace(/,/g, '.');
        }
        // Elimina cualquier resto de comas
        s = s.replace(/,/g, '');
        const n = Number(s);
        return isNaN(n) ? 0 : n;
    }
    // Busca una propiedad entre varias alternativas comunes (tolerancia a nombres de columnas)
    function getField(obj, name) {
        if (!obj) return undefined;
        const keys = [name, name.toLowerCase(), name.toUpperCase(), name.charAt(0).toLowerCase() + name.slice(1)];
        // variantes comunes
        const variants = {
            volumen: ['volumen', 'Volumen', 'volumen (m3)', 'Volumen (m3)', 'volume'],
            peso: ['peso', 'Peso', 'weight', 'Weight'],
            valor: ['valor', 'Valor', 'precio', 'Precio', 'value']
        };
        const list = variants[name] || keys;
        for (const k of list) {
            if (k in obj) return obj[k];
        }
        // intenta buscar cualquier key que contenga el nombre
        for (const k of Object.keys(obj)) {
            if (k.toLowerCase().includes(name.toLowerCase())) return obj[k];
        }
        return undefined;
    }
async function buscarBloquePorFolio() {
    const folio = document.getElementById('inputFolioFacturaPedido').value.trim();
    const div = document.getElementById('bloqueBuscadoPedido');
    
    // Si no hay folio, limpiar el div y retornar
    if (!folio) {
        div.innerHTML = '';
        return;
    }
    
    try {
        // Buscar primero en bloquesFacturas
        const bloque = bloquesFacturas.find(b => 
            b.nombre === folio || (b.datos[0]?.Folio === folio)
        );

        // Buscar en la hoja "reservados"
        const resReservados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=reservados');
        const reservados = await resReservados.json();
        
        // Agrupar reservados por nombre
        const reservadosAgrupados = reservados.reduce((grupos, item) => {
            if (!grupos[item.nombre]) {
                grupos[item.nombre] = [];
            }
            grupos[item.nombre].push(item);
            return grupos;
        }, {});

        if (bloque) {
            div.innerHTML = `
                <div class="alert alert-success mt-2">
                    Bloque encontrado en facturas: ${bloque.nombre}<br>
                    Productos: ${bloque.datos.length}
                </div>
            `;
        } else if (reservadosAgrupados[folio]) {
            const reservadosEncontrados = reservadosAgrupados[folio];
            div.innerHTML = `
                <div class="alert alert-info mt-2">
                    Bloque encontrado en reservados: ${folio}<br>
                    Productos: ${reservadosEncontrados.length}<br>
                    <table class="table table-bordered mt-2">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Descripci√≥n</th>
                                <th>L√≠nea</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reservadosEncontrados.map(item => `
                                <tr>
                                    <td>${item.C√≥digo}</td>
                                    <td>${item.Descripci√≥n}</td>
                                    <td>${item.L√≠nea}</td>
                                    <td>${item.Cantidad}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else if (folio) { // Solo mostrar mensaje de no encontrado si se ingres√≥ un folio
            div.innerHTML = '<div class="alert alert-danger mt-2">No se encontr√≥ ning√∫n bloque con ese folio.</div>';
        }
    } catch (error) {
        console.error('Error al buscar:', error);
        if (folio) { // Solo mostrar error si se ingres√≥ un folio
            div.innerHTML = '<div class="alert alert-danger mt-2">Error al buscar el bloque.</div>';
        }
    }
}
// Agregar este evento para limpiar el mensaje cuando se borre el input
document.getElementById('inputFolioFacturaPedido').addEventListener('input', function() {
    if (!this.value.trim()) {
        document.getElementById('bloqueBuscadoPedido').innerHTML = '';
    }
});
// Pega aqu√≠:
async function agregarBloquePorFolioPedido(agregarMas = false) {
    const folio = document.getElementById('inputFolioFacturaPedido').value.trim().toLowerCase();
    if (!folio) {
        alert('Escribe un folio v√°lido.');
        return;
    }
    
    const bloquesPendientesDiv = document.getElementById('bloquesPendientes');

    try {
        console.log("Iniciando b√∫squeda para folio:", folio);
        const divResultado = document.getElementById('bloqueBuscadoPedido');
        let productosAgregados = false;

        // 1. Buscar primero en facturasParaGuardar (facturas reci√©n escaneadas)
        console.log("Buscando en facturas reci√©n escaneadas...", facturasParaGuardar);
        const facturasRecientes = facturasParaGuardar.filter(f => 
            f.Nombre?.toLowerCase() === folio ||
            f.Folio?.toLowerCase() === folio
        );

        if (facturasRecientes.length > 0) {
            console.log("Encontrado en facturas reci√©n escaneadas:", facturasRecientes);
            await procesarBloqueFacturas(facturasRecientes);
            productosAgregados = true;
        }

        // 2. Buscar en escaneados especiales
        console.log("Buscando en escaneados especiales...");
        const resEscaneados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales');
        const escaneados = await resEscaneados.json();
        
        const escaneadosDelFolio = escaneados.filter(r => 
            r.Nombre?.toLowerCase() === folio ||
            r.nombre?.toLowerCase() === folio
        );

        if (escaneadosDelFolio.length > 0) {
            console.log("Encontrado en escaneados especiales:", escaneadosDelFolio);
            await procesarBloqueFacturas(escaneadosDelFolio);
            productosAgregados = true;
        }

        // 3. Buscar en bloquesFacturas
        console.log("Buscando en bloques de facturas...");
        const bloquesFactura = bloquesFacturas.filter(b => 
            b.nombre.toLowerCase() === folio
        );

        if (bloquesFactura.length > 0) {
            console.log("Encontrado en bloques de facturas:", bloquesFactura);
            for (const bloque of bloquesFactura) {
                await procesarBloqueFacturas(bloque.datos);
            }
            productosAgregados = true;
        }

        // 4. Buscar en reservados como √∫ltima opci√≥n
        console.log("Buscando en reservados...");
        const resReservados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=reservados');
        const reservados = await resReservados.json();
        const reservadosDelFolio = reservados.filter(r => 
            r.nombre?.toLowerCase() === folio
        );
        
        if (reservadosDelFolio.length > 0) {
            console.log("Encontrado en reservados");
            await procesarBloqueReservados(reservadosDelFolio);
            productosAgregados = true;
        }

        // Mostrar resultado y actualizar interfaz
        if (productosAgregados) {
            if (agregarMas) {
                // Agregar a la lista de bloques pendientes
                const bloquePendiente = document.createElement('div');
                bloquePendiente.className = 'alert alert-info mt-2 d-flex justify-content-between align-items-center';
                bloquePendiente.innerHTML = `
                    <span>
                        <i class="bi bi-box"></i> 
                        Bloque "${folio}" agregado y combinado con el pedido
                    </span>
                `;
                bloquesPendientesDiv.appendChild(bloquePendiente);
                
                // Limpiar solo el input, mantener los productos agregados
                document.getElementById('inputFolioFacturaPedido').value = '';
                divResultado.innerHTML = `
                    <div class="alert alert-success mt-2">
                        <i class="bi bi-plus-circle"></i>
                        Bloque agregado. Puede seguir a√±adiendo m√°s bloques.
                    </div>`;
            } else {
                divResultado.innerHTML = `
                    <div class="alert alert-success mt-2">
                        <i class="bi bi-check-circle"></i>
                        Se agregaron los productos al pedido correctamente.
                    </div>`;
                document.getElementById('inputFolioFacturaPedido').value = '';
                bloquesPendientesDiv.innerHTML = ''; // Limpiar lista de pendientes
            }
            
            // Actualizar interfaz siempre
            renderPedidosActuales();
            actualizarGraficas();
        } else {
            console.log("No se encontr√≥ en ninguna fuente");
            divResultado.innerHTML = `
                <div class="alert alert-danger mt-2">
                    <i class="bi bi-exclamation-triangle"></i>
                    No se encontr√≥ ning√∫n bloque o factura con ese folio o nombre.
                </div>`;
        }

    } catch (error) {
        console.error('Error detallado:', error);
        document.getElementById('bloqueBuscadoPedido').innerHTML = `
            <div class="alert alert-danger mt-2">
                Error al procesar el bloque: ${error.message}
            </div>`;
    }
}

// Nueva funci√≥n para buscar y agregar bloques
async function buscarYAgregarBloque() {
    const folio = document.getElementById('inputBusquedaBloque').value.trim().toLowerCase();
    const resultadoDiv = document.getElementById('resultadoBusquedaBloque');
    
    if (!folio) {
        resultadoDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle"></i> Por favor, ingrese un folio v√°lido.
            </div>`;
        return;
    }

    try {
        resultadoDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-hourglass-split"></i> Buscando bloque...
            </div>`;

        let encontrado = false;
        let llantasEncontradas = [];

        // Buscar en todas las fuentes y extraer las llantas
        // 1. Buscar en facturas reci√©n escaneadas
        const facturasRecientes = facturasParaGuardar.filter(f => 
            f.Nombre?.toLowerCase() === folio ||
            f.Folio?.toLowerCase() === folio
        );
        if (facturasRecientes.length > 0) {
            llantasEncontradas = llantasEncontradas.concat(facturasRecientes);
            encontrado = true;
        }

        // 2. Buscar en escaneados especiales
        const resEscaneados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales');
        const escaneados = await resEscaneados.json();
        const escaneadosDelFolio = escaneados.filter(r => 
            r.Nombre?.toLowerCase() === folio ||
            r.nombre?.toLowerCase() === folio
        );
        if (escaneadosDelFolio.length > 0) {
            llantasEncontradas = llantasEncontradas.concat(escaneadosDelFolio);
            encontrado = true;
        }

        // 3. Buscar en bloques de facturas
        const bloquesFactura = bloquesFacturas.filter(b => 
            b.nombre.toLowerCase() === folio
        );
        if (bloquesFactura.length > 0) {
            llantasEncontradas = llantasEncontradas.concat(bloquesFactura[0].datos || []);
            encontrado = true;
        }

        // 4. Buscar en reservados
        const resReservados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=reservados');
        const reservados = await resReservados.json();
        const reservadosDelFolio = reservados.filter(r => 
            r.nombre?.toLowerCase() === folio
        );
        if (reservadosDelFolio.length > 0) {
            llantasEncontradas = llantasEncontradas.concat(reservadosDelFolio);
            encontrado = true;
        }

        if (encontrado) {
            // Actualizar la tabla de Llantas en el Bloque
            actualizarTablaLlantasBloque(llantasEncontradas);
            resultadoDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Se encontraron ${llantasEncontradas.length} llantas en el bloque.
                </div>`;
        } else {
            resultadoDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> No se encontr√≥ ning√∫n bloque con el folio "${folio}".
                </div>`;
        }

    } catch (error) {
        console.error('Error en la b√∫squeda:', error);
        resultadoDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error al buscar el bloque: ${error.message}
            </div>`;
    }
}

function mostrarResultadoBloque(resultadoDiv, folio, tipo, datos) {
    const cantidadItems = Array.isArray(datos) ? datos.length : (datos.datos ? datos.datos.length : 0);
    
    resultadoDiv.innerHTML += `
        <div class="alert alert-success mt-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-box"></i> 
                    Bloque encontrado en ${tipo} (${cantidadItems} items)
                </div>
                <button class="btn btn-sm btn-outline-success" onclick="agregarBloqueEncontrado('${folio}', '${tipo}')">
                    <i class="bi bi-plus-circle"></i> Agregar al pedido
                </button>
            </div>
        </div>`;
}

// Funciones para el nuevo buscador de bloques
async function buscarBloqueEnModo() {
    const folio = document.getElementById('inputBusquedaBloqueNuevo').value.trim().toLowerCase();
    const divResultado = document.getElementById('resultadoBusquedaBloqueNuevo');
    
    if (!folio) {
        divResultado.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle"></i> Por favor, ingrese un folio v√°lido.
            </div>`;
        return;
    }

    try {
        divResultado.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-hourglass-split"></i> Buscando bloque...
            </div>`;

        let encontrado = false;

        // 1. Buscar en facturas reci√©n escaneadas
        const facturasRecientes = facturasParaGuardar.filter(f => 
            f.Nombre?.toLowerCase() === folio ||
            f.Folio?.toLowerCase() === folio
        );
        if (facturasRecientes.length > 0) {
            mostrarResultadoBloqueModo(divResultado, folio, 'facturas recientes', facturasRecientes);
            encontrado = true;
        }

        // 2. Buscar en escaneados especiales
        const resEscaneados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales');
        const escaneados = await resEscaneados.json();
        const escaneadosDelFolio = escaneados.filter(r => 
            r.Nombre?.toLowerCase() === folio ||
            r.nombre?.toLowerCase() === folio
        );
        if (escaneadosDelFolio.length > 0) {
            mostrarResultadoBloqueModo(divResultado, folio, 'escaneados especiales', escaneadosDelFolio);
            encontrado = true;
        }

        // 3. Buscar en bloques de facturas
        const bloquesFactura = bloquesFacturas.filter(b => 
            b.nombre.toLowerCase() === folio
        );
        if (bloquesFactura.length > 0) {
            mostrarResultadoBloqueModo(divResultado, folio, 'bloques de facturas', bloquesFactura);
            encontrado = true;
        }

        if (!encontrado) {
            divResultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> No se encontr√≥ ning√∫n bloque con el folio "${folio}".
                </div>`;
        }

    } catch (error) {
        console.error('Error en la b√∫squeda:', error);
        divResultado.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error al buscar el bloque: ${error.message}
            </div>`;
    }
}

function mostrarResultadoBloqueModo(divResultado, folio, tipo, datos) {
    const cantidadItems = Array.isArray(datos) ? datos.length : (datos.datos ? datos.datos.length : 0);
    
    divResultado.innerHTML = `
        <div class="alert alert-success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-box"></i> 
                    Bloque encontrado en ${tipo} (${cantidadItems} items)
                </div>
                <button class="btn btn-sm btn-outline-success" onclick="agregarBloqueEnModo()">
                    <i class="bi bi-plus-circle"></i> Agregar al bloque
                </button>
            </div>
        </div>`;
}

// Funci√≥n para obtener los datos de la flota
function obtenerDatosFlota() {
    const tablaFlota = document.querySelector('#flota table tbody');
    if (!tablaFlota) return [];
    
    // Obtener el volumen y peso total del bloque actual
    const volumenTotal = parseFloat(document.getElementById('totalVolumenLlantas').textContent) || 0;
    const pesoTotal = parseFloat(document.getElementById('totalPesoLlantas').textContent) || 0;
    
    return Array.from(tablaFlota.rows)
        .map(row => {
            // Extraer los valores y limpiarlos
            const volumenStr = row.cells[7].textContent.trim();
            const pesoStr = row.cells[6].textContent.trim();
            
            // Convertir y validar los valores
            const capacidadVolumen = parseFloat(volumenStr) || 0;
            const capacidadPeso = parseFloat(pesoStr) || 0;
            
            // Calcular uso de volumen y peso
            const usoVolumen = (volumenTotal / capacidadVolumen) * 100;
            const usoPeso = (pesoTotal / capacidadPeso) * 100;
            
            return {
                nombre: row.cells[1].textContent.trim(), // columna 'unidad'
                economico: row.cells[0].textContent.trim(), // columna 'economico'
                capacidadVolumen: capacidadVolumen,
                capacidadPeso: capacidadPeso,
                usoVolumen: usoVolumen,
                usoPeso: usoPeso,
                puedeTransportar: capacidadVolumen > 0 && capacidadPeso > 0 && usoVolumen <= 100 && usoPeso <= 100
            };
        })
        .filter(unidad => unidad.puedeTransportar); // Solo retornar unidades que pueden transportar la carga
}

// Funci√≥n para apartar una unidad
async function apartarUnidad(economico) {
    // Verificar si hay llantas en el bloque
    const tablaLlantas = document.getElementById('tablaLlantasBloque');
    if (!tablaLlantas) {
        console.error('No se encontr√≥ la tabla de llantas');
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al acceder a las llantas del pedido'
        });
        return;
    }

    // Verificar si hay filas en la tabla (excluyendo encabezados y pie de tabla)
    const filas = Array.from(tablaLlantas.rows);
    if (filas.length === 0) {
        console.error('La tabla de llantas est√° vac√≠a');
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se han agregado llantas al pedido'
        });
        return;
    }

    // Verificar que haya datos v√°lidos en las filas
    const llantasValidas = filas.some(row => 
        row.cells.length >= 4 && 
        row.cells[3].textContent && 
        parseInt(row.cells[3].textContent) > 0
    );

    if (!llantasValidas) {
        console.error('No se encontraron llantas v√°lidas en la tabla');
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No hay llantas v√°lidas en el pedido'
        });
        return;
    }

    // Obtener los datos de la unidad seleccionada
    const unidad = obtenerDatosFlota().find(u => u.economico === economico);
    
    if (!unidad) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se encontr√≥ la unidad seleccionada'
        });
        return;
    }

    // Verificar totales antes de continuar
    const totalVolumen = parseFloat(document.getElementById('totalVolumenLlantas').textContent) || 0;
    const totalPeso = parseFloat(document.getElementById('totalPesoLlantas').textContent) || 0;
    
    if (totalVolumen === 0 || totalPeso === 0) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Los totales de volumen y peso no son v√°lidos'
        });
        return;
    }

    // Solicitar el nombre primero
    const nombreResult = await Swal.fire({
        title: 'Nombre del responsable',
        input: 'text',
        inputLabel: 'Por favor, ingrese el nombre de quien hace el pedido',
        inputPlaceholder: 'Nombre completo',
        showCancelButton: true,
        confirmButtonText: 'Continuar',
        cancelButtonText: 'Cancelar',
        inputValidator: (value) => {
            if (!value) {
                return 'Debe ingresar un nombre';
            }
        }
    });

    if (!nombreResult.isConfirmed || !nombreResult.value) {
        return;
    }

    const nombrePedido = nombreResult.value;

    // Confirmar la operaci√≥n
    const result = await Swal.fire({
        icon: 'question',
        title: '¬øApartar unidad?',
        text: `¬øDesea apartar la unidad ${unidad.nombre} (${unidad.economico}) para este pedido?`,
        html: `
            <p>Responsable: <strong>${nombrePedido}</strong></p>
            <p>Unidad: <strong>${unidad.nombre} (${unidad.economico})</strong></p>
        `,
        showCancelButton: true,
        confirmButtonText: 'S√≠, apartar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            // Recopilar las llantas del bloque
            const llantas = Array.from(tablaLlantas.rows)
                .filter(row => row.cells.length >= 7) // Asegurarse de que la fila tiene todas las columnas necesarias
                .map(row => {
                    try {
                        return {
                            codigo: row.cells[0].textContent.trim(),
                            descripcion: row.cells[1].textContent.trim(),
                            linea: row.cells[2].textContent.trim(),
                            cantidad: parseInt(row.cells[3].textContent) || 0,
                            volumen: parseFloat(row.cells[4].textContent) || 0,
                            peso: parseFloat(row.cells[5].textContent) || 0,
                            valor: parseFloat(row.cells[6].textContent.replace(/[^0-9.-]+/g, '')) || 0
                        };
                    } catch (error) {
                        console.error('Error al procesar fila:', error);
                        return null;
                    }
                })
                .filter(llanta => llanta && llanta.cantidad > 0); // Filtrar llantas nulas o con cantidad 0
                
            if (llantas.length === 0) {
                throw new Error('No se encontraron llantas v√°lidas para procesar');
            }

            // Recopilar informaci√≥n del pedido
            const fecha = new Date().toLocaleString('es-MX', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Procesar las llantas para obtener totales y descripciones
            const totalLlantas = llantas.reduce((total, l) => total + l.cantidad, 0);
            const descripcionesLlantas = llantas.map(l => `${l.cantidad}x ${l.descripcion}`).join(', ');
            const volumenTotal = llantas.reduce((total, l) => total + l.volumen, 0);
            const pesoTotal = llantas.reduce((total, l) => total + l.peso, 0);

            // Preparar los datos para enviar a SheetDB
            const datosParaEnviar = {
                data: [{
                    "Fecha": fecha,
                    "Unidad": unidad.nombre || "",
                    "Econ√≥mico": unidad.economico || "",
                    "Nombre": nombrePedido,
                    "Llantas": totalLlantas.toString(),
                    "Descripcion": descripcionesLlantas,
                    "Volumen": volumenTotal.toFixed(2),
                    "Peso": pesoTotal.toFixed(2)
                }]
            };

            // Enviar a SheetDB
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosParaEnviar)
            });

            if (!response.ok) {
                throw new Error('Error al guardar en Apartados');
            }

            // Actualizar la vista de pedidos Apartados
            await fetchPedidosApartados();

            // Limpiar el bloque actual
            tablaLlantas.innerHTML = '';
            document.getElementById('totalVolumenLlantas').textContent = '0';
            document.getElementById('totalPesoLlantas').textContent = '0';
            document.getElementById('totalValorLlantas').textContent = '$0';
            document.getElementById('totalCantidadLlantas').textContent = '0';

            // Actualizar las unidades disponibles
            actualizarUnidadesDisponibles();

            // Mostrar mensaje de √©xito
            Swal.fire({
                icon: 'success',
                title: 'Pedido apartado',
                text: `Las llantas han sido apartadas exitosamente para la unidad ${unidad.nombre} (${unidad.economico})`
            });

        } catch (error) {
            console.error('Error al apartar:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ocurri√≥ un error al apartar las llantas'
            });
        }
    }
}

// Funci√≥n para actualizar la tabla de unidades disponibles
async function actualizarUnidadesDisponibles() {
    const tablaUnidades = document.getElementById('tablaUnidadesDisponibles');
    const datosFlota = obtenerDatosFlota(); // Funci√≥n que obtiene los datos de la pesta√±a de flota
    
    tablaUnidades.innerHTML = '';
    
    if (datosFlota.length === 0) {
        // Si no hay unidades disponibles, mostrar mensaje
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td colspan="8" class="text-center">
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    No hay unidades disponibles que puedan transportar esta carga
                </div>
            </td>
        `;
        tablaUnidades.appendChild(fila);
        return;
    }
    
    datosFlota.forEach(unidad => {
        const eficiencia = (unidad.usoVolumen + unidad.usoPeso) / 2;
        
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>${unidad.nombre}</td>
            <td>${unidad.economico}</td>
            <td>${unidad.capacidadVolumen.toFixed(2)} m¬≥</td>
            <td>${unidad.capacidadPeso.toFixed(2)} kg</td>
            <td>
                <div class="progress">
                    <div class="progress-bar bg-success" 
                         role="progressbar" 
                         style="width: ${unidad.usoVolumen}%">
                        ${unidad.usoVolumen.toFixed(1)}%
                    </div>
                </div>
            </td>
            <td>
                <div class="progress">
                    <div class="progress-bar bg-success" 
                         role="progressbar" 
                         style="width: ${unidad.usoPeso}%">
                        ${unidad.usoPeso.toFixed(1)}%
                    </div>
                </div>
            </td>
            <td>${eficiencia.toFixed(1)}%</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="apartarUnidad('${unidad.economico}')">
                    <i class="bi bi-truck"></i> Apartar
                </button>
            </td>
        `;
        tablaUnidades.appendChild(fila);
    });
}

async function agregarBloqueEnModo(continuarAgregando = false) {
    const folio = document.getElementById('inputBusquedaBloqueNuevo').value.trim().toLowerCase();
    const divResultado = document.getElementById('resultadoBusquedaBloqueNuevo');
    const bloquesPendientesDiv = document.getElementById('bloquesPendientesNuevoModo');
    
    if (!folio) {
        divResultado.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle"></i> Por favor, ingrese un folio v√°lido.
            </div>`;
        return;
    }

    try {
        let llantasParaAgregar = [];
        
        // Buscar en todas las fuentes y recolectar las llantas
        const facturasRecientes = facturasParaGuardar.filter(f => 
            f.Nombre?.toLowerCase() === folio ||
            f.Folio?.toLowerCase() === folio
        );
        if (facturasRecientes.length > 0) {
            llantasParaAgregar = llantasParaAgregar.concat(facturasRecientes);
        }

        const resEscaneados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales');
        const escaneados = await resEscaneados.json();
        const escaneadosDelFolio = escaneados.filter(r => 
            r.Nombre?.toLowerCase() === folio ||
            r.nombre?.toLowerCase() === folio
        );
        if (escaneadosDelFolio.length > 0) {
            llantasParaAgregar = llantasParaAgregar.concat(escaneadosDelFolio);
        }

        const bloquesFactura = bloquesFacturas.filter(b => 
            b.nombre.toLowerCase() === folio
        );
        if (bloquesFactura.length > 0) {
            llantasParaAgregar = llantasParaAgregar.concat(bloquesFactura[0].datos || []);
        }

        if (llantasParaAgregar.length > 0) {
            actualizarTablaLlantasBloque(llantasParaAgregar);
            
            if (continuarAgregando) {
                // Agregar al √°rea de bloques pendientes
                const bloquePendiente = document.createElement('div');
                bloquePendiente.className = 'alert alert-info mt-2 d-flex justify-content-between align-items-center';
                bloquePendiente.innerHTML = `
                    <span>
                        <i class="bi bi-box"></i> 
                        Bloque "${folio}" agregado (${llantasParaAgregar.length} llantas)
                    </span>
                `;
                bloquesPendientesDiv.appendChild(bloquePendiente);
                
                // Limpiar solo el input, mantener la tabla actualizada
                document.getElementById('inputBusquedaBloqueNuevo').value = '';
                divResultado.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-plus-circle"></i>
                        Bloque agregado. Puede seguir a√±adiendo m√°s bloques.
                    </div>`;
            } else {
                // Finalizar la combinaci√≥n
                document.getElementById('inputBusquedaBloqueNuevo').value = '';
                bloquesPendientesDiv.innerHTML = '';
                divResultado.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> 
                        Se agregaron ${llantasParaAgregar.length} llantas al bloque y se finaliz√≥ la combinaci√≥n.
                    </div>`;
            }
        } else {
            divResultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> No se encontraron llantas para agregar.
                </div>`;
        }

    } catch (error) {
        console.error('Error al agregar el bloque:', error);
        divResultado.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error al agregar el bloque: ${error.message}
            </div>`;
    }
}

function limpiarBusquedaBloqueEnModo() {
    document.getElementById('inputBusquedaBloqueNuevo').value = '';
    document.getElementById('resultadoBusquedaBloqueNuevo').innerHTML = '';
    document.getElementById('bloquesPendientesNuevo').innerHTML = '';
    actualizarTablaLlantasBloque([]);
}

function eliminarLlantaBloque(codigo) {
    // Confirmar antes de eliminar
    if (confirm('¬øEst√° seguro de eliminar esta llanta del bloque?')) {
        const tablaLlantas = document.getElementById('tablaLlantasBloque');
        const filas = tablaLlantas.getElementsByTagName('tr');
        
        // Crear un nuevo array sin la llanta eliminada
        const llantasActualizadas = [];
        for (let fila of filas) {
            const codigoFila = fila.cells[0].textContent;
            if (codigoFila !== codigo) {
                llantasActualizadas.push({
                    ID: codigoFila,
                    Descripcion: fila.cells[1].textContent,
                    Linea: fila.cells[2].textContent,
                    Cantidad: parseInt(fila.cells[3].textContent),
                    Volumen: parseFloat(fila.cells[4].textContent),
                    Peso: parseFloat(fila.cells[5].textContent),
                    Valor: parseFloat(fila.cells[6].textContent.replace('$', ''))
                });
            }
        }
        
        // Actualizar la tabla
        actualizarTablaLlantasBloque(llantasActualizadas);
    }
}

function actualizarTablaLlantasBloque(llantas) {
    const tablaLlantas = document.getElementById('tablaLlantasBloque');
    
    // Actualizar la tabla de unidades disponibles despu√©s de actualizar el bloque
    setTimeout(() => actualizarUnidadesDisponibles(), 100); // Peque√±o retraso para asegurar que los totales est√©n actualizados
    if (!tablaLlantas) {
        console.error('No se encontr√≥ la tabla de llantas');
        return;
    }

    // Limpiar la tabla actual
    tablaLlantas.innerHTML = '';

    // Variables para totales
    let totalCantidad = 0;
    let totalVolumen = 0;
    let totalPeso = 0;
    let totalValor = 0;

    // Agrupar llantas por c√≥digo
    const llantasAgrupadas = {};
    llantas.forEach(llanta => {
        // Obtener los datos correctos de la estructura de Facturas
        const codigo = llanta.C√≥digo || llanta.codigo || 'Sin c√≥digo';
        const descripcion = llanta.Descripci√≥n || llanta.descripcion || 'Sin descripci√≥n';
        
        // Buscar la informaci√≥n de la llanta en el inventario para obtener m√°s detalles
        const llantaInventario = inventario.find(item => item.ID === codigo) || {};
        
        const linea = llantaInventario.Linea || llanta.Linea || 'OFEMD'; // Default a OFEMD si no hay l√≠nea
        const cantidad = parseInt(llanta.Cantidad || llanta.cantidad || 1);
        
        // Obtener volumen y peso del inventario si est√° disponible
        const volumenUnitario = parseFloat(llantaInventario.Volumen || 0.06); // Valor por defecto si no existe
        const pesoUnitario = parseFloat(llantaInventario.Peso || 30); // Valor por defecto si no existe
        const valorUnitario = parseFloat(llantaInventario.Valor || llanta.Valor || 0);

        const volumen = volumenUnitario * cantidad;
        const peso = pesoUnitario * cantidad;
        const valor = valorUnitario * cantidad;

        // Usar el c√≥digo como clave √∫nica
        if (!llantasAgrupadas[codigo]) {
            llantasAgrupadas[codigo] = {
                codigo: codigo,
                descripcion: descripcion,
                linea: linea,
                cantidad: 0,
                volTotal: 0,
                pesoTotal: 0,
                valorTotal: 0
            };
        }
        
        // Acumular cantidades y totales
        llantasAgrupadas[codigo].cantidad += cantidad;
        llantasAgrupadas[codigo].volTotal += volumen;
        llantasAgrupadas[codigo].pesoTotal += peso;
        llantasAgrupadas[codigo].valorTotal += valor;

        // Actualizar totales generales
        totalCantidad += cantidad;
        totalVolumen += volumen;
        totalPeso += peso;
        totalValor += valor;
    });

    // Agregar filas a la tabla
    Object.values(llantasAgrupadas).forEach(datos => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>${datos.codigo}</td>
            <td>${datos.descripcion}</td>
            <td>${datos.linea}</td>
            <td style="text-align: center;">${datos.cantidad}</td>
            <td style="text-align: right;">${datos.volTotal.toFixed(3)}</td>
            <td style="text-align: right;">${datos.pesoTotal.toFixed(3)}</td>
            <td style="text-align: right;">$${datos.valorTotal.toFixed(2)}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-danger" onclick="eliminarLlantaBloque('${datos.codigo}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tablaLlantas.appendChild(fila);
    });

    // Actualizar totales en el pie de la tabla
    document.getElementById('totalCantidadLlantas').textContent = totalCantidad;
    document.getElementById('totalVolumenLlantas').textContent = totalVolumen.toFixed(3);
    document.getElementById('totalPesoLlantas').textContent = totalPeso.toFixed(3);
    document.getElementById('totalValorLlantas').textContent = `$${totalValor.toFixed(2)}`;
    
    // Actualizar el contador en el encabezado del acorde√≥n
    document.getElementById('contadorLlantasBloque').textContent = 
        Object.keys(llantasAgrupadas).length > 0 ? `${Object.keys(llantasAgrupadas).length} tipos` : '0';
}


// Funciones auxiliares para procesar cada tipo de bloque
async function procesarBloqueFacturas(datos) {
    let seAgregaron = false;
    
    for (const producto of datos) {
        const llanta = inventario.find(item => item.clave?.toString() === producto.C√≥digo?.toString());
        if (llanta) {
            const cantidad = Number(producto.Cantidad) || 1;
            
            let pedidoExistente = pedidosEnCurso.find(p => p.clave === llanta.clave);
            if (pedidoExistente) {
                // Actualizar cantidad existente
                pedidoExistente.cantidad += cantidad;
                pedidoExistente.peso = safeNum(getField(llanta,'peso')) * pedidoExistente.cantidad;
                pedidoExistente.volumen = safeNum(getField(llanta,'volumen')) * pedidoExistente.cantidad;
                pedidoExistente.valor = safeNum(getField(llanta,'valor')) * pedidoExistente.cantidad;
            } else {
                // Agregar nueva llanta al pedido
                pedidosEnCurso.push({
                    clave: llanta.clave,
                    descripcion: llanta.descripcion,
                    linea: llanta.linea || '',
                    cantidad: cantidad,
                    peso: safeNum(getField(llanta,'peso')) * cantidad,
                    volumen: safeNum(getField(llanta,'volumen')) * cantidad,
                    valor: safeNum(getField(llanta,'valor')) * cantidad
                });
            }
        }
    }
    renderPedidosActuales();
    actualizarGraficas();
}

    // Modal Management Functions
    const modalManager = {
        open: function(id) {
            document.getElementById(id).style.display = 'block';
        },
        close: function(id) {
            document.getElementById(id).style.display = 'none';
        },
        cleanup: function() {
            // Remove backdrops
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            
            // Reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // Close active modals
            document.querySelectorAll('.modal.show').forEach(modal => {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) bootstrapModal.hide();
                modal.remove();
            });
        }
    };

    // Modal event handlers
    const openModal = modalManager.open;
    const closeModal = modalManager.close;
    const limpiarModales = modalManager.cleanup;

    // Click outside modal handler
    window.addEventListener('click', (event) => {
        ['modalInventario', 'modalFlota'].forEach(id => {
            const modal = document.getElementById(id);
            if (event.target === modal) modal.style.display = 'none';
        });
    });

    // ---------- Funciones para cargar datos ---------
    async function fetchInventario() {
        try {
            const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o');
            if (!res.ok) throw new Error('Error al cargar inventario');
            inventario = await res.json();
            renderInventario();
            // Cargar las descripciones en el select despu√©s de actualizar el inventario
            cargarDescripcionesLlantas();
        } catch (e) {
            alert('No se pudo cargar el inventario: ' + e.message);
        }
    }
    async function fetchFlota() {
        try {
            const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=flota');
            if (!res.ok) throw new Error('Error al cargar flota');
            flota = await res.json();
            renderFlota();
        } catch (e) {
            alert('No se pudo cargar la flota: ' + e.message);
        }
    }
    fetchInventario();
    fetchFlota();

    // Funci√≥n para cargar pedidos Apartados desde hoja
    async function fetchPedidosApartados() {
        try {
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados');
            if (!response.ok) {
                throw new Error(`Error al cargar pedidos Apartados: ${response.status}`);
            }
            const data = await response.json();
            console.log('Datos recibidos de SheetDB:', data);
            
            // Normalizar los datos manteniendo la estructura original
            pedidosApartados = data.map(pedido => ({
                ...pedido,
                'Econ√≥mico': pedido['Econ√≥mico'] || pedido['Economico'] || pedido['economico'] || '', // Mantener la versi√≥n con tilde
                'Unidad': pedido['Unidad'] || pedido['unidad'] || 'KENWORTH', // Asegurar que siempre haya un valor
                'Fecha': pedido['Fecha'] || '',
                'Nombre': pedido['Nombre'] || '',
                'Llantas': pedido['Llantas'] || '',
                'Descripcion': pedido['Descripcion'] || '',
                'Volumen': pedido['Volumen'] || '',
                'Peso': pedido['Peso'] || ''
            }));
            console.log('Datos normalizados:', pedidosApartados);
            actualizarTablaPedidosApartados();
        } catch (e) {
            alert('No se pudieron cargar los pedidos Apartados: ' + e.message);
        }
    }
    async function cargarReservas() {
    try {
        const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=reservados');
        if (!res.ok) throw new Error('Error al cargar reservas');
        const reservas = await res.json();
        return reservas;
    } catch (error) {
        console.error('Error al cargar reservas:', error);
        return [];
    }
}

    // ----- Cambiar pesta√±as -----
    const tablinks = document.querySelectorAll('.tablink');
    const tabcontents = document.querySelectorAll('.tabcontent');
    tablinks.forEach(button => {
        button.addEventListener('click', () => {
            tablinks.forEach(btn => btn.classList.remove('active'));
            tabcontents.forEach(tc => tc.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
            if (button.dataset.tab === 'inventario') renderInventario();
            if (button.dataset.tab === 'flota') renderFlota();
            if (button.dataset.tab === 'pedidos') resetPedidoInputs();
            if (button.dataset.tab === 'pedidos-Apartados') fetchPedidosApartados();
        });
    });
    // (Se elimin√≥ la definici√≥n duplicada de agregarBloquePorFolioPedido)
// ...existing code...
function renderInventario() {
    const tbody = document.querySelector('#tablaInventario tbody');
    tbody.innerHTML = '';
    inventario.forEach(llanta => {
        const tr = document.createElement('tr');
        // Si volumenGrande est√° marcado o volumen > 2, fondo azul claro
        if (llanta.volumenGrande || (safeNum(llanta.volumen) > 2)) {
            tr.style.background = '#cce6ff';
        }
        const pesoMostrar = (() => {
            const v = getField(llanta, 'peso');
            const n = safeNum(v);
            return (v === undefined || v === null || String(v).trim() === '') ? '-' : n.toFixed(3);
        })();
        const volumenMostrar = (() => {
            const v = getField(llanta, 'volumen');
            const n = safeNum(v);
            return (v === undefined || v === null || String(v).trim() === '') ? '-' : n.toFixed(3);
        })();
        const valorMostrar = (() => {
            const v = getField(llanta, 'valor');
            const n = safeNum(v);
            return (v === undefined || v === null || String(v).trim() === '') ? '-' : '$' + n.toFixed(2);
        })();

        tr.innerHTML = `
            <td>${llanta.clave}</td>
            <td>${llanta.descripcion}</td>
            <td>${llanta.linea || ''}</td>
            <td>${pesoMostrar}</td>
            <td>${volumenMostrar}</td>
            <td>${valorMostrar}</td>
            <td>
                <button onclick="editarLlanta('${llanta.clave}')">Editar</button>
                <button onclick="eliminarLlanta('${llanta.clave}')">Eliminar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    highlightSearch('inventario', document.getElementById('searchInventario').value);
}
async function calcularPesosInventario() {
    let filasActualizadas = [];
    let noCalculadas = [];
    let filasFallidas = [];

    try {
        mostrarEstado('Iniciando c√°lculos de peso...');
        
        for (const llanta of inventario) {
            if (!llanta.peso || Number(llanta.peso) === 0) {
                let desc = (llanta.descripcion || '').replace(/[()]/g, '').toUpperCase();
                let peso = 0;

                // Patrones de medidas espec√≠ficos para diferentes tipos
                const patrones = [
                    // 1. Llantas de cami√≥n pesado
                    {
                        regex: /(\d{3})\/(\d{2})R(\d{2}\.?\d*)/i,
                        calc: (m) => {
                            const ancho = Number(m[1]);
                            const perfil = Number(m[2]);
                            const rin = Number(m[3]);
                            return (ancho * perfil/100 * rin/25.4) * 0.45;
                        },
                        tipo: 'CAMION'
                    },

                    // 2. Llantas agr√≠colas
                    {
                        regex: /^(\d+\.?\d*)[-\/](\d+)[-\/]?(\d+)/i,
                        calc: (m) => {
                            const ancho = Number(m[1]);
                            const rin = Number(m[3]);
                            // Factor de peso m√°s alto para agr√≠colas
                            return ancho * rin * 0.8;
                        },
                        tipo: 'AGRICOLA'
                    },

                    // 3. Llantas industriales/OTR
                    {
                        regex: /(\d+\.?\d*)L-(\d+)\s*(?:\((\d{1,2})\))?/i,
                        calc: (m) => {
                            const ancho = Number(m[1]);
                            const rin = Number(m[2]);
                            const capas = m[3] ? Number(m[3]) : 12;
                            // Factor base m√°s ajuste por capas
                            return ancho * rin * 0.9 * (1 + (capas-8)*0.1);
                        },
                        tipo: 'INDUSTRIAL'
                    },

                    // 4. Llantas de auto/SUV
                    {
                        regex: /(\d{3})\/(\d{2})[R]?(\d{2})/i,
                        calc: (m) => {
                            const ancho = Number(m[1]);
                            const perfil = Number(m[2]);
                            const rin = Number(m[3]);
                            return (ancho * perfil/100 * rin/25.4) * 0.2;
                        },
                        tipo: 'AUTO'
                    }
                ];

                // Factores de ajuste espec√≠ficos
                const factoresAjuste = {
                    'XL': 1.15,    // Extra Load
                    'RF': 1.20,    // Reinforced
                    'PR': 1.10,    // Ply Rating base
                    'SKS': 1.30,   // Super resistentes
                    'L5': 1.40,    // L5 extra profundo
                    'SOLID': 2.0   // Macizas
                };

                // Determinar tipo base por descripci√≥n
                let tipoBase = '';
                if (desc.match(/AGRICOLA|TRACTOR|R-1/)) tipoBase = 'AGRICOLA';
                else if (desc.match(/OTR|INDUSTRIAL|L-[2-5]|SKS/)) tipoBase = 'INDUSTRIAL';
                else if (desc.match(/CAMION|295|315|385/)) tipoBase = 'CAMION';
                else if (desc.match(/4X4|SUV|LT|PICKUP/)) tipoBase = 'SUV';
                else tipoBase = 'AUTO';

                // Buscar patr√≥n coincidente
                let pesoBase = 0;
                for (const patron of patrones) {
                    const match = desc.match(patron.regex);
                    if (match) {
                        pesoBase = patron.calc(match);
                        break;
                    }
                }

                // Aplicar factores de ajuste
                let factorTotal = 1.0;
                for (const [clave, factor] of Object.entries(factoresAjuste)) {
                    if (desc.includes(clave)) factorTotal *= factor;
                }

                // Ajustes adicionales por n√∫mero de capas
                const capasMatch = desc.match(/\((\d{1,2})\)/);
                if (capasMatch) {
                    const capas = Number(capasMatch[1]);
                    if (capas > 8) factorTotal *= (1 + (capas-8)*0.05);
                }

                // Ajustes por material/construcci√≥n
                if (desc.includes('STEEL')) factorTotal *= 1.15;
                if (desc.includes('RADIAL')) factorTotal *= 1.1;
                if (desc.includes('NYLON')) factorTotal *= 0.9;

                // C√°lculo final del peso
                peso = pesoBase * factorTotal;

                // Redondeo y validaci√≥n final
                if (peso > 0) {
                    peso = Math.round(peso * 100) / 100; // Redondeo a 2 decimales

                    try {
                        const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/clave/${llanta.clave}`, {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ data: { peso: peso } })
                        });

                        if (!res.ok) throw new Error('Error en PATCH');
                        llanta.peso = peso;
                        filasActualizadas.push({
                            clave: llanta.clave,
                            peso: peso,
                            tipo: tipoBase
                        });
                    } catch (err) {
                        filasFallidas.push({
                            clave: llanta.clave,
                            descripcion: desc,
                            error: err.message
                        });
                    }
                } else {
                    noCalculadas.push({
                        clave: llanta.clave,
                        descripcion: desc
                    });
                }
            }
        }

        renderInventario();
        mostrarResultadosCalculo(noCalculadas, filasActualizadas, filasFallidas);

    } catch (error) {
        console.error('Error en c√°lculos:', error);
        mostrarEstado(`Error: ${error.message}`, 'error');
    }
}
// ...existing code...

   async function eliminarLlanta(clave) {
     if (!confirm('¬øSeguro que deseas eliminar esta llanta?')) return;
     try {
       const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/clave/${clave}`, {
         method: 'DELETE'
      });
      if (!res.ok) throw new Error('No se pudo eliminar');
      inventario = inventario.filter(item => item.clave !== clave);
      renderInventario();
      alert('Llanta eliminada correctamente.');
    } catch (error) {
      alert('Error al eliminar: ' + error.message);
    }
  }
  function editarLlanta(clave) {
  const llanta = inventario.find(item => item.clave === clave);
  // Muestra el modal con los datos actuales
  document.getElementById('modalInventario').innerHTML = `
    <div class="modal-content">
      <h3>Editar Llanta</h3>
      <label>Descripci√≥n: <input id="editDescripcion" value="${llanta.descripcion}" /></label><br>
      <label>L√≠nea: <input id="editLinea" value="${llanta.linea}" /></label><br>
      <label>Peso: <input id="editPeso" type="number" step="0.0001" value="${llanta.peso}" /></label><br>
      <label>Volumen: <input id="editVolumen" type="number" step="0.0001" value="${llanta.volumen}" /></label><br>
      <label>Valor: <input id="editValor" type="number" step="0.0001" value="${llanta.valor}" /></label><br>
      <button onclick="guardarEdicionLlanta('${llanta.clave}')">Guardar</button>
      <button onclick="closeModal('modalInventario')">Cancelar</button>
    </div>
  `;
  openModal('modalInventario');
}
// --- PEGA AQU√ç ---
async function guardarEdicionLlanta(clave) {
    const nuevosDatos = {
        descripcion: document.getElementById('editDescripcion').value,
        linea: document.getElementById('editLinea').value,
        peso: document.getElementById('editPeso').value,
        volumen: document.getElementById('editVolumen').value,
        valor: document.getElementById('editValor').value
    };

    try {
        const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/clave/${clave}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: nuevosDatos })
        });
        if (!res.ok) throw new Error('No se pudo editar');
        
        const llanta = inventario.find(item => item.clave === clave);
        Object.assign(llanta, nuevosDatos);
        renderInventario();
        closeModal('modalInventario');
        alert('Llanta editada correctamente.');
    } catch (error) {
        alert('Error al editar: ' + error.message);
    }
}
// Despu√©s de editarLlanta() y antes de guardarEdicionLlanta()
async function calcularVolumenInventario() {
    let filasActualizadas = [];
    let noCalculadas = [];
    let filasFallidas = [];

    try {
        mostrarEstado('Iniciando c√°lculos...');
        const mensajeCarga = document.getElementById('loadingMessage');
        if (mensajeCarga) mensajeCarga.style.display = 'block';
        
        const botonCalc = document.querySelector('button[onclick="calcularVolumenInventario()"]');
        if (botonCalc) botonCalc.disabled = true;

        inventario.sort((a, b) => Number(a.clave) - Number(b.clave));
        
        // Factor base para espacio log√≠stico
        const margenLogistico = 1.20;

        for (const llanta of inventario) {
            if (!llanta.volumen || Number(llanta.volumen) === 0) {
                let ancho, perfil, rin;
                let desc = (llanta.descripcion || '').replace(/[()]/g, '').toUpperCase();

                // Patrones para diferentes tipos de llantas
                const patrones = [
                    // 1. Patr√≥n para llantas comerciales/autos (ej: 185 R14 AGATE AG-06)
                    {
                       regex: /^(\d{3})\s*R(\d{2})\s*.*?(?:\((\d{1,2})\))?.*?(\d{3}\/\d{3}R)?/i,
                       calc: (m) => ({
                           ancho: Number(m[1]) / 1000, // 185mm a metros
                           perfil: 0.82, // Perfil est√°ndar para llantas R
                           rin: Number(m[2]) * 0.0254, // 14 pulgadas a metros
                           tipo: 'COMERCIAL',
                           capas: m[3] ? Number(m[3]) : 8 // Capas, por defecto 8
                        })
                    },

                    // 2. Patr√≥n para llantas industriales (ej: 19.5L-24 IND ALLWIN SEVERE)
                    {
                         regex: /^(\d+\.?\d*)L-(\d+)\s*(?:IND|INDUSTRIAL)?\s*.*?(?:\((\d{1,2})\))?.*?(L[2-5]|SEVERE)?/i,
                         calc: (m) => {
                             const ancho = Number(m[1]) * 25.4 / 1000; // Convertir pulgadas a metros
                             const rin = Number(m[2]) * 0.0254;
                             const capas = m[3] ? Number(m[3]) : 12; // Por defecto 12 capas
                             const esSevere = m[4]?.includes('SEVERE') || false;
        
                            return {
                                ancho,
                                perfil: 0.90, // Perfil t√≠pico para industrial
                                rin,
                                tipo: 'INDUSTRIAL',
                                capas,
                                factorAdicional: esSevere ? 1.1 : 1.0 // 10% extra para SEVERE
                            };
                        }
                    },
                    // 3. Patr√≥n espec√≠fico para llantas 11L-16 y similares
                    {
                        regex: /^(\d{2})L-(\d{2})\s*(?:\((\d{1,2})\))?\s*((?:SKS|F3|IND|AGRO|CT).*)?/i,
                        calc: (m) => {
                            const ancho = Number(m[1]) * 25.4 * 1.15 / 1000; // 15% m√°s ancho
                            const rin = Number(m[2]) * 0.0254;
                            const capas = m[3] ? Number(m[3]) : 12; // Por defecto 12 capas
                            const tipo = m[4]?.includes('IND') || m[4]?.includes('SKS') ? 'INDUSTRIAL' : 
                                       m[4]?.includes('AGRO') ? 'AGRICOLA' : 'INDUSTRIAL';
                            return {
                                ancho,
                                perfil: 0.90, // Perfil fijo para industrial/agr√≠cola
                                rin,
                                tipo,
                                capas
                            };
                        }
                    },
                    // 4. Llantas de Auto/SUV: 185/60 R14
                    {
                        regex: /^[P]?(\d{3})[\/\s\-](\d{2})[\/\s\-]?R?(\d{2})/,
                        calc: (m) => ({
                            ancho: Number(m[1]) / 1000,
                            perfil: Number(m[2]) / 100,
                            rin: Number(m[3]) * 0.0254,
                            tipo: 'AUTO'
                        })
                    },
                    // 5. Llantas de Cami√≥n: 11R22.5
                    {
                        regex: /^(\d{2,3})R(\d{2}\.?\d*)|(^\d{3}\/\d{2}R\d{2}\.?\d*)/,
                        calc: (m) => ({
                            ancho: Number(m[1] || m[3]) * 25.4 / 1000,
                            perfil: 0.80,
                            rin: Number(m[2] || m[4]) * 0.0254,
                            tipo: 'CAMION'
                        })
                    },
                    // 6. Llantas de Cami√≥n: 11R22.5
                    {
                       regex: /^(\d{2,3})R(\d{2}\.?\d*)|(^\d{3}\/\d{2}R\d{2}\.?\d*)/,
                       calc: (m) => ({
                           ancho: Number(m[1] || m[3]) * 25.4 / 1000,
                           perfil: 0.80,
                           rin: Number(m[2] || m[4]) * 0.0254,
                           tipo: 'CAMION'
                        })
                    },
                    // . Llantas agr√≠colas tradicionales
                    {
                        regex: /^(\d{1,2}\.?\d*)[\/\-](?:(\d{2})[\/\-])?(\d{2})/,
                        calc: (m) => ({
                            ancho: Number(m[1]) * 25.4 / 1000,
                            perfil: Number(m[2] || 90) / 100,
                            rin: Number(m[3]) * 0.0254,
                            tipo: 'AGRICOLA'
                        })
                    }
                ];

                let medidas = null;
                let tipoLlanta = '';

                // Determinar tipo por descripci√≥n
                if (desc.includes('AGRICOLA') || desc.includes('TRACTOR')) {
                    tipoLlanta = 'AGRICOLA';
                } else if (desc.includes('INDUSTRIAL') || desc.includes('OTR')) {
                    tipoLlanta = 'INDUSTRIAL';
                } else if (desc.includes('CAMION')) {
                    tipoLlanta = 'CAMION';
                } else if (desc.includes('4X4')) {
                    tipoLlanta = '4X4';
                } else {
                    tipoLlanta = 'AUTO';
                }

                // Buscar patr√≥n coincidente
                for (const patron of patrones) {
                    const match = desc.match(patron.regex);
                    if (match) {
                        medidas = patron.calc(match);
                        break;
                    }
                }

                if (!medidas) {
                    noCalculadas.push({
                        descripcion: llanta.descripcion || '(sin descripci√≥n)',
                        clave: llanta.clave
                    });
                    continue;
                }

                // Factores de correcci√≥n espec√≠ficos
                let factorCorreccion;
                switch (tipoLlanta) {
                    case 'AGRICOLA':
                        factorCorreccion = desc.includes('L-') ? 1.9 : 1.8;
                        break;
                    case 'INDUSTRIAL':
                        factorCorreccion = desc.includes('SKS') ? 2.1 : 2.0;
                        break;
                    case 'CAMION':
                        factorCorreccion = 1.5;
                        break;
                    case '4X4':
                        factorCorreccion = 1.3;
                        break;
                    default:
                        factorCorreccion = 1.0;
                }

                // Ajustes adicionales para SKS y patrones especiales
                if (desc.match(/SKS-[1-3]|L-5/)) {
                    factorCorreccion *= 1.1; // 10% adicional
                }

                // C√°lculo de volumen optimizado
                let volumen_m3;
                if (tipoLlanta === 'INDUSTRIAL' || tipoLlanta === 'AGRICOLA') {
                    let alturaFlanco = medidas.perfil * medidas.ancho;
                    let diametroExterno = (medidas.rin + 2 * alturaFlanco) * 1.08;
                    volumen_m3 = Math.PI * Math.pow(diametroExterno/2, 2) * medidas.ancho * 
                                factorCorreccion * margenLogistico;
                    
                    // Ajuste por n√∫mero de capas
                    if (medidas.capas && medidas.capas > 12) {
                        volumen_m3 *= (1 + (medidas.capas - 12) * 0.02);
                    }
                } else {
                    let alturaFlanco = medidas.perfil * medidas.ancho;
                    let diametroExterno = medidas.rin + 2 * alturaFlanco;
                    volumen_m3 = Math.PI * Math.pow(diametroExterno/2, 2) * medidas.ancho * 
                                factorCorreccion * margenLogistico;
                }

                const nuevoVolumen = volumen_m3.toFixed(4);

                try {
                    const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/clave/${llanta.clave}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ data: { volumen: nuevoVolumen } })
                    });

                    if (!res.ok) throw new Error('Error en PATCH: ' + res.status);
                    llanta.volumen = nuevoVolumen;
                    filasActualizadas.push({ 
                        clave: llanta.clave, 
                        volumen: nuevoVolumen,
                        tipo: tipoLlanta 
                    });
                    await new Promise(r => setTimeout(r, 120));
                } catch (err) {
                    filasFallidas.push({ 
                        clave: llanta.clave, 
                        descripcion: llanta.descripcion || '', 
                        error: err.message 
                    });
                }
            }
        }

        renderInventario();
        mostrarResultadosCalculo(noCalculadas, filasActualizadas, filasFallidas);

    } catch (error) {
        console.error('Error en c√°lculos:', error);
        mostrarEstado(`Error: ${error.message}`, 'error');
    } finally {
        if (mensajeCarga) mensajeCarga.style.display = 'none';
        if (botonCalc) botonCalc.disabled = false;
    }
}
// Buscar ID inventario
function searchInventario() {
    const filter = document.getElementById('searchInventario').value.toLowerCase();
    const tbody = document.querySelector('#tablaInventario tbody');
     for (let row of tbody.rows) {
        const claveCell = row.cells[0].textContent.toLowerCase();
        const descripcionCell = row.cells[1].textContent.toLowerCase();
        // Busca en clave o descripci√≥n
        const match = claveCell.includes(filter) || descripcionCell.includes(filter);
        row.style.display = match ? '' : 'none';
        if (match && filter) {
            row.classList.add('highlight-yellow');
                setTimeout(() => row.classList.remove('highlight-yellow'), 1100);
            }
        }
    }
    function highlightSearch(tab, valor) {
        if (!valor) return;
        let rows = document.querySelector(`#tabla${tab.charAt(0).toUpperCase() + tab.slice(1)} tbody`).rows;
        [...rows].forEach(row => {
            if (row.cells[0].textContent.toLowerCase().includes(valor.toLowerCase())) {
                row.classList.add('highlight-yellow');
                row.scrollIntoView({ behavior: "smooth", block: "center" });
                setTimeout(() => row.classList.remove('highlight-yellow'), 900);
            }
        });
    }
    function buscarLlantaPorId(id) {
        return inventario.find(llanta => llanta.id === id);
    }

    // ---------- Agregar nueva llanta a SheetDB ----------
    async function agregarNuevaLlanta() {
    // Obtener valores de los campos correctos
    const clave = document.getElementById('agregarId').value.trim();
    const descripcion = document.getElementById('agregarDescripcion').value.trim();
    const peso = document.getElementById('agregarPeso').value.trim();
    const volumen = document.getElementById('agregarVolumen').value.trim();
    const valor = document.getElementById('agregarValor').value.trim();
    const linea = document.getElementById('agregarLinea').value.trim();

    // Validar solo campos requeridos
    if (!clave) {
        alert('El c√≥digo/ID es obligatorio');
        return;
    }
    if (!descripcion) {
        alert('La descripci√≥n es obligatoria');
        return;
    }

    // Crear objeto con datos
    const nuevaLlanta = {
        clave: clave,
        descripcion: descripcion,
        peso: peso || '',
        volumen: volumen || '',
        valor: valor || '',
        linea: linea || ''
    };

    try {
        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                data: [nuevaLlanta]
            })
        });

        if (!response.ok) {
            throw new Error('Error al guardar la llanta');
        }

        // Agregar al inventario local
        inventario.push(nuevaLlanta);
        
        // Actualizar tabla
        renderInventario();
        
        // Limpiar formulario
        document.getElementById('formAgregarLlanta').reset();
        
        // Cerrar modal
        closeModal('modalInventario');

        alert('Llanta agregada correctamente');

    } catch (error) {
        console.error('Error:', error);
        alert('Error al agregar la llanta: ' + error.message);
    }
}
    function generarNuevoIdInventario() {
        if (!inventario.length) return "1";
        let maxId = inventario.reduce((max, ll) => {
            let n = parseInt(ll.id);
            return n > max ? n : max;
        }, 0);
        return String(maxId + 1);
    }
    function limpiarFormularioInventario() {
        document.getElementById('agregarId').value = '';
        document.getElementById('agregarDescripcion').value = '';
        document.getElementById('agregarPeso').value = '';
        document.getElementById('agregarVolumen').value = '';
        document.getElementById('agregarValor').value = '';
    }
    function searchFlota() {
    const filter = document.getElementById('searchFlota').value.toLowerCase();
    const tbody = document.querySelector('#tablaFlota tbody');
    for (let row of tbody.rows) {
        const economicoCell = row.cells[0].textContent.toLowerCase();
        const match = economicoCell.includes(filter);
        row.style.display = match ? '' : 'none';
        if (match && filter) {
            row.classList.add('highlight-yellow');
            setTimeout(() => row.classList.remove('highlight-yellow'), 1100);
        }
    }
}
    // ---------- Renderizar Flota ----------
  function renderFlota() {
    const tbody = document.querySelector('#tablaFlota tbody');
    tbody.innerHTML = '';
    flota.forEach(camion => {   
        const cargaNum = safeNum(camion["capacidad de carga (kg)"] || camion.carga);
        const volumenNum = safeNum(camion["volumen"] || camion.volumen);
        const cargaMostrar = cargaNum === 0 ? '-' : cargaNum.toFixed(3);
        const volumenMostrar = volumenNum === 0 ? '-' : volumenNum.toFixed(3);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${camion.economico || '-'}</td>
            <td>${camion.unidad || '-'}</td>
            <td>${camion.asignado || camion.encargado || '-'}</td>
            <td>${camion.modelo || '-'}</td>
            <td>${camion.identificacion || '-'}</td>
            <td>${camion.ubicacion || '-'}</td>
            <td>${cargaMostrar}</td>
            <td>${volumenMostrar}</td>
            <td>
            <button onclick="editarCamion('${camion.economico}')">Editar</button>
            <button onclick="eliminarCamion('${camion.economico}')">Eliminar</button>
            </td>
         `;
        tbody.appendChild(tr);
    });
    highlightSearch('flota', document.getElementById('searchFlota').value);
}
     async function eliminarCamion(economico) {
       if (!confirm('¬øSeguro que deseas eliminar este cami√≥n?')) return;
       try {
         const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/economico/${economico}?sheet=flota`, {
           method: 'DELETE'
         });
         if (!res.ok) throw new Error('No se pudo eliminar');
         flota = flota.filter(item => item.economico !== economico);
         renderFlota();
         alert('Cami√≥n eliminado correctamente.');
       } catch (error) {
         alert('Error al eliminar: ' + error.message);
       }
     } 
    function editarCamion(economico) {
        const camion = flota.find(item => item.economico === economico);
        document.getElementById('modalFlota').innerHTML = `
          <div class="modal-content">
            <h3>Editar Cami√≥n</h3>
            <label>N√∫mero Econ√≥mico: <input id="editCamionEconomico" value="${camion.economico}" readonly /></label><br>
            <label>Nombre (Unidad): <input id="editCamionUnidad" value="${camion.unidad || ''}" /></label><br>
            <label>Capacidad de carga (kg): <input id="editCamionCarga" type="number" step="0.001" value="${camion['capacidad de carga (kg)'] || camion.carga || ''}" /></label><br>
            <label>Volumen (m¬≥): <input id="editCamionVolumen" type="number" step="0.001" value="${camion.volumen || ''}" /></label><br>
            <button onclick="guardarEdicionCamion('${camion.economico}')">Guardar</button>
            <button onclick="closeModal('modalFlota')">Cancelar</button>
          </div>
        `;
        openModal('modalFlota');
    }

    async function guardarEdicionCamion(economico) {
      const nuevosDatos = {
        unidad: document.getElementById('editCamionUnidad').value,
        "capacidad de carga (kg)": document.getElementById('editCamionCarga').value,
        volumen: document.getElementById('editCamionVolumen').value
      };
      try {
        const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/economico/${economico}?sheet=flota`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: nuevosDatos })
        });
        if (!res.ok) throw new Error('No se pudo editar');
        const camion = flota.find(item => item.economico === economico);
        Object.assign(camion, nuevosDatos);
        renderFlota();
        closeModal('modalFlota');
        alert('Cami√≥n editado correctamente.');
      } catch (error) {          
        alert('Error al editar: ' + error.message);
      }
    }

    // ---------- Agregar nuevo cami√≥n a SheetDB ----------
    async function agregarNuevoCamion() {
        const economicoInput = document.getElementById('agregarEconomico').value.trim();
        const unidad = document.getElementById('agregarUnidad').value.trim();
        const asignado = document.getElementById('agregarAsignado').value.trim();
        const modelo = document.getElementById('agregarModelo').value.trim();
        const placas = document.getElementById('agregarPlacas').value.trim();
        const ubicacion = document.getElementById('agregarUbicacion').value.trim();
        const carga = parseFloat(document.getElementById('agregarCarga').value);
        const volumen = parseFloat(document.getElementById('agregarVolumenCamion').value);
        const msgDiv = document.getElementById('msgFlota');
        msgDiv.textContent = '';
        msgDiv.className = 'msg';

        if (!unidad || !asignado || !modelo || !placas || !ubicacion || isNaN(carga) || isNaN(volumen)) {
            msgDiv.textContent = 'Por favor completa todos los campos correctamente.';
            msgDiv.classList.add('error');
            return;
        }

        let economico = economicoInput || generarNuevoEconomico();

        if (flota.some(cam => cam.economico === economico)) {
            msgDiv.textContent = 'El n√∫mero econ√≥mico ya existe. Por favor usa otro.';
            msgDiv.classList.add('error');
            return;
        }

        const nuevoDato = {
            economico,
            unidad,
            asignado,
            modelo,
            placas,
            ubicacion,
            carga,
            volumen
        };

        try {
            const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=flota', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: nuevoDato })
            });
            if (!res.ok) throw new Error('Error al agregar cami√≥n');
            msgDiv.textContent = 'Cami√≥n agregado correctamente!';
            msgDiv.classList.add('success');
            limpiarFormularioFlota();
            await fetchFlota();
            closeModal('modalFlota');
        } catch (e) {
            msgDiv.textContent = 'Error: ' + e.message;
            msgDiv.classList.add('error');
        }
    }
    function generarNuevoEconomico() {
        if (!flota.length) return "1";
        let maxEco = flota.reduce((max, cam) => {
            let n = parseInt(cam.economico);
            return n > max ? n : max;
        }, 0);
        return String(maxEco + 1);
    }
    // Funci√≥n para manejar el debounce de actualizaci√≥n
    let timeoutId = null;
    function actualizarSugerenciaUnidad() {
        // Cancelar el timeout anterior si existe
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        
        // Establecer un nuevo timeout
        timeoutId = setTimeout(() => {
            calcularSugerenciaUnidad();
        }, 300); // Esperar 300ms despu√©s de la √∫ltima entrada
    }

    // Definir promedios seg√∫n el tipo de llanta
    const PROMEDIOS_LLANTAS = {
        'AUTO': { volumen: 0.047, peso: 7},
        'SUV_CAMIONETA': { volumen: 0.060, peso: 12.5 },
        'COMERCIAL_LIGERO': { volumen: 0.120, peso: 25 },
        'PESADO': { volumen: 0.280, peso: 50 },
        'AGRICOLA_MINERO': { volumen: 0.150, peso: 80 },
        'CAMARAS': { volumen: 0.010, peso: 2 }
    };

    // Array para almacenar las llantas agregadas
    let llantasAgregadas = [];

    // Funci√≥n para filtrar y mostrar sugerencias de llantas
    function mostrarSugerenciasLlantas(busqueda) {
        const contenedorSugerencias = document.getElementById('sugerenciasLlantas');
        const inputBusqueda = document.getElementById('busquedaLlanta');
        const inputHidden = document.getElementById('descripcionLlanta');
        
        if (!busqueda) {
            contenedorSugerencias.style.display = 'none';
            return;
        }

        // Filtrar inventario basado en la b√∫squeda
        const sugerencias = inventario.filter(llanta => 
            llanta.descripcion && 
            llanta.volumen && 
            llanta.peso && 
            llanta.descripcion.toLowerCase().includes(busqueda.toLowerCase())
        );

        if (sugerencias.length > 0) {
            contenedorSugerencias.innerHTML = sugerencias.map(llanta => `
                <div class="p-2 border-bottom hover-bg-light cursor-pointer sugerencia-item" 
                     style="cursor: pointer;"
                     data-valor='${JSON.stringify({
                         descripcion: llanta.descripcion,
                         volumen: parseFloat(llanta.volumen),
                         peso: parseFloat(llanta.peso)
                     })}'>
                    ${llanta.descripcion}
                </div>
            `).join('');
            
            contenedorSugerencias.style.display = 'block';

            // Agregar eventos click a las sugerencias
            contenedorSugerencias.querySelectorAll('.sugerencia-item').forEach(item => {
                item.addEventListener('click', () => {
                    const datos = JSON.parse(item.getAttribute('data-valor'));
                    inputBusqueda.value = datos.descripcion;
                    inputHidden.value = JSON.stringify(datos);
                    contenedorSugerencias.style.display = 'none';
                });
            });
        } else {
            contenedorSugerencias.innerHTML = '<div class="p-2 text-muted">No se encontraron llantas</div>';
            contenedorSugerencias.style.display = 'block';
        }
    }

    // Agregar el evento de b√∫squeda al input
    document.getElementById('busquedaLlanta').addEventListener('input', (e) => {
        mostrarSugerenciasLlantas(e.target.value);
    });

    // Cerrar sugerencias al hacer click fuera
    document.addEventListener('click', (e) => {
        const contenedorSugerencias = document.getElementById('sugerenciasLlantas');
        const inputBusqueda = document.getElementById('busquedaLlanta');
        if (!inputBusqueda.contains(e.target) && !contenedorSugerencias.contains(e.target)) {
            contenedorSugerencias.style.display = 'none';
        }
    });

    // Funci√≥n para agregar una llanta a la lista
    function agregarTipoLlanta() {
        const cantidad = parseInt(document.getElementById('sugestionCantidad').value) || 0;
        const inputHidden = document.getElementById('descripcionLlanta');
        let llantaSeleccionada;
        
        try {
            llantaSeleccionada = JSON.parse(inputHidden.value);
        } catch (e) {
            llantaSeleccionada = null;
        }

        if (cantidad <= 0) {
            alert('Por favor ingrese una cantidad v√°lida');
            return;
        }

        if (!llantaSeleccionada) {
            alert('Por favor seleccione una llanta del listado');
            return;
        }

        // Calcular el volumen y peso de las llantas usando datos reales
        const volumen = cantidad * llantaSeleccionada.volumen;
        const peso = cantidad * llantaSeleccionada.peso;

        // Crear objeto de llanta con datos reales
        const llanta = {
            descripcion: llantaSeleccionada.descripcion,
            cantidad: cantidad,
            volumen: volumen,
            peso: peso
        };

        // Agregar la llanta y actualizar la interfaz
        llantasAgregadas.push(llanta);
        actualizarTablaLlantas();
        
        // Forzar la actualizaci√≥n de la sugerencia
        setTimeout(() => {
            calcularSugerenciaUnidad();
            document.getElementById('resultadoSugerencia').classList.remove('d-none');
        }, 100);

        // Limpiar campos
        document.getElementById('sugestionCantidad').value = '1';
    }

    // Funci√≥n para eliminar un tipo de llanta
    function eliminarTipoLlanta(index) {
        llantasAgregadas.splice(index, 1);
        actualizarTablaLlantas();
        calcularSugerenciaUnidad();
    }

    // Funci√≥n para enviar datos a la hoja de SheetDB
    async function enviarDatosAHojaApartados(pedido) {
        try {
            // Validar que pedido tenga todos los campos necesarios
            if (!pedido || !pedido.detallesLlantas) {
                throw new Error('Datos de pedido incompletos');
            }

            // Agrupar llantas por descripci√≥n
            const llantasPorTipo = pedido.detallesLlantas.reduce((grupos, llanta) => {
                const tipo = llanta.descripcion;
                if (!grupos[tipo]) {
                    grupos[tipo] = {
                        cantidad: 0,
                        volumen: 0,
                        peso: 0
                    };
                }
                grupos[tipo].cantidad += parseInt(llanta.cantidad) || 0;
                grupos[tipo].volumen += parseFloat(llanta.volumen) || 0;
                grupos[tipo].peso += parseFloat(llanta.peso) || 0;
                return grupos;
            }, {});

            // Preparar las descripciones y cantidades separadas
            const descripciones = [];
            const cantidades = [];
            const volumenes = [];
            const pesos = [];

            Object.entries(llantasPorTipo).forEach(([descripcion, datos]) => {
                descripciones.push(descripcion);
                cantidades.push(datos.cantidad.toString());
                volumenes.push(datos.volumen.toFixed(2));
                pesos.push(datos.peso.toFixed(2));
            });

            // Formatear valores totales
            const totalLlantas = cantidades.reduce((sum, cant) => sum + parseInt(cant), 0);
            const volumenTotal = volumenes.reduce((sum, vol) => sum + parseFloat(vol), 0);
            const pesoTotal = pesos.reduce((sum, peso) => sum + parseFloat(peso), 0);

            const descripcionLlantas = descripciones.join(' || ');
            const cantidadesFormateadas = cantidades.join(' || ');
            const volumenFormateado = volumenTotal.toFixed(2);
            const pesoFormateado = pesoTotal.toFixed(2);

            // Formatear los datos como lo requiere SheetDB - usando los nombres exactos de las columnas
            const datosParaEnviar = [{
                "Fecha": pedido.fecha,
                "Unidad": pedido.unidad,
                "Econ√≥mico": pedido.economico,
                "Llantas": totalLlantas.toString(),
                "Descripcion": descripcionLlantas,
                "Cantidad": cantidadesFormateadas,
                "Volumen": volumenFormateado,
                "Peso": pesoFormateado,
                "Detalles": JSON.stringify(llantasPorTipo) // Guardamos los detalles completos por si son necesarios despu√©s
            }];
            
            console.log('Datos a enviar:', datosParaEnviar);

            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    data: datosParaEnviar
                })
            });

            if (!response.ok) {
                const responseText = await response.text();
                console.error('Error en la respuesta:', response.status, responseText);
                throw new Error(`Error al enviar datos: ${response.status} ${responseText}`);
            }

            const responseData = await response.json();
            console.log('Respuesta exitosa:', responseData);

        } catch (error) {
            console.error('Error detallado:', error);
            console.error('Stack trace:', error.stack);
            alert('Hubo un error al enviar los datos a la hoja de c√°lculo. Por favor, revisa la consola para m√°s detalles.');
            throw error; // Re-lanzar el error para que podamos verlo en la consola
        }
    }

    // Funci√≥n helper para formatear la fecha
    function obtenerFechaFormateada() {
        const fecha = new Date();
        const dia = fecha.getDate().toString().padStart(2, '0');
        const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
        const a√±o = fecha.getFullYear();
        return `${dia}/${mes}/${a√±o}`;
    }

    // Funci√≥n para apartar un bloque y enviarlo a Apartados
    async function apartarBloque(unidad, economico, llantas, descripcion, volumen, peso) {
        const fecha = obtenerFechaFormateada();
        
        // Crear el objeto con los datos del pedido confirmado
        const pedidoConfirmado = {
            Fecha: fecha,
            Unidad: unidad,
            Econ√≥mico: economico,
            Llantas: llantas,
            Descripci√≥n: descripcion,
            Volumen: volumen,
            Peso: peso
        };

        try {
            // Enviar los datos a la hoja de c√°lculo de Apartados
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: [pedidoConfirmado]
                })
            });

            if (!response.ok) throw new Error('Error al guardar en Apartados');

            // Actualizar la vista de pedidos Apartados
            await fetchPedidosApartados();
            
            // Mostrar mensaje de √©xito
            alert('Bloque apartado y enviado a Apartados exitosamente');
            
            // Cambiar a la pesta√±a de Apartados
            document.querySelector('[data-tab="pedidos-Apartados"]').click();
        } catch (error) {
            alert('Error al apartar el bloque: ' + error.message);
        }
    }

    // Funci√≥n para apartar una unidad y enviarla a Apartados
    async function enviarDatosAHojaConfirmados(pedido) {
        console.log('Enviando datos a hoja confirmados:', pedido);
        
        try {
            // Validar datos del pedido
            if (!pedido || !pedido.economico || !pedido.nombre || !pedido.llantasEstimadas) {
                throw new Error('Datos de pedido incompletos');
            }

            // Distribuir las llantas para esta unidad
            const distribucionLlantas = calcularDistribucionLlantas(llantasAgregadas, pedido.llantasEstimadas);
            console.log('Distribuci√≥n calculada:', distribucionLlantas);

            // Generar descripci√≥n de llantas
            const descripcionLlantas = distribucionLlantas
                .filter(l => l.cantidad > 0)
                .map(l => {
                    // Separar la descripci√≥n en sus partes
                    const [medida, ...resto] = l.descripcion.split(' ');
                    const espaciadoExtra = l.cantidad < 1000 ? ' ' : '';  // Alinear cuando el n√∫mero tiene menos d√≠gitos
                    return `‚Ä¢ ${l.cantidad}${espaciadoExtra} x ${l.descripcion}`;
                })
                .join('\\n');

            // Preparar los datos para enviar
            const datosParaEnviar = {
                Fecha: new Date().toLocaleDateString(),
                Unidad: pedido.unidad || '',
                Econ√≥mico: String(pedido.economico || '').trim(),
                Nombre: pedido.nombre,
                Llantas: pedido.llantasEstimadas,
                Descripcion: descripcionLlantas,
                Volumen: pedido.volumenAsignado.toFixed(2) + ' m¬≥',
                Peso: pedido.pesoAsignado.toFixed(2) + ' kg',
                Eficiencia: pedido.eficiencia.toFixed(1) + '%',
                Estado: 'Confirmado',
                DetallesLlantas: JSON.stringify(distribucionLlantas)
            };

            console.log('Datos preparados para enviar:', datosParaEnviar);

            // Enviar a SheetDB
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: [datosParaEnviar]
                })
            });

            if (!response.ok) {
                throw new Error(`Error al enviar datos: ${response.status}`);
            }

            const resultado = await response.json();
            console.log('Datos enviados exitosamente:', resultado);
            
            // Agregar a la lista de pedidos apartados
            if (!window.pedidosApartados) {
                window.pedidosApartados = [];
            }
            window.pedidosApartados.push(datosParaEnviar);

            return resultado;

        } catch (error) {
            console.error('Error en enviarDatosAHojaApartados:', error);
            throw new Error(`Error al enviar datos: ${error.message}`);
        }
    }

    function calcularDistribucionLlantas(llantasOriginales, cantidadObjetivo) {
        console.log('Calculando distribuci√≥n para:', {
            llantasOriginales,
            cantidadObjetivo
        });

        // Crear una copia de las llantas originales y su cantidad disponible
        let llantasDisponibles = llantasOriginales.map(l => ({...l}));
        const distribucion = llantasOriginales.map(l => ({...l, cantidad: 0}));
        let llantasPorAsignar = cantidadObjetivo;

        // Procesar cada tipo de llanta en orden
        for (let i = 0; i < llantasDisponibles.length && llantasPorAsignar > 0; i++) {
            // Ver cu√°ntas llantas podemos tomar de este tipo
            const disponibles = llantasDisponibles[i].cantidad;
            const aAsignar = Math.min(llantasPorAsignar, disponibles);

            if (aAsignar > 0) {
                distribucion[i].cantidad = aAsignar;
                llantasDisponibles[i].cantidad -= aAsignar;
                llantasPorAsignar -= aAsignar;

                console.log(`Asignadas ${aAsignar} llantas del tipo ${distribucion[i].descripcion}`);
            }
        }

        // Solo retornar los tipos de llantas que se usaron
        return distribucion.filter(l => l.cantidad > 0);
    }

    async function apartarDistribucionCompleta(button) {
        try {
            // Obtener las unidades del atributo data
            const unidades = JSON.parse(button.dataset.unidades);
            
            if (!Array.isArray(unidades) || unidades.length === 0) {
                throw new Error('No hay unidades para apartar');
            }

            // Solicitar el nombre del cliente/responsable
            const nombre = await Swal.fire({
                title: 'Nombre del Responsable',
                input: 'text',
                inputLabel: 'Por favor, ingrese el nombre del responsable del pedido',
                inputPlaceholder: 'Nombre completo',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'Debe ingresar un nombre';
                    }
                }
            });

            if (!nombre.isConfirmed || !nombre.value) {
                return;
            }

            // Confirmar con el usuario mostrando el resumen
            const resumen = unidades.map(u => 
                `- ${u.unidad} (${u.economico}): ${u.llantasEstimadas} llantas, ${u.volumenAsignado.toFixed(2)} m¬≥`
            ).join('\\n');

            const confirmar = await Swal.fire({
                title: '¬øConfirmar Distribuci√≥n?',
                html: `
                    <div class="text-start">
                        <p><strong>Responsable:</strong> ${nombre.value}</p>
                        <p><strong>Unidades a apartar:</strong></p>
                        <pre>${resumen}</pre>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, Apartar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirmar.isConfirmed) {
                return;
            }

            // Deshabilitar el bot√≥n mientras se procesa
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Apartando...';

            console.log('Iniciando apartado de distribuci√≥n completa:', unidades);

            // Procesar cada unidad en secuencia
            for (const unidad of unidades) {
                console.log('Apartando unidad:', unidad.economico);
                
                // Crear el pedido para esta unidad con todos los datos necesarios
                const pedido = {
                    economico: unidad.economico,
                    unidad: unidad.unidad,
                    nombre: nombre.value,
                    llantasEstimadas: unidad.llantasEstimadas,
                    llantas: llantasAgregadas,
                    descripcionLlantas: llantasAgregadas.map(l => 
                        `${l.cantidad} x ${l.descripcion}`
                    ).join(', '),
                    volumenAsignado: unidad.volumenAsignado,
                    pesoAsignado: unidad.pesoAsignado,
                    eficiencia: unidad.eficiencia
                };

                try {
                    // Enviar a la hoja de confirmados
                    await enviarDatosAHojaConfirmados(pedido);
                    console.log('Unidad apartada exitosamente:', unidad.economico);
                } catch (errorUnidad) {
                    console.error('Error al apartar unidad:', unidad.economico, errorUnidad);
                    throw new Error(`Error al apartar unidad ${unidad.economico}: ${errorUnidad.message}`);
                }
            }

            // Actualizar la interfaz
            await fetchPedidosConfirmados();
            
            // Limpiar las llantas agregadas
            llantasAgregadas = [];
            actualizarTablaLlantas();
            
            // Mostrar mensaje de √©xito
            alert(`Se han apartado exitosamente ${unidades.length} unidades para este pedido.`);
            
            // Ocultar el contenedor de detalles
            const contenedorDetalles = document.getElementById('unidadSugeridaDetalles');
            if (contenedorDetalles) {
                contenedorDetalles.innerHTML = '';
            }

        } catch (error) {
            console.error('Error al apartar distribuci√≥n:', error);
            alert('Error: ' + error.message);
        } finally {
            // Rehabilitar el bot√≥n
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-box-arrow-right"></i> Apartar Distribuci√≥n Completa';
            
            // Actualizar c√°lculos
            calcularSugerenciaUnidad();
        }
    }

    async function apartarUnidadConDetalles(codigoEconomico, llantas, volumenTotal, pesoTotal) {
        try {
            console.log('Iniciando apartarUnidadConDetalles con:', {
                codigoEconomico,
                llantas,
                volumenTotal,
                pesoTotal
            });

            // Validar c√≥digo econ√≥mico
            if (!codigoEconomico || codigoEconomico.trim() === '') {
                throw new Error('El c√≥digo econ√≥mico es requerido');
            }

            // Buscar la unidad en la flota
            const unidadEncontrada = flota.find(u => 
                String(u.economico).trim().toLowerCase() === String(codigoEconomico).trim().toLowerCase() ||
                String(u.codigo).trim().toLowerCase() === String(codigoEconomico).trim().toLowerCase()
            );

            if (!unidadEncontrada) {
                throw new Error(`No se encontr√≥ la unidad con c√≥digo econ√≥mico: ${codigoEconomico}`);
            }

            // Asegurarse de que flota est√© disponible
            if (!flota || !Array.isArray(flota)) {
                console.error('Error: flota no est√° definida o no es un array');
                alert('Error al buscar la unidad: La flota no est√° disponible');
                return;
            }

            // Si codigoEconomico es un objeto, extraer el c√≥digo
            let codigoFinal = codigoEconomico;
            if (typeof codigoEconomico === 'object' && codigoEconomico !== null) {
                codigoFinal = codigoEconomico.codigo || codigoEconomico.economico;
            }

            // Normalizar el c√≥digo econ√≥mico
            const codigoNormalizado = codigoFinal.toString().trim().toLowerCase();
            console.log('C√≥digo normalizado:', codigoNormalizado);

            // Buscar la unidad en la flota
            const unidad = flota.find(u => {
                const economicoUnidad = (u.economico || '').toString().trim().toLowerCase();
                const codigoUnidad = (u.codigo || '').toString().trim().toLowerCase();
                return economicoUnidad === codigoNormalizado || codigoUnidad === codigoNormalizado;
            });

            if (!unidad) {
                console.error('No se encontr√≥ la unidad con c√≥digo:', codigoNormalizado);
                alert('No se encontr√≥ la unidad en la flota');
                return;
            }

            // Guardar la unidad como unidadParam para uso en el template
            const unidadParam = unidad;

            // Solicitar el nombre de la persona que hace el pedido
            const nombrePedido = prompt("Por favor, ingrese el nombre de quien hace el pedido:");
            if (!nombrePedido) {
                throw new Error('Se requiere ingresar un nombre para el pedido');
            }

            // Funci√≥n auxiliar para limpiar las tablas
            function limpiarTablas() {
                // Limpiar tabla de llantas  
                const tablaLlantas = document.getElementById('tablaLlantasSeleccionadas');
                if (tablaLlantas && tablaLlantas.getElementsByTagName('tbody')[0]) {
                    tablaLlantas.getElementsByTagName('tbody')[0].innerHTML = '';
                }

                // Limpiar tabla de unidades sugeridas
                const tablaSugerencias = document.getElementById('tablaUnidadesSugeridasBusqueda');
                if (tablaSugerencias) {
                    tablaSugerencias.innerHTML = '';
                }

                // Limpiar resultados de b√∫squeda
                const resultadosBusqueda = document.getElementById('resultadosBusqueda');
                if (resultadosBusqueda) {
                    resultadosBusqueda.innerHTML = `
                        <div class="alert alert-success">
                            <h5 class="mb-0">
                                <i class="bi bi-check-circle me-2"></i>
                                Unidad apartada exitosamente
                            </h5>
                            <p class="mb-0 mt-2">
                                Unidad: ${unidadParam.codigo || unidadParam.economico}<br>
                                Apartada por: ${nombrePedido}
                            </p>
                        </div>
                    `;
                }

                // Limpiar campo de b√∫squeda
                const campoBusqueda = document.getElementById('busquedaBloque');
                if (campoBusqueda) {
                    campoBusqueda.value = '';
                }
            }

            console.log('Datos recibidos:', { codigoEconomico, llantas, volumenTotal, pesoTotal });
            console.log('Datos de la unidad encontrada:', unidad);
            
            // Obtener los datos actuales del bloque seleccionado
            const bloqueSeleccionado = window.bloqueSeleccionado || {};
            const llantasBloque = Array.isArray(llantas) ? llantas : (bloqueSeleccionado.llantas || []);
            
            // Obtener la fecha actual formateada
            const fecha = obtenerFechaFormateada();

            // Extraer los datos de la unidad considerando todas las posibles propiedades
            const nombreUnidad = unidad.unidad || '';  // El nombre de la unidad est√° en la propiedad 'unidad'
            // Intentar obtener el n√∫mero econ√≥mico de todas las posibles propiedades
            const numeroEconomico = (unidad.economico || unidad.codigo || '').toString().trim();
            
            // Validar que tengamos todos los datos necesarios
            if (!numeroEconomico) {
                throw new Error('No se pudo obtener el n√∫mero econ√≥mico de la unidad');
            }

            if (llantasBloque.length === 0) {
                throw new Error('No se han agregado llantas al pedido');
            }
            
            console.log('Datos procesados de la unidad:', { nombreUnidad, numeroEconomico });
            
            // Preparar los datos exactamente como los necesita la hoja de c√°lculo
            console.log('Enviando datos de la unidad:', {
                nombre: nombreUnidad,
                economico: numeroEconomico,
                solicitante: nombrePedido
            });

            // Asegurarse de que nombreUnidad est√© definido
            const nombreUnidadFinal = nombreUnidad || unidad.nombre || unidad.tipo || 'KENWORTH';
            
            const datosParaEnviar = {
                data: [{
                    "Fecha": fecha,
                    "Unidad": nombreUnidadFinal,
                    "Econ√≥mico": numeroEconomico,
                    "Nombre": nombrePedido,
                    "Llantas": llantasBloque.reduce((sum, l) => sum + (parseInt(l.cantidad) || 0), 0),
                    "Descripcion": llantasBloque.map(l => `${l.cantidad} x ${l.descripcion}`).join(', '),
                    "Volumen": Number(bloqueSeleccionado.volumenTotal || volumenTotal || 0).toFixed(2),
                    "Peso": Number(bloqueSeleccionado.pesoTotal || pesoTotal || 0).toFixed(2)
                }]
            };

            console.log('Datos a enviar:', datosParaEnviar);

            // Enviar los datos a la hoja de c√°lculo de Apartados
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosParaEnviar)
            });

            if (!response.ok) throw new Error('Error al guardar en Apartados');

            // Actualizar la vista de pedidos Apartados
            await fetchPedidosApartados();
            
            // Limpiar todas las tablas y mostrar mensaje de confirmaci√≥n
            limpiarTablas();
            
            // Restablecer las variables globales
            window.bloqueSeleccionado = null;
            window.llantasBloque = [];
            
            // Mostrar mensaje de √©xito
            alert('Unidad apartada y enviada a Apartados exitosamente');
            
            // Cambiar a la pesta√±a de Apartados
            document.querySelector('[data-tab="pedidos-Apartados"]').click();

            // Limpiar la lista de llantas agregadas
            llantasAgregadas = [];
            actualizarTablaLlantas();
            
            // Ocultar la secci√≥n de unidad sugerida
            document.getElementById('resultadoSugerencia').classList.add('d-none');

        } catch (error) {
            console.error('Error al apartar la unidad:', error);
            alert('Error al apartar la unidad: ' + error.message);
        }
    }
    
    // Funci√≥n para liberar una unidad
    async function liberarUnidad(index) {
        if (confirm('¬øEst√° seguro de que desea liberar esta unidad?')) {
            try {
                const pedidoAEliminar = pedidosApartados[index];
                const numeroEconomico = pedidoAEliminar.Econ√≥mico || pedidoAEliminar.Economico || pedidoAEliminar.economico;
                
                if (!numeroEconomico) {
                    throw new Error('No se pudo obtener el n√∫mero econ√≥mico del pedido');
                }
                
                // Eliminar de SheetDB usando el n√∫mero econ√≥mico como identificador
                const response = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/Econ√≥mico/${numeroEconomico}?sheet=Apartados`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });   

                if (!response.ok) {
                    throw new Error(`Error al eliminar de la hoja de c√°lculo: ${response.status}`);
                }

                // Si la eliminaci√≥n en SheetDB fue exitosa, eliminar del array local
                pedidosApartados.splice(index, 1);
                actualizarTablaPedidosApartados();
                
                // Mostrar mensaje de √©xito
                alert('La unidad ha sido liberada exitosamente');
            } catch (error) {
                console.error('Error al liberar la unidad:', error);
                alert('Hubo un error al liberar la unidad. Por favor, intente nuevamente.');
            }
        }
    }
    
    // Funci√≥n para cargar datos desde SheetDB
    async function fetchPedidosConfirmados() {
        try {
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados');
            if (!response.ok) {
                throw new Error(`Error al cargar pedidos confirmados: ${response.status}`);
            }
            const data = await response.json();
            console.log('Pedidos confirmados actualizados:', data);
            
            // Actualizar la variable global de pedidos confirmados
            window.pedidosApartados = data || [];
            
            // Actualizar la tabla de pedidos
            actualizarTablaPedidosApartados();
            
            return data;
        } catch (error) {
            console.error('Error al cargar pedidos confirmados:', error);
            alert('Error al actualizar los pedidos confirmados: ' + error.message);
            throw error;
        }
    }

    async function cargarDatosDesdeSheetDB() {
        try {
            const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados');
            
            if (!response.ok) {
                throw new Error(`Error al cargar datos: ${response.status}`);
            }

            const data = await response.json();
            console.log('Datos cargados:', data); // Para debugging
            
            // Convertir los datos de SheetDB al formato de pedidosApartados
            pedidosApartados = data.map(row => {
                console.log('Procesando fila:', row); // Para debugging
                
                // Crear el detalle de llantas incluyendo la descripci√≥n completa
                const descripcionLlanta = row.Descripcion || ''; // Nota: sin tilde
                const detallesLlantas = [{
                    descripcion: descripcionLlanta,
                    cantidad: parseInt(row.Llantas) || 0,
                    volumen: parseFloat(row.Volumen) || 0,
                    peso: parseFloat(row.Peso) || 0
                }];

                return {
                    fecha: row.Fecha || '',
                    unidad: row.Unidad || '',
                    economico: row.Econ√≥mico || '', // Nota: sin tilde
                    detallesLlantas: detallesLlantas,
                    descripcionCompleta: descripcionLlanta,
                    volumenTotal: parseFloat(row.Volumen) || 0,
                    pesoTotal: parseFloat(row.Peso) || 0
                };
            });

            console.log('Datos procesados:', pedidosApartados); // Para debugging
            actualizarTablaPedidosApartados();
            
        } catch (error) {
            console.error('Error al cargar datos desde SheetDB:', error);
        }
    }

    // Funci√≥n para formatear la descripci√≥n con vi√±etas
    function formatearDescripcionConVinetas(descripcion) {
        if (!descripcion) return '';
        // Dividir por coma y asegurarse de que cada elemento tenga el formato "X x Y"
        return descripcion.split(',')
            .map(item => item.trim())
            .filter(item => item && item.includes('x')) // Solo elementos v√°lidos que contengan "x"
            .map(item => `‚Ä¢ ${item}`)
            .join('<br>');
    }

    // Funci√≥n para buscar en pedidos Apartados
    function buscarPedidoConfirmado() {
        const busqueda = document.getElementById('busquedaApartados').value.toLowerCase();
        actualizarTablaPedidosApartados(busqueda);
    }

    // Funci√≥n para actualizar la tabla de pedidos Apartados
    function actualizarTablaPedidosApartados(filtro = '') {
        const tbody = document.getElementById('tablaPedidosApartados');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        if (!Array.isArray(pedidosApartados)) return;
        
        // Ordenar pedidos: primero los que coinciden con la b√∫squeda
        const pedidosOrdenados = [...pedidosApartados].sort((a, b) => {
            const aEconomico = (a['Econ√≥mico'] || '').toLowerCase();
            const bEconomico = (b['Econ√≥mico'] || '').toLowerCase();
            const aMatch = aEconomico.includes(filtro.toLowerCase());
            const bMatch = bEconomico.includes(filtro.toLowerCase());
            if (aMatch && !bMatch) return -1;
            if (!aMatch && bMatch) return 1;
            return new Date(b.Fecha || 0) - new Date(a.Fecha || 0); // ordenar por fecha si no hay coincidencia
        });
        
        console.log('Pedidos a mostrar:', pedidosOrdenados);
        
        pedidosOrdenados.forEach((pedido, index) => {
             // Asegurarse de que los campos existan y tengan el formato correcto
             let fecha = pedido.Fecha || '';
             if (!isNaN(fecha)) {
                 // Si la fecha es un n√∫mero, la convertimos a objeto Date y la formateamos
                 const fechaObj = new Date(fecha);
                 if (!isNaN(fechaObj.getTime())) {
                     fecha = obtenerFechaFormateada();
                 }
            }
            
            // Extraer todos los campos necesarios y asegurar que tengan valores v√°lidos
            const nombreUnidad = pedido.Unidad || pedido.unidad || 'KENWORTH';
            const numEconomico = pedido['Econ√≥mico'] || ''; // Usar la versi√≥n exacta con tilde
            const nombre = pedido.Nombre || '';
            const llantas = pedido.Llantas || '0';
            const descripcion = pedido.Descripcion || '';
            const volumen = pedido.Volumen || '0.00';
            const peso = pedido.Peso || '0.00';

            console.log('Procesando pedido:', {
                fecha,
                unidad: nombreUnidad, // Usar nombreUnidad en lugar de unidad
                numEconomico,
                nombre,
                llantas,
                descripcion,
                volumen,
                peso
            });

            // Formatear la descripci√≥n con vi√±etas si es necesario
            const descripcionFormateada = descripcion.includes('‚Ä¢') ? descripcion : formatearDescripcionConVinetas(descripcion);

            // Crear la fila de la tabla
            const tr = document.createElement('tr');
    
            // Crear la celda de descripci√≥n con estilo
            tr.innerHTML = `
                <td class="text-center">${fecha}</td>
                <td>${nombreUnidad}</td>
                <td class="text-center">${numEconomico}</td>
                <td>${nombre}</td>
                <td class="text-center">${llantas}</td>
                <td style="white-space: pre-line; line-height: 1.5;">${descripcionFormateada}</td>
                <td class="text-end">${volumen} m¬≥</td>
                <td class="text-end">${peso} kg</td>
                <td class="text-center">
                    <button class="btn btn-danger btn-sm" onclick="liberarUnidad(${index})">
                        <i class="bi bi-x-circle"></i> Liberar
                   </button>
              </td>
         `;
         tbody.appendChild(tr);
        });
    }

    // Funci√≥n para verificar si una unidad est√° apartada
    function estaUnidadApartada(economico) {
        return pedidosApartados.some(p => p.economico === economico);
    }

    // Funci√≥n para actualizar la tabla de llantas
    function actualizarTablaLlantas() {
        console.log('Actualizando tabla de llantas...');
        
        const tbody = document.querySelector('#tablaLlantasAgregadas tbody');
        const totalDiv = document.getElementById('totalLlantas');
        const resultadoDiv = document.getElementById('resultadoSugerencia');
        
        let volumenTotal = 0;
        let pesoTotal = 0;
        
        tbody.innerHTML = '';
        
        // Asegurar que el contenedor de resultado est√© visible
        if (resultadoDiv) {
            resultadoDiv.style.display = 'block';
        }
        
        llantasAgregadas.forEach((llanta, index) => {
            volumenTotal += llanta.volumen;
            pesoTotal += llanta.peso;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${llanta.descripcion}</td>
                <td>${llanta.cantidad}</td>
                <td>${llanta.volumen.toFixed(2)} m¬≥</td>
                <td>${llanta.peso.toFixed(2)} kg</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="eliminarTipoLlanta(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalDiv.innerHTML = `
            Total: ${llantasAgregadas.reduce((sum, l) => sum + l.cantidad, 0)} llantas | 
            Volumen: ${volumenTotal.toFixed(2)} m¬≥ | 
            Peso: ${pesoTotal.toFixed(2)} kg
        `;
    }

    // Funci√≥n para calcular la sugerencia de unidad
    async function calcularSugerenciaUnidad() {
        console.log('Iniciando c√°lculo de sugerencia...');
        
        // Si no hay llantas agregadas, no hacer nada
        if (llantasAgregadas.length === 0) {
            document.getElementById('resultadoSugerencia').classList.add('d-none');
            return;
        }

        // Inicializar elementos UI
        const contenedorResultado = document.getElementById('resultadoSugerencia');
        const contenedorDetalles = document.getElementById('unidadSugeridaDetalles');

        // Verificar que flota tenga datos
        if (!Array.isArray(flota) || flota.length === 0) {
            console.error('No hay unidades en la flota');
            contenedorResultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error: No hay unidades registradas en la flota.
                </div>
            `;
            contenedorResultado.classList.remove('d-none');
            return;
        }

        console.log('Total unidades en flota:', flota.length);
        console.log('Total pedidos Apartados:', pedidosApartados.length);

            // Filtrar las unidades que ya est√°n en pedidos Apartados
            const unidadesDisponibles = flota.filter(unidad => {
                // Verificar que la unidad tenga c√≥digo
                if (!unidad.codigo && !unidad.economico) {
                    console.warn('Unidad sin c√≥digo:', unidad);
                    return false;
                }

                // Verificar si la unidad est√° en pedidos apartados
                const estaApartada = window.pedidosApartados?.some(pedido => {
                    const pedidoEconomico = String(
                        pedido.Economico || 
                        pedido['Econ√≥mico'] || 
                        pedido.economico || 
                        ''
                    ).trim().toLowerCase();
                    const unidadEconomico = String(
                        unidad.economico || 
                        unidad.codigo || 
                        ''
                    ).trim().toLowerCase();
                    return pedidoEconomico === unidadEconomico;
                });

                if (estaApartada) {
                    console.log('Unidad excluida por estar apartada:', unidad.economico || unidad.codigo);
                    return false;
                }            // Normalizar el c√≥digo de la unidad (convertir a string y eliminar espacios)
            const codigoUnidad = String(unidad.codigo || unidad.economico).trim().toLowerCase();
            
            // Buscar si la unidad est√° en pedidos Apartados
            const yaEstaConfirmada = pedidosApartados.some(pedido => {
                // Normalizar el c√≥digo del pedido
                const pedidoEconomico = String(
                    pedido['Econ√≥mico'] || 
                    pedido.Economico || 
                    pedido.economico || 
                    pedido.econ√≥mico || 
                    pedido.codigo || 
                    ''
                ).trim().toLowerCase();
                
                const coincide = pedidoEconomico === codigoUnidad;
                if (coincide) {
                    console.log(`Unidad ${codigoUnidad} est√° en pedidos Apartados`);
                }
                return coincide;
            });
            
            if (!yaEstaConfirmada) {
                console.log('Unidad disponible:', codigoUnidad);
            }
            
            return !yaEstaConfirmada;
        });

        console.log('Unidades disponibles encontradas:', unidadesDisponibles.length);

        // Si no hay unidades disponibles o adecuadas, mostrar mensaje
        if (unidadesDisponibles.length === 0) {
            contenedorResultado.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>No hay unidades disponibles adecuadas</h5>
                    <p>Esto puede deberse a:</p>
                    <ul>
                        <li>Todas las unidades est√°n asignadas a otros pedidos</li>
                        <li>Las unidades disponibles no tienen suficiente capacidad para este pedido</li>
                        <li>El pedido requiere m√°s capacidad de la que tienen las unidades individuales</li>
                    </ul>
                    <p>Volumen necesario: ${volumenTotal.toFixed(2)} m¬≥</p>
                    <p>Peso necesario: ${pesoTotal.toFixed(2)} kg</p>
                </div>
            `;
            contenedorResultado.classList.remove('d-none');
            return;
        }

        // Funci√≥n auxiliar para distribuir carga de manera inteligente
        function distribuirCargaEnCamiones(volumenTotal, pesoTotal, camionesDisponibles) {
            if (!Array.isArray(camionesDisponibles)) {
                console.error('camionesDisponibles no es un array:', camionesDisponibles);
                return { distribucion: [], volumenRestante: volumenTotal, pesoRestante: pesoTotal };
            }

            // Filtrar camiones que ya est√°n en pedidosApartados
            camionesDisponibles = camionesDisponibles.filter(camion => {
                return !pedidosApartados.some(pedido => 
                    pedido.economico === camion.economico
                );
            });

            let distribucion = [];
            let volumenRestante = volumenTotal;
            let pesoRestante = pesoTotal;
            
            // Ordenamos los camiones priorizando unidades m√°s grandes y eficientes
            let camionesOrdenados = [...new Map(camionesDisponibles.map(item => [item.economico, item])).values()];
            
            // Ahora ordenamos los camiones √∫nicos
            camionesOrdenados.sort((a, b) => {
                // Si alguno puede llevar toda la carga, lo priorizamos
                const aLlevaTodo = a.volumenNum >= volumenTotal && a.capacidadCargaNum >= pesoTotal;
                const bLlevaTodo = b.volumenNum >= volumenTotal && b.capacidadCargaNum >= pesoTotal;
                
                if (aLlevaTodo !== bLlevaTodo) {
                    return aLlevaTodo ? -1 : 1;
                }
                
                // Calculamos el porcentaje que cada unidad puede llevar
                const capacidadVolumenA = Math.min(1, volumenTotal / a.volumenNum);
                const capacidadVolumenB = Math.min(1, volumenTotal / b.volumenNum);
                const capacidadPesoA = Math.min(1, pesoTotal / a.capacidadCargaNum);
                const capacidadPesoB = Math.min(1, pesoTotal / b.capacidadCargaNum);
                
                // Calculamos un puntaje basado en capacidad y eficiencia
                const puntajeA = Math.min(capacidadVolumenA, capacidadPesoA) * a.volumenNum;
                const puntajeB = Math.min(capacidadVolumenB, capacidadPesoB) * b.volumenNum;
                
                // Priorizamos unidades m√°s grandes
                return b.volumenNum - a.volumenNum;
            });
            
            while (volumenRestante > 0 || pesoRestante > 0) {
                let mejorCamion = null;
                let mejorEficiencia = 0;
                let mejorCombinacion = null;
                
                // Primera pasada: intentar encontrar un cami√≥n que pueda llevar toda o la mayor√≠a de la carga
                for (const camion of camionesOrdenados) {
                    const volumenPosible = Math.min(volumenRestante, camion.volumenNum);
                    const pesoPosible = Math.min(pesoRestante, camion.capacidadCargaNum);
                    
                    // Verificar si este cami√≥n puede llevar una parte significativa
                    const porcentajeVolumen = volumenPosible / volumenRestante;
                    const porcentajePeso = pesoPosible / pesoRestante;
                    const porcentajeTotal = Math.min(porcentajeVolumen, porcentajePeso);
                    
                    // Si puede llevar al menos el 70% de la carga restante, lo consideramos
                    if (porcentajeTotal >= 0.7) {
                        const eficienciaVolumen = volumenPosible / camion.volumenNum;
                        const eficienciaPeso = pesoPosible / camion.capacidadCargaNum;
                        const eficienciaPromedio = (eficienciaVolumen + eficienciaPeso) / 2;
                        
                        // Aceptamos si la eficiencia es mayor al 40% (m√°s permisivo)
                        if (eficienciaPromedio > 0.4) {
                            mejorCamion = {
                                ...camion,
                                volumenAsignado: volumenPosible,
                                pesoAsignado: pesoPosible,
                                eficiencia: eficienciaPromedio * 100
                            };
                            break;
                        }
                    }
                }
                
                // Si no encontramos un cami√≥n ideal, buscamos la mejor combinaci√≥n
                if (!mejorCamion) {
                    for (const camion of camionesOrdenados) {
                        const volumenPosible = Math.min(volumenRestante, camion.volumenNum);
                        const pesoPosible = Math.min(pesoRestante, camion.capacidadCargaNum);
                        const eficienciaVolumen = volumenPosible / camion.volumenNum;
                        const eficienciaPeso = pesoPosible / camion.capacidadCargaNum;
                        const eficienciaPromedio = (eficienciaVolumen + eficienciaPeso) / 2;
                        
                        // Si es m√°s eficiente que lo que ten√≠amos antes
                        if (eficienciaPromedio > mejorEficiencia) {
                            mejorEficiencia = eficienciaPromedio;
                            mejorCamion = {
                                ...camion,
                                volumenAsignado: volumenPosible,
                                pesoAsignado: pesoPosible,
                                eficiencia: eficienciaPromedio * 100,
                                esParcial: true // Marcamos que este cami√≥n llevar√° carga parcial
                            };
                        }
                    }
                }
                
                if (!mejorCamion) break;
                
                distribucion.push(mejorCamion);
                volumenRestante -= mejorCamion.volumenAsignado;
                pesoRestante -= mejorCamion.pesoAsignado;
            }
            
            // Calcular estad√≠sticas de la distribuci√≥n
            const estadisticas = {
                numUnidades: distribucion.length,
                eficienciaPromedio: distribucion.reduce((sum, c) => sum + c.eficiencia, 0) / distribucion.length,
                volumenTotalUtilizado: distribucion.reduce((sum, c) => sum + c.volumenAsignado, 0),
                pesoTotalUtilizado: distribucion.reduce((sum, c) => sum + c.pesoAsignado, 0)
            };

            return {
                distribucion,
                volumenRestante,
                pesoRestante,
                estadisticas
            };
        }

        if (!contenedorResultado || !contenedorDetalles) {
            console.error('No se encontraron los contenedores de resultado');
            return;
        }

        // Asegurarnos de que el contenedor de resultado est√© visible
        contenedorResultado.classList.remove('d-none');
        contenedorDetalles.innerHTML = '<div class="alert alert-info">Calculando sugerencias...</div>';

        if (llantasAgregadas.length === 0) {
            contenedorDetalles.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Agregue llantas para ver sugerencias de unidades</h6>
                    <p>Use el formulario superior para agregar llantas al c√°lculo.</p>
                </div>`;
            return;
        }

        // Mostrar el spinner mientras se calcula
        contenedorDetalles.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Calculando...</span>
                    </div>
                    <span>Calculando la mejor distribuci√≥n de unidades...</span>
                </div>
            </div>`;

        // Calcular totales de todas las llantas agregadas
        const volumenTotal = llantasAgregadas.reduce((sum, llanta) => sum + llanta.volumen, 0);
        const pesoTotal = llantasAgregadas.reduce((sum, llanta) => sum + llanta.peso, 0);
        const cantidadTotalLlantas = llantasAgregadas.reduce((sum, llanta) => sum + llanta.cantidad, 0);

        // Procesar todos los camiones disponibles
        let camionesDisponibles = flota
            .filter(camion => {
                try {
                    // Primero verificar si est√° en pedidos Apartados
                    const codigoUnidad = String(camion.codigo || camion.economico).trim().toLowerCase();
                    const estaConfirmada = pedidosApartados.some(pedido => {
                        const pedidoEconomico = String(
                            pedido['Econ√≥mico'] || 
                            pedido.Economico || 
                            pedido.economico || 
                            pedido.econ√≥mico || 
                            pedido.codigo || 
                            ''
                        ).trim().toLowerCase();
                        return pedidoEconomico === codigoUnidad;
                    });

                    if (estaConfirmada) {
                        console.log('Unidad excluida por estar confirmada:', codigoUnidad);
                        return false;
                    }

                    // Verificar si la unidad tiene suficiente capacidad para el pedido
                    const volumenUnidad = parseFloat(camion.volumen || '0');
                    if (volumenUnidad < volumenTotal) {
                        console.log('Unidad excluida por capacidad insuficiente:', codigoUnidad, 
                            'Capacidad:', volumenUnidad.toFixed(2), 'm¬≥',
                            'Necesario:', volumenTotal.toFixed(2), 'm¬≥');
                        return false;
                    }

                    // Verificar que el cami√≥n tenga datos v√°lidos
                    if (!camion.volumen || !camion["capacidad de carga (kg)"]) {
                        console.log('Cami√≥n sin datos completos:', camion);
                        return false;
                    }
                    
                    // Convertir a n√∫meros y validar
                    const volumenCamion = parseFloat(camion.volumen);
                    const capacidadCarga = parseFloat(camion["capacidad de carga (kg)"]);
                    
                    // Verificar que los valores sean v√°lidos
                    if (isNaN(volumenCamion) || isNaN(capacidadCarga) || 
                        volumenCamion <= 0 || capacidadCarga <= 0) {
                        console.log('Cami√≥n con datos inv√°lidos:', camion);
                        return false;
                    }
                    
                    // Guardar los valores num√©ricos en el objeto para uso posterior
                    camion.volumenNum = volumenCamion;
                    camion.capacidadCargaNum = capacidadCarga;
                    
                    // Verificar si el cami√≥n puede manejar al menos el 70% del pedido
                    const puedeVolumen = volumenCamion >= volumenTotal * 0.7;
                    const puedePeso = capacidadCarga >= pesoTotal * 0.7;
                    const esViable = puedeVolumen && puedePeso;
                    
                    if (esViable) {
                        console.log('Cami√≥n viable:', camion.economico, 
                            'Capacidad:', volumenCamion.toFixed(2), 'm¬≥,', 
                            capacidadCarga.toFixed(2), 'kg',
                            'Puede manejar:', 
                            (volumenCamion/volumenTotal*100).toFixed(1) + '% del volumen,',
                            (capacidadCarga/pesoTotal*100).toFixed(1) + '% del peso');
                    } else {
                        console.log('Cami√≥n descartado por capacidad insuficiente:', camion.economico);
                    }
                    
                    return esViable;
                } catch (error) {
                    console.error('Error al procesar cami√≥n:', camion, error);
                    return false;
                }
            })
            .map(camion => {
                // Calcular los porcentajes correctamente (volumen usado / capacidad total)
                const porcentajeVolumen = Math.min((volumenTotal / camion.volumenNum) * 100, 100);
                const porcentajePeso = Math.min((pesoTotal / camion.capacidadCargaNum) * 100, 100);
                const utilizacionPromedio = Math.min((porcentajeVolumen + porcentajePeso) / 2, 100);
                
                console.log(`Unidad ${camion.economico}: Vol ${porcentajeVolumen.toFixed(1)}%, Peso ${porcentajePeso.toFixed(1)}%, Promedio ${utilizacionPromedio.toFixed(1)}%`);
                
                return {
                    ...camion,
                    porcentajeVolumen,
                    porcentajePeso,
                    utilizacionPromedio
                };
            });

        // Calcular la distribuci√≥n √≥ptima de camiones usando solo unidades disponibles
        const distribucion = distribuirCargaEnCamiones(volumenTotal, pesoTotal, camionesDisponibles);

        if (distribucion.distribucion.length === 0) {
            // Ordenar unidades priorizando las m√°s grandes y eficientes
            let unidadesOrdenadas = [...unidadesDisponibles]
                .map(unidad => {
                    // Calcular capacidad y eficiencia potencial
                    const capacidadTotal = unidad.volumenNum + unidad.capacidadCargaNum;
                    const eficienciaPotencial = Math.min(
                        unidad.volumenNum / Math.max(volumenTotal / 2, 1), 
                        unidad.capacidadCargaNum / Math.max(pesoTotal / 2, 1)
                    );
                    // Penalizar unidades muy peque√±as
                    const penalizacionTama√±o = unidad.volumenNum < volumenTotal / 4 ? 0.5 : 1;
                    
                    return {
                        ...unidad,
                        capacidadTotal,
                        puntuacion: capacidadTotal * eficienciaPotencial * penalizacionTama√±o
                    };
                })
                .sort((a, b) => b.puntuacion - a.puntuacion);

            console.log('Iniciando distribuci√≥n con unidades √∫nicas:', 
                unidadesOrdenadas.map(u => u.economico).join(', '));
            
            // Obtener unidades confirmadas
            const unidadesConfirmadas = new Set(pedidosApartados.map(pedido => 
                String(pedido['Econ√≥mico'] || pedido.Economico || pedido.economico || pedido.c√≥digo || '').trim().toLowerCase()
            ));
            
            console.log('Unidades confirmadas antes de filtrar:', Array.from(unidadesConfirmadas));

            // Filtrar unidades que ya est√°n confirmadas
            const unidadesDisponiblesOriginales = unidadesOrdenadas.length;
            unidadesOrdenadas = unidadesOrdenadas.filter(unidad => {
                const codigoUnidad = String(unidad.economico || '').trim().toLowerCase();
                const estaConfirmada = unidadesConfirmadas.has(codigoUnidad);
                if (estaConfirmada) {
                    console.log(`Unidad ${codigoUnidad} excluida por estar confirmada`);
                }
                return !estaConfirmada;
            });
            
            console.log('Unidades filtradas:', {
                antes: unidadesDisponiblesOriginales,
                despues: unidadesOrdenadas.length,
                eliminadas: unidadesDisponiblesOriginales - unidadesOrdenadas.length
            });

            let distribucionMultiple = [];
            let volumenRestante = volumenTotal;
            let pesoRestante = pesoTotal;
            let llantasRestantes = cantidadTotalLlantas;
            
            // Ordenar unidades disponibles por capacidad de volumen (de mayor a menor)
            unidadesOrdenadas.sort((a, b) => {
                const volumenA = parseFloat(a.volumen || a.capacidadVolumen || '0');
                const volumenB = parseFloat(b.volumen || b.capacidadVolumen || '0');
                return volumenB - volumenA;  // Orden descendente
            });

            console.log('Unidades ordenadas por capacidad:', 
                unidadesOrdenadas.map(u => ({
                    economico: u.economico,
                    volumen: parseFloat(u.volumen || u.capacidadVolumen || '0').toFixed(2) + ' m¬≥'
                }))
            );
            
            // Constantes para c√°lculos
            const PESO_POR_LLANTA = 7.80; // kg por llanta
            console.log('Iniciando distribuci√≥n:', {
                volumenTotal: volumenTotal.toFixed(2) + ' m¬≥',
                pesoTotal: pesoTotal.toFixed(2) + ' kg',
                totalLlantas: cantidadTotalLlantas,
                pesoPorLlanta: PESO_POR_LLANTA + ' kg'
            });
            let unidadesUsadas = new Set(); // Para rastrear unidades ya utilizadas

            for (const unidad of unidadesOrdenadas) {
                // Verificar si la unidad ya fue usada
                if (unidadesUsadas.has(unidad.economico)) {
                    console.log('Unidad ya utilizada, saltando:', unidad.economico);
                    continue;
                }

                // Si ya no hay carga por distribuir, salimos del ciclo
                if (volumenRestante <= 0.01 && pesoRestante <= 0.01) {
                    console.log('No hay m√°s carga por distribuir');
                    break;
                }

                const volumenUnidad = parseFloat(unidad.volumen);
                const pesoUnidad = parseFloat(unidad["capacidad de carga (kg)"]);
                
                console.log('Evaluando unidad:', unidad.economico);
                console.log('Capacidad:', { volumen: volumenUnidad, peso: pesoUnidad });
                console.log('Restante:', { volumen: volumenRestante, peso: pesoRestante });

                // Calcular la capacidad disponible y necesaria
                const capacidadVolumenDisponible = volumenUnidad;
                const capacidadPesoDisponible = pesoUnidad;
                
                // Calcular cu√°nto puede llevar esta unidad
                let volumenAsignable, pesoAsignable;
                
                // Calcular el porcentaje que esta unidad podr√≠a llevar del total
                const porcentajeVolumenPosible = (volumenUnidad / volumenTotal) * 100;
                const porcentajePesoPosible = (pesoUnidad / pesoTotal) * 100;
                
                console.log('Porcentajes posibles:', {
                    volumen: porcentajeVolumenPosible.toFixed(1) + '%',
                    peso: porcentajePesoPosible.toFixed(1) + '%'
                });

                // Si es la primera unidad, intentar maximizar su uso
                if (distribucionMultiple.length === 0) {
                    // Asignar el m√°ximo posible a la primera unidad
                    volumenAsignable = Math.min(volumenRestante, volumenUnidad);
                    pesoAsignable = Math.min(pesoRestante, pesoUnidad);
                } else {
                    // Para unidades auxiliares, intentar aprovechar al m√°ximo su capacidad
                    // siempre que quede suficiente carga para justificar su uso
                    const cargaRestanteSignificativa = volumenRestante > volumenUnidad * 0.2 ||
                                                      pesoRestante > pesoUnidad * 0.2;
                    
                    if (cargaRestanteSignificativa) {
                        // Asignar tanto como sea posible a la unidad auxiliar
                        volumenAsignable = Math.min(volumenRestante, volumenUnidad);
                        pesoAsignable = Math.min(pesoRestante, pesoUnidad);
                        
                        console.log('Asignando carga significativa a unidad auxiliar:', {
                            volumen: volumenAsignable.toFixed(2) + ' m¬≥',
                            peso: pesoAsignable.toFixed(2) + ' kg'
                        });
                    } else {
                        // Si queda muy poca carga, asignar solo lo restante
                        volumenAsignable = volumenRestante;
                        pesoAsignable = pesoRestante;
                    }
                }

                // Calcular la eficiencia de uso de la unidad
                const eficienciaVolumen = (volumenAsignable / volumenUnidad) * 100;
                const eficienciaPeso = (pesoAsignable / pesoUnidad) * 100;
                const porcentajeCapacidad = Math.min(eficienciaVolumen, eficienciaPeso);

                console.log('An√°lisis de eficiencia:', {
                    volumen: eficienciaVolumen.toFixed(1) + '%',
                    peso: eficienciaPeso.toFixed(1) + '%',
                    total: porcentajeCapacidad.toFixed(1) + '%'
                });

                // Evaluaci√≥n m√°s flexible para cargas grandes
                const cargaTotal = volumenTotal;
                const cargaRestante = volumenRestante;
                const esUnidadPrincipal = distribucionMultiple.length === 0;
                
                // Calcular qu√© tan grande es la carga total y restante
                const esCargaGrande = volumenTotal > 50; // m√°s de 50m¬≥ se considera carga grande
                const porcentajeRestante = (volumenRestante / volumenTotal) * 100;
                
                console.log('An√°lisis de carga:', {
                    cargaTotal: volumenTotal.toFixed(2) + ' m¬≥',
                    cargaRestante: volumenRestante.toFixed(2) + ' m¬≥',
                    porcentajeRestante: porcentajeRestante.toFixed(1) + '%',
                    esCargaGrande
                });

                // Umbrales m√°s flexibles para cargas grandes
                let umbralMinimo;
                if (esUnidadPrincipal) {
                    umbralMinimo = 30; // M√°s permisivo con la primera unidad
                } else if (esCargaGrande) {
                    // Para cargas grandes, ser m√°s permisivo con unidades auxiliares
                    umbralMinimo = Math.min(
                        5, // m√≠nimo absoluto
                        Math.max(1, porcentajeRestante / 4) // m√°s permisivo cuanto m√°s carga queda
                    );
                } else {
                    // Para cargas normales
                    umbralMinimo = Math.min(
                        15, // m√≠nimo normal
                        Math.max(5, porcentajeRestante / 3));
                
                // Verificar nuevamente que la unidad no est√© confirmada
                const codigoUnidad = String(unidad.economico || '').trim().toLowerCase();
                if (unidadesConfirmadas.has(codigoUnidad)) {
                    console.log(`Saltando unidad ${codigoUnidad} - est√° confirmada`);
                    continue; // Saltar esta unidad
                }
                    
                }

                console.log('Evaluaci√≥n de umbral:', {
                    umbralMinimo: umbralMinimo.toFixed(1) + '%',
                    porcentajeCapacidad: porcentajeCapacidad.toFixed(1) + '%',
                    supera: porcentajeCapacidad > umbralMinimo ? 'S√≠' : 'No'
                });

                const deberiaUsarUnidad = porcentajeCapacidad > umbralMinimo || 
                                        (esCargaGrande && volumenRestante > volumenUnidad * 0.1);

                if (deberiaUsarUnidad) {
                    // Calcular llantas basado en proporci√≥n de volumen
                    const llantasAsignadas = Math.floor(llantasRestantes * (volumenAsignable / volumenRestante));
                    
                    // Calcular peso real basado en n√∫mero de llantas
                    const pesoRealAsignado = llantasAsignadas * PESO_POR_LLANTA;
                    
                    // Calcular eficiencias reales
                    const eficienciaVolumenReal = (volumenAsignable / volumenUnidad) * 100;
                    const eficienciaPesoReal = (pesoRealAsignado / pesoUnidad) * 100;
                    const eficienciaReal = (eficienciaVolumenReal + eficienciaPesoReal) / 2;
                    
                    console.log('Asignando a unidad:', {
                        economico: unidad.economico,
                        volumen: volumenAsignable.toFixed(2) + ' m¬≥',
                        peso: pesoRealAsignado.toFixed(2) + ' kg',
                        llantas: llantasAsignadas,
                        eficienciaVolumen: eficienciaVolumenReal.toFixed(1) + '%',
                        eficienciaPeso: eficienciaPesoReal.toFixed(1) + '%',
                        eficienciaTotal: eficienciaReal.toFixed(1) + '%'
                    });

                    distribucionMultiple.push({
                        ...unidad,
                        volumenAsignado: volumenAsignable,
                        pesoAsignado: pesoRealAsignado,
                        eficiencia: eficienciaReal,
                        llantasEstimadas: llantasAsignadas
                    });

                    // Marcar la unidad como usada
                    unidadesUsadas.add(unidad.economico);
                    
                    volumenRestante -= volumenAsignable;
                    pesoRestante -= pesoAsignable;
                    llantasRestantes -= llantasAsignadas;
                }
            }

            // Filtrar solo unidades con datos completos
            const unidadesValidas = distribucionMultiple.filter(unidad => 
                unidad.llantasEstimadas > 0 && 
                unidad.volumenAsignado > 0 && 
                unidad.pesoAsignado > 0 && 
                !isNaN(unidad.eficiencia) &&
                unidad.eficiencia > 0
            );

            if (unidadesValidas.length > 0) {
                // Mostrar sugerencia de m√∫ltiples unidades
                contenedorDetalles.innerHTML = `
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> Distribuci√≥n Sugerida del Pedido</h5>
                        <p>Este pedido requiere distribuci√≥n en ${unidadesValidas.length} unidades para √≥ptimo manejo:</p>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Unidad</th>
                                        <th>Econ√≥mico</th>
                                        <th>Llantas Est.</th>
                                        <th>Volumen</th>
                                        <th>Peso</th>
                                        <th>Eficiencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${unidadesValidas.map(unidad => `
                                        <tr>
                                            <td>${unidad.unidad}</td>
                                            <td>${unidad.economico}</td>
                                            <td>${unidad.llantasEstimadas}</td>
                                            <td>${unidad.volumenAsignado.toFixed(2)} m¬≥</td>
                                            <td>${unidad.pesoAsignado.toFixed(2)} kg</td>
                                            <td>${unidad.eficiencia.toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-center mt-3">
                            <button class="btn btn-warning btn-lg" onclick="apartarDistribucionCompleta(this)" data-unidades='${JSON.stringify(unidadesValidas)}'>
                                <i class="bi bi-box-arrow-right"></i> Apartar Distribuci√≥n Completa
                            </button>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-info-circle"></i> Al apartar la distribuci√≥n, se reservar√°n todas las unidades mostradas para este pedido.
                        </div>
                    </div>
                `;
                return;
            }

            // Si no se pudo encontrar una distribuci√≥n, mostrar mensaje de error
            contenedorDetalles.innerHTML = `
                <div class="alert alert-warning">
                    <h5><i class="bi bi-exclamation-triangle"></i> No hay suficientes unidades disponibles</h5>
                    <p>La carga total es demasiado grande para las unidades disponibles:</p>
                    <ul>
                        <li>Volumen total: ${volumenTotal.toFixed(2)} m¬≥</li>
                        <li>Peso total: ${pesoTotal.toFixed(2)} kg</li>
                        <li>Cantidad de llantas: ${cantidadTotalLlantas}</li>
                    </ul>
                </div>
            `;
            return;
        }

        // Preparar la visualizaci√≥n de resultados
        console.log('Camiones en distribuci√≥n:', distribucion.distribucion.length);
        console.log('Volumen total:', volumenTotal, 'm¬≥');
        console.log('Peso total:', pesoTotal, 'kg');

        let html = `
            <div class="alert alert-primary mb-3">
                <h5>Resumen de Carga Total:</h5>
                <ul>
                    ${llantasAgregadas.map(llanta => 
                        `<li>${llanta.cantidad} llantas ${llanta.descripcion}</li>`
                    ).join('')}
                    <li><strong>Volumen total de carga:</strong> ${volumenTotal.toFixed(2)} m¬≥</li>
                    <li><strong>Peso total de carga:</strong> ${pesoTotal.toFixed(2)} kg</li>
                    <li><strong>Total de llantas:</strong> ${cantidadTotalLlantas}</li>
                </ul>
            </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Unidad</th>
                                <th>Econ√≥mico</th>
                                <th>Capacidad Volumen</th>
                                <th>Capacidad Peso</th>
                                <th>Uso Volumen</th>
                                <th>Uso Peso</th>
                                <th>Eficiencia</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>`;

            // Ordenar camiones por eficiencia (del m√°s eficiente al menos eficiente)
            const camionesViables = camionesDisponibles.sort((a, b) => b.utilizacionPromedio - a.utilizacionPromedio);

            // Agregar clase para resaltar el mejor cami√≥n
            camionesViables.forEach((camion, index) => {
                const rowClass = index === 0 ? 'table-success' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${camion.unidad || 'Sin nombre'}</td>
                        <td>${camion.economico}</td>
                        <td>${parseFloat(camion.volumen).toFixed(2)} m¬≥</td>
                        <td>${parseFloat(camion["capacidad de carga (kg)"]).toFixed(0)} kg</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" 
                                     role="progressbar" 
                                     style="width: ${camion.porcentajeVolumen}%;"
                                     title="${camion.porcentajeVolumen.toFixed(1)}%">
                                    ${camion.porcentajeVolumen.toFixed(1)}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-warning" 
                                     role="progressbar" 
                                     style="width: ${camion.porcentajePeso}%;"
                                     title="${camion.porcentajePeso.toFixed(1)}%">
                                    ${camion.porcentajePeso.toFixed(1)}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: ${camion.utilizacionPromedio}%;"
                                     title="${camion.utilizacionPromedio.toFixed(1)}%">
                                    ${camion.utilizacionPromedio.toFixed(1)}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="apartarUnidadConDetalles('${camion.economico}', llantasAgregadas, ${volumenTotal}, ${pesoTotal})">
                                <i class="bi bi-box-arrow-right"></i> Apartar
                            </button>
                        </td>
                    </tr>`;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Informaci√≥n:</h6>
                    <ul>
                        <li>La fila resaltada en verde indica la unidad m√°s eficiente</li>
                        <li>La eficiencia se calcula considerando el uso balanceado de volumen y peso</li>
                        <li>Todas las unidades mostradas pueden transportar la carga de forma segura</li>
                    </ul>
                </div>`;

            // Actualizar el contenido
            contenedorDetalles.innerHTML = html;

            // Si hay m√°s opciones viables, mostrarlas
            if (distribucion.distribucion.length > 1) {
                html += `
                    <div class="alert alert-info mt-3">
                        <h6>Resumen de distribuci√≥n:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Unidad</th>
                                        <th>Eficiencia</th>
                                        <th>Volumen</th>
                                        <th>Peso</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                // Mostrar resumen de todas las unidades asignadas
                distribucion.distribucion.forEach(camion => {
                    html += `
                        <tr>
                            <td>${camion.unidad || camion.economico}</td>
                            <td>${camion.eficiencia.toFixed(1)}%</td>
                            <td>${(camion.volumenAsignado/camion.volumenNum*100).toFixed(1)}%</td>
                            <td>${(camion.pesoAsignado/camion.capacidadCargaNum*100).toFixed(1)}%</td>
                        </tr>`;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }

            detallesDiv.innerHTML = html;
        
            contenedorDetalles.innerHTML = `
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle"></i> No se encontr√≥ un cami√≥n adecuado para la carga especificada.</h6>
                    
                    <div class="card mt-3">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0">Detalles de la Carga</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Llantas:</h6>
                                    <ul>
                                        ${llantasAgregadas.map(llanta => 
                                            `<li>${llanta.cantidad} llantas tipo ${llanta.tipoTexto}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Totales:</h6>
                                    <ul>
                                        <li><strong>Volumen requerido:</strong> ${volumenTotal.toFixed(2)} m¬≥</li>
                                        <li><strong>Peso requerido:</strong> ${pesoTotal.toFixed(2)} kg</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">An√°lisis y Sugerencias</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Problema</th>
                                            <th>Sugerencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Exceso de volumen o peso</td>
                                            <td>Dividir la carga en m√∫ltiples unidades m√°s peque√±as</td>
                                        </tr>
                                        <tr>
                                            <td>Capacidad insuficiente</td>
                                            <td>Verificar disponibilidad de unidades m√°s grandes</td>
                                        </tr>
                                        <tr>
                                            <td>Datos incorrectos</td>
                                            <td>Revisar si las cantidades ingresadas son correctas</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
    

    function limpiarFormularioFlota() {
        document.getElementById('agregarEconomico').value = '';
        document.getElementById('agregarUnidad').value = '';
        document.getElementById('agregarAsignado').value = '';
        document.getElementById('agregarModelo').value = '';
        document.getElementById('agregarPlacas').value = '';
        document.getElementById('agregarUbicacion').value = '';
        document.getElementById('agregarCarga').value = '';
        document.getElementById('agregarVolumenCamion').value = '';
    }

    // ---------- Pedidos (igual que antes) ----------
    function llenarDatosCamionPedido() {
        const numEco = document.getElementById('inputPedidoNumEconomico').value.trim();
        const div = document.getElementById('datosCamionPedido');
        pedidoCamion = flota.find(c => c.economico.toString() === numEco);
        if (pedidoCamion) {
          // Asegurar que el n√∫mero econ√≥mico se guarde correctamente en todas las propiedades necesarias
          pedidoCamion.numeroEconomico = numEco;
          pedidoCamion.economico = numEco; // Asegurarnos que economico tambi√©n tenga el valor
          const responsable = pedidoCamion.asignado || pedidoCamion.encargado || '-';
          div.innerText = `Cami√≥n: ${pedidoCamion.unidad}, Num. Econ√≥mico: ${numEco}, Asignado: ${responsable}, Modelo: ${pedidoCamion.modelo}, Capacidad carga: ${pedidoCamion["capacidad de carga (kg)"] || '-'} kg, Cap. volumen: ${pedidoCamion["volumen"] || '-'} m¬≥`;
            renderPedidosActuales();
            actualizarGraficas();
        } else {
            div.innerText = 'Cami√≥n no encontrado.';
            pedidosEnCurso = [];
            renderPedidosActuales();
            actualizarGraficas();
        }
    }
    function autoCompletarLlantaPedidoPorCodigo() {
        const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
        const llanta = inventario.find(item => item.clave.toString() === codigo);
        if (llanta) {
            document.getElementById('pedidoDescripcionLlantaInput').value = llanta.descripcion;
            document.getElementById('pedidoLineaLlanta').innerText = llanta.linea || '';
            document.getElementById('pedidoCantidadLlanta').value = 1;
            document.getElementById('pedidoPesoLlanta').innerText = Number(llanta.peso).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('pedidoVolumenLlanta').innerText = Number(llanta.volumen).toLocaleString('es-MX', {minimumFractionDigits: 3, maximumFractionDigits: 3});
            document.getElementById('pedidoValorUnitarioLlanta').innerText = Number(llanta.valor).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}); 
        } else {
             document.getElementById('pedidoDescripcionLlantaInput').value = '';
             document.getElementById('pedidoLineaLlanta').innerText = '';
             document.getElementById('pedidoPesoLlanta').innerText = '0';
             document.getElementById('pedidoVolumenLlanta').innerText = '0';
             document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
        }
    }
    function autoCompletarLlantaPedidoPorDescripcion() {
        const descripcion = document.getElementById('pedidoDescripcionLlantaInput').value.trim().toLowerCase();
        const llanta = inventario.find(item => item.descripcion.toLowerCase() === descripcion);
        if (llanta) {
            document.getElementById('pedidoCodigoLlanta').value = llanta.clave;
            document.getElementById('pedidoLineaLlanta').innerText = llanta.linea || '';
            document.getElementById('pedidoCantidadLlanta').value = 1;
            document.getElementById('pedidoPesoLlanta').innerText = Number(llanta.peso).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('pedidoVolumenLlanta').innerText = Number(llanta.volumen).toLocaleString('es-MX', {minimumFractionDigits: 3, maximumFractionDigits: 3});
            document.getElementById('pedidoValorUnitarioLlanta').innerText = Number(llanta.valor).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}); 
        } else {
             document.getElementById('pedidoDescripcionLlantaInput').value = '';
             document.getElementById('pedidoLineaLlanta').innerText = '';
             document.getElementById('pedidoPesoLlanta').innerText = '0';
             document.getElementById('pedidoVolumenLlanta').innerText = '0';
             document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
        }
    }
    function calcularTotalesPedido() {
    const cantidad = Number(document.getElementById('pedidoCantidadLlanta').value);
    const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
    const llanta = inventario.find(item => item.clave.toString() === codigo);
    
    if (llanta && cantidad > 0) {
        // Calcular totales
        document.getElementById('pedidoPesoLlanta').innerText = 
            (safeNum(llanta.peso) * cantidad).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('pedidoVolumenLlanta').innerText = 
            (safeNum(llanta.volumen) * cantidad).toLocaleString('es-MX', {minimumFractionDigits: 4, maximumFractionDigits: 4});
        document.getElementById('pedidoValorUnitarioLlanta').innerText = 
            (safeNum(llanta.valor) * cantidad).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Verificar capacidad preventivamente
        if (pedidoCamion) {
            const volumenTotal = safeNum(llanta.volumen) * cantidad;
            const pesoTotal = safeNum(llanta.peso) * cantidad;
            
            // Calcular totales actuales del pedido
            const pedidoActualVolumen = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.volumen), 0);
            const pedidoActualPeso = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.peso), 0);
            
            // Calcular nuevos totales incluyendo la llanta actual
            const nuevoVolumenTotal = pedidoActualVolumen + volumenTotal;
            const nuevoPesoTotal = pedidoActualPeso + pesoTotal;
            
            // Obtener capacidades del cami√≥n
            const capacidadVolumen = safeNum(pedidoCamion.volumen);
            const capacidadPeso = safeNum(pedidoCamion["capacidad de carga (kg)"]) || safeNum(pedidoCamion.carga);
            
            // Calcular porcentajes
            const porcentajeVolumen = (nuevoVolumenTotal / capacidadVolumen) * 100;
            const porcentajePeso = (nuevoPesoTotal / capacidadPeso) * 100;
            
            // Mostrar advertencia si supera el 95%
            if (porcentajeVolumen > 95 || porcentajePeso > 95) {
                mostrarAlertaCapacidad(
                    capacidadVolumen - nuevoVolumenTotal,
                    capacidadPeso - nuevoPesoTotal,
                    porcentajeVolumen,
                    porcentajePeso
                );
            }
        }
    }
}
function agregarPedido() {
    if (!pedidoCamion) {
        alert("Ingrese un n√∫mero econ√≥mico v√°lido de cami√≥n primero.");
        return;
    }

    const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
    const cantidad = Number(document.getElementById('pedidoCantidadLlanta').value);
    
    if (cantidad <= 0) {
        alert("La cantidad debe ser mayor a 0.");
        return;
    }

    const llanta = inventario.find(item => item.clave.toString() === codigo);
    if (!llanta) {
        alert("Llanta no encontrada en inventario.");
        return;
    }

    // Calcular volumen y peso adicional
    const volumenAdicional = safeNum(llanta.volumen) * cantidad;
    const pesoAdicional = safeNum(llanta.peso) * cantidad;
    
    // Calcular totales actuales
    const totalVolumenActual = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.volumen), 0);
    const totalPesoActual = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.peso), 0);
    
    // Calcular nuevos totales
    const nuevoVolumenTotal = totalVolumenActual + volumenAdicional;
    const nuevoPesoTotal = totalPesoActual + pesoAdicional;
    
    // Obtener capacidades del cami√≥n
    const capacidadVolumen = safeNum(pedidoCamion.volumen);
    const capacidadPeso = safeNum(pedidoCamion["capacidad de carga (kg)"]) || safeNum(pedidoCamion.carga);
    
    // Calcular porcentajes
    const porcentajeVolumen = (nuevoVolumenTotal / capacidadVolumen) * 100;
    const porcentajePeso = (nuevoPesoTotal / capacidadPeso) * 100;

    // Agregar al pedido
    const pedidoExistente = pedidosEnCurso.find(p => p.clave === llanta.clave);
    if (pedidoExistente) {
        pedidoExistente.cantidad += cantidad;
        pedidoExistente.peso = safeNum(getField(llanta,'peso')) * pedidoExistente.cantidad;
        pedidoExistente.volumen = safeNum(getField(llanta,'volumen')) * pedidoExistente.cantidad;
        pedidoExistente.valor = safeNum(getField(llanta,'valor')) * pedidoExistente.cantidad;
    } else {
        pedidosEnCurso.push({
            clave: llanta.clave,
            descripcion: llanta.descripcion,
            linea: llanta.linea || '',
            cantidad: cantidad,
            peso: safeNum(getField(llanta,'peso')) * cantidad,
            volumen: safeNum(getField(llanta,'volumen')) * cantidad,
            valor: safeNum(getField(llanta,'valor')) * cantidad
        });
    }

    // Mostrar alerta de resumen inmediatamente
    mostrarAlertaCapacidad(
        capacidadVolumen - nuevoVolumenTotal,
        capacidadPeso - nuevoPesoTotal,
        porcentajeVolumen,
        porcentajePeso
    );

    renderPedidosActuales();
    actualizarGraficas();
    resetPedidoInputs();
}
// Modificar la funci√≥n reservarPedidoActual()
// Reemplazar o agregar esta funci√≥n
async function reservarPedidoActual(idx) {
    const pedido = pedidosEnCurso[idx];
    if (!pedido) return;

    try {
        // Buscar primero si el producto pertenece a alg√∫n bloque existente
        const bloqueExistente = bloquesFacturas.find(bloque => 
            bloque.datos.some(p => 
                p.C√≥digo === pedido.clave && 
                p.Descripci√≥n === pedido.descripcion
            )
        );

        let nombreReserva;
        if (bloqueExistente) {
            // Si pertenece a un bloque, usar el nombre del bloque
            nombreReserva = `${bloqueExistente.nombre}_1`;
        } else {
            // Si no pertenece a ning√∫n bloque, usar el nombre del folio o factura
            const facturaRelacionada = facturasParaGuardar.find(f => 
                f.C√≥digo === pedido.clave && 
                f.Descripci√≥n === pedido.descripcion
            );
            nombreReserva = facturaRelacionada ? 
                           `${facturaRelacionada.Folio}_1` : 
                           `${pedido.descripcion.split(' ')[0]}_1`;
        }

        // Preparar datos para la reserva
        const registroReserva = {
            nombre: nombreReserva,
            "C√≥digo": pedido.clave,
            "Descripci√≥n": pedido.descripcion,
            "L√≠nea": pedido.linea,
            "Cantidad": pedido.cantidad,
            "Volumen Total": pedido.volumen,
            "Peso Total": pedido.peso,
            "Valor Total ($)": pedido.valor
        };

        // Guardar en la hoja de reservados
        const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=reservados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: registroReserva })
        });

        if (!res.ok) throw new Error('Error al guardar reserva');

        // Eliminar del pedido en curso
        pedidosEnCurso.splice(idx, 1);
        renderPedidosActuales();
        actualizarGraficas();
        
        alert('Pedido reservado exitosamente como: ' + nombreReserva);

    } catch (error) {
        console.error('Error al reservar:', error);
        alert('Error al reservar el pedido: ' + error.message);
    }
}
function quitarPedido(idx) {
    if (confirm('¬øSeguro que desea quitar esta llanta del pedido?')) {
        pedidosEnCurso.splice(idx, 1);
        renderPedidosActuales();
        actualizarGraficas();
    }
}
   function editarPedido(idx) {
    const pedido = pedidosEnCurso[idx];
    const nuevaCantidad = parseInt(prompt(`Editar cantidad para ${pedido.descripcion}:`, pedido.cantidad));
    if (isNaN(nuevaCantidad) || nuevaCantidad <= 0) return;

    // Buscar la llanta en el inventario para obtener los valores unitarios
    const llanta = inventario.find(item => item.clave.toString() === pedido.clave);
    if (!llanta) return;

    // Actualizar los valores del pedido
    pedido.cantidad = nuevaCantidad;
    pedido.peso = safeNum(getField(llanta,'peso')) * nuevaCantidad;
    pedido.volumen = safeNum(getField(llanta,'volumen')) * nuevaCantidad;
    pedido.valor = safeNum(getField(llanta,'valor')) * nuevaCantidad;

    renderPedidosActuales();
    actualizarGraficas();
}
   function renderPedidosActuales() {
       const tbody = document.querySelector('#tablaPedidosActuales tbody');
       if (!tbody) {
           console.error('No se encontr√≥ la tabla de pedidos actuales');
           return;
       }
    
       tbody.innerHTML = '';

       // Renderizar filas de pedidos
       pedidosEnCurso.forEach((pedido, idx) => {
           const tr = document.createElement('tr');
           tr.innerHTML = `
               <td>${pedido.clave || '-'}</td>
               <td>${pedido.descripcion || '-'}</td>
               <td>${pedido.linea || '-'}</td> 
               <td>${pedido.cantidad || 0}</td>
               <td>${(pedido.volumen || pedido.volumen === 0) ? 
                   safeNum(pedido.volumen).toLocaleString('es-MX', 
                   { minimumFractionDigits: 3, maximumFractionDigits: 3 }) : '-'}</td>
               <td>${(pedido.peso || pedido.peso === 0) ? 
                   safeNum(pedido.peso).toLocaleString('es-MX', 
                   { minimumFractionDigits: 3, maximumFractionDigits: 3 }) : '-'}</td>
               <td>${(pedido.valor || pedido.valor === 0) ? 
                   ('$' + safeNum(pedido.valor).toLocaleString('es-MX', 
                   { minimumFractionDigits: 2, maximumFractionDigits: 2 })) : '-'}</td>
              <td>
                  <button onclick="editarPedido(${idx})" class="btn btn-sm btn-primary">Editar</button>
                  <button onclick="quitarPedido(${idx})" class="btn btn-sm btn-danger">Quitar</button>
                  <button onclick="reservarPedidoActual(${idx})" class="btn btn-sm btn-success">Reservar</button>
              </td>
           `;
           tbody.appendChild(tr);
       });

       // Calcular totales
       let totalCantidad = 0, totalVolumen = 0, totalPeso = 0, totalValor = 0;
       pedidosEnCurso.forEach(p => {
           totalCantidad += safeNum(p.cantidad);
           totalVolumen += safeNum(p.volumen);
           totalPeso += safeNum(p.peso);
           totalValor += safeNum(p.valor);
       });

       // Mostrar totales
      const totalesPedidoElement = document.getElementById('totalesPedido');
      if (totalesPedidoElement) {
          totalesPedidoElement.innerText = `
              Total cantidad: ${totalCantidad.toLocaleString('es-MX')} | 
              Total volumen: ${totalVolumen.toLocaleString('es-MX', 
              { minimumFractionDigits: 3, maximumFractionDigits: 3 })} m¬≥ | 
              Total peso: ${totalPeso.toLocaleString('es-MX', 
              { minimumFractionDigits: 3, maximumFractionDigits: 3 })} kg | 
              Total valor: $${totalValor.toLocaleString('es-MX', 
              { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
          `.replace(/\s+/g, ' ').trim();
      }

      // Actualizar gr√°ficas y verificar capacidad
      actualizarGraficas();
      verificarCapacidad(totalVolumen, totalPeso);
   }
   // ...existing code...
// Despu√©s de renderPedidosActuales() y antes de actualizarGraficas()
function resetPedidoInputs() {
    document.getElementById('pedidoCodigoLlanta').value = '';
    document.getElementById('pedidoDescripcionLlantaInput').value = '';
    document.getElementById('pedidoCantidadLlanta').value = '1';
    document.getElementById('pedidoPesoLlanta').innerText = '0';
    document.getElementById('pedidoVolumenLlanta').innerText = '0';
    document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
}
function limpiarPedidosActuales() {
    if (confirm('¬øSeguro que deseas limpiar todos los pedidos actuales del cami√≥n?')) {
        pedidosEnCurso = []; // Limpia el array de pedidos
        renderPedidosActuales(); // Actualiza la tabla
        actualizarGraficas(); // Actualiza las gr√°ficas
        resetPedidoInputs(); // Limpia los inputs
        
        // Limpiar totales
        const totalesPedidoElement = document.getElementById('totalesPedido');
        if (totalesPedidoElement) {
            totalesPedidoElement.innerText = 'Total cantidad: 0 | Total volumen: 0 m¬≥ | Total peso: 0 kg | Total valor: $0';
        }

        // Actualizar las gr√°ficas a 0
        if (chartVolumen && chartCarga) {
            chartVolumen.data.datasets[0].data = [0, 100];
            chartCarga.data.datasets[0].data = [0, 100];
            chartVolumen.update();
            chartCarga.update();
            document.querySelector('#graphVolumen + p').innerHTML = 'Espacio usado';
            document.querySelector('#graphCarga + p').innerHTML = 'Carga Usada';
        }
    }
}
// Agregar despu√©s de las funciones existentes
function toggleVerificacionRapida() {
    const panel = document.getElementById('verificacionRapidaPanel');
    const boton = document.querySelector('button[onclick="toggleVerificacionRapida()"]');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        boton.innerHTML = '<i class="bi bi-calculator"></i> Ocultar Calculadora R√°pida';
        boton.classList.replace('btn-info', 'btn-secondary');
    } else {
        panel.style.display = 'none';
        boton.innerHTML = '<i class="bi bi-calculator"></i> Mostrar Calculadora R√°pida';
        boton.classList.replace('btn-secondary', 'btn-info');
    }
}
// Agregar despu√©s de las funciones existentes
function verificacionRapida() {
    if (!pedidoCamion) {
        alert('Primero selecciona un cami√≥n');
        return;
    }

    // Panel de entrada m√∫ltiple
    const panelHTML = `
        <div class="card mb-3">
            <div class="card-body" id="combinacionesPanel">
                <div class="row mb-2 combinacion-row">
                    <div class="col-md-3">
                        <label>Cantidad</label>
                        <input type="number" class="form-control cantidad-llanta" value="1" min="1">
                    </div>
                    <div class="col-md-3">
                        <label>Tipo de Llanta</label>
                       <select class="form-control tipo-llanta">
                           <option value="AUTO">Auto particular</option>
                           <option value="SUV_CAMIONETA">SUVs y camionetas</option>
                           <option value="COMERCIAL_LIGERO">Veh√≠culo comercial ligero y camiones peque√±os</option>
                           <option value="PESADO">Camiones pesados y tractocamiones</option>
                           <option value="AGRICOLA_MINERO">Agr√≠cola y minero</option>
                           <option value="CAMARAS">C√°maras</option>
                       </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-danger btn-sm" onclick="eliminarCombinacion(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-success" onclick="agregarCombinacion()">
                    <i class="bi bi-plus-circle"></i> Agregar combinaci√≥n
                </button>
                <button class="btn btn-primary" onclick="calcularCombinaciones()">
                    <i class="bi bi-calculator"></i> Calcular capacidad
                </button>
                <button class="btn btn-danger" onclick="limpiarCalculadoraRapida()">
                    <i class="bi bi-trash"></i> Limpiar todo
                </button>
            </div>
        </div>
    `;

    const panelActual = document.getElementById('verificacionRapidaPanel');
    panelActual.innerHTML = panelHTML;
}

function agregarCombinacion() {
    const nuevaFila = `
        <div class="row mb-2 combinacion-row">
            <div class="col-md-3">
                <label>Cantidad</label>
                <input type="number" class="form-control cantidad-llanta" value="1" min="1">
            </div>
            <div class="col-md-3">
                <label>Tipo de Llanta</label>
                <select class="form-control tipo-llanta">
                    <option value="AUTO">Auto particular</option>
                    <option value="SUV_CAMIONETA">SUVs y camionetas</option>
                    <option value="COMERCIAL_LIGERO">Veh√≠culo comercial ligero y camiones peque√±os</option>
                    <option value="PESADO">Camiones pesados y tractocamiones</option>
                    <option value="AGRICOLA_MINERO">Agr√≠cola y minero</option>
                    <option value="CAMARAS">C√°maras</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-danger btn-sm" onclick="eliminarCombinacion(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    document.getElementById('combinacionesPanel').insertAdjacentHTML('beforeend', nuevaFila);
}

function eliminarCombinacion(boton) {
    boton.closest('.combinacion-row').remove();
}
function calcularCombinaciones() {
    if (!pedidoCamion) {
        alert('Selecciona un cami√≥n primero');
        return;
    }

    // Valores promedio por tipo
    const valoresPromedio = {
        'AUTO': { 
           volumen: 0.047,  // 47 litros = 0.047 m¬≥
           peso: 7         // 7 kg promedio
       },
       'SUV_CAMIONETA': { 
           volumen: 0.060,  // 60 litros = 0.060 m¬≥
           peso: 12.5      // 12.5 kg promedio
       },
      'COMERCIAL_LIGERO': { 
           volumen: 0.120,  // 120 litros = 0.120 m¬≥
           peso: 25        // 25 kg promedio
       },
      'PESADO': { 
           volumen: 0.280,  // 280 litros = 0.280 m¬≥
           peso: 50        // 50 kg promedio
       },
      'AGRICOLA_MINERO': { 
           volumen: 0.450,  // 450 litros = 0.450 m¬≥
           peso: 80        // 80 kg promedio
       },
      'CAMARAS': {
           volumen: 0.010,  // 10 litros = 0.010 m¬≥
           peso: 2         // 2 kg promedio
      }
   };

    let volumenTotal = 0;
    let pesoTotal = 0;
    const detalles = [];

    document.querySelectorAll('.combinacion-row').forEach(row => {
        const cantidad = parseInt(row.querySelector('.cantidad-llanta').value) || 0;
        const tipo = row.querySelector('.tipo-llanta').value;
        
        if (cantidad > 0) {
            const volumenParcial = cantidad * valoresPromedio[tipo].volumen;
            const pesoParcial = cantidad * valoresPromedio[tipo].peso;
            
            volumenTotal += volumenParcial;
            pesoTotal += pesoParcial;
            
            detalles.push({
                tipo,
                cantidad,
                volumen: volumenParcial,
                peso: pesoParcial
            });
        }
    });

    // Calcular capacidades disponibles
    const volumenActual = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.volumen), 0);
    const pesoActual = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.peso), 0);
    const capacidadVolumen = safeNum(pedidoCamion.volumen);
    const capacidadPeso = safeNum(pedidoCamion["capacidad de carga (kg)"]) || safeNum(pedidoCamion.carga);
    const volumenDisponible = capacidadVolumen - volumenActual;
    const pesoDisponible = capacidadPeso - pesoActual;


    const volumenMaximo = volumenDisponible 
    const pesoMaximo = pesoDisponible

    // Generar reporte detallado
    // En la funci√≥n calcularCombinaciones()

    const mensaje = `
        <div class="alert ${volumenTotal <= volumenDisponible && pesoTotal <= pesoDisponible ? 'alert-success' : 'alert-warning'} mt-3">
            <h5>${volumenTotal <= volumenDisponible && pesoTotal <= pesoDisponible ? '‚úÖ El pedido si cabe en la unidad' : '‚ö†Ô∏è El pedido excede la capacidad'}</h5>
            <hr>
            <h6>Desglose por tipo:</h6>
            <ul>
               ${detalles.map(d => `
                   <li>${d.cantidad} llantas tipo ${d.tipo}:
                       <ul>
                           <li>Volumen: ${d.volumen.toFixed(2)} m¬≥</li>
                           <li>Peso: ${d.peso.toFixed(2)} kg</li>
                       </ul>
                   </li>
               `).join('')}
           </ul>
           <hr>
           <p><b>Totales requeridos:</b></p>
        
           <!-- Barra de progreso para Volumen -->
           <div class="mb-3">
               <label>Ocupaci√≥n de volumen:</label>
               <div class="progress">
                   <div class="progress-bar ${volumenTotal > volumenDisponible ? 'bg-danger' : volumenTotal > volumenDisponible * 0.9 ? 'bg-warning' : 'bg-success'}" 
                        role="progressbar" 
                        style="width: ${Math.min((volumenTotal/volumenDisponible) * 100, 100)}%;" 
                        aria-valuenow="${Math.min((volumenTotal/volumenDisponible) * 100, 100)}" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                       ${((volumenTotal/volumenDisponible) * 100).toFixed(1)}%
                   </div>
               </div>
               <small>Volumen total: ${volumenTotal.toFixed(2)} m¬≥ de ${volumenDisponible.toFixed(2)} m¬≥ disponibles</small>
           </div>

           <!-- Barra de progreso para Peso -->
           <div class="mb-3">
               <label>Ocupaci√≥n de peso:</label>
               <div class="progress">
                   <div class="progress-bar ${pesoTotal > pesoDisponible ? 'bg-danger' : pesoTotal > pesoDisponible * 0.9 ? 'bg-warning' : 'bg-success'}" 
                        role="progressbar" 
                        style="width: ${Math.min((pesoTotal/pesoDisponible) * 100, 100)}%;" 
                        aria-valuenow="${Math.min((pesoTotal/pesoDisponible) * 100, 100)}" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                       ${((pesoTotal/pesoDisponible) * 100).toFixed(1)}%
                  </div>
              </div>
              <small>Peso total: ${pesoTotal.toFixed(2)} kg de ${pesoDisponible.toFixed(2)} kg disponibles</small>
          </div>

          ${volumenTotal > volumenDisponible || pesoTotal > pesoDisponible ? `
              <div class="alert alert-danger">
                  <p><b>Exceso:</b></p>
                  ${volumenTotal > volumenDisponible ? `<li>Volumen excedido por ${(volumenTotal - volumenDisponible).toFixed(2)} m¬≥</li>` : ''}
                  ${pesoTotal > pesoDisponible ? `<li>Peso excedido por ${(pesoTotal - pesoDisponible).toFixed(2)} kg</li>` : ''}
              </div>
          ` : ''}
      </div>
  `;

    const resultadoDiv = document.createElement('div');
    resultadoDiv.innerHTML = mensaje;
    
    const panelVerificacion = document.getElementById('verificacionRapidaPanel');
    const resultadoExistente = panelVerificacion.querySelector('.alert');
    if (resultadoExistente) {
        resultadoExistente.remove();
    }
    panelVerificacion.appendChild(resultadoDiv);
}
// Variables globales adicionales

// Funci√≥n principal de procesamiento
async function processFiles() {
    const files = document.getElementById('fileInput').files;
    if (!files.length) return alert("Selecciona al menos un PDF");
    
    const logDiv = document.getElementById("log");
    logDiv.innerHTML = "";
    logDiv.style.display = "block";

    try {
        for (const file of files) {
            // Verificar cach√© primero
            const cacheKey = `pdf_${file.name}_${file.lastModified}`;
            const cachedData = getCache(cacheKey);
            
            if (cachedData) {
                escaneosActuales.push(...cachedData);
                logDiv.innerHTML += `
                    <div class="alert alert-info">
                        <h6>Archivo: ${file.name}</h6>
                        <p>‚úì Usando datos en cach√© (${cachedData.length} productos)</p>
                    </div>`;
                continue;
            }

            logDiv.innerHTML += `<p>Procesando: ${file.name}...</p>`;
            
            try {
                const { fecha, productos } = await extractDataFromPDF(file);
                
                const fileRows = productos
                    .map(producto => {
                        try {
                            // Asegurarse que los valores sean strings antes de usar replace
                            const cantidadStr = String(producto.cantidad || '0');
                            const cantidad = parseFloat(cantidadStr.replace(/[^\d.]/g, '') || '0');
                            const codigo = String(producto.codigo || '').replace(/[^\w\-]/g, '').trim();
                            let descripcion = String(producto.descripcion || '')
                                .replace(/\s+/g, ' ')
                                .replace(/[^\w\s\-\/."]/g, '')
                                .trim()
                                .toUpperCase();

                            if (!codigo || !descripcion) return null;

                            const validaciones = {
                                codigo: /^[A-Z0-9\-]{3,}$/i.test(codigo),
                                cantidad: !isNaN(cantidad) && cantidad > 0,
                                descripcion: descripcion.length >= 5
                            };

                            if (Object.values(validaciones).every(v => v)) {
                                return {
                                    Archivo: file.name,
                                    Fecha: fecha,
                                    Cantidad: cantidad,
                                    Codigo: codigo,
                                    Descripcion: descripcion,
                                    TipoLlanta: determinarTipoLlanta(descripcion)
                                };
                            }
                            return null;
                        } catch (err) {
                            console.warn('Error procesando producto:', err);
                            return null;
                        }
                    })
                    .filter(Boolean); // Elimina los valores null

                if (fileRows.length > 0) {
                    setCache(cacheKey, fileRows);
                    escaneosActuales.push(...fileRows);
                    
                    const stats = {
                        total: fileRows.length,
                        cantidadValida: fileRows.filter(r => !isNaN(r.Cantidad)).length,
                        codigoValido: fileRows.filter(r => r.Codigo).length,
                        descripcionCompleta: fileRows.filter(r => r.Descripcion.length > 5).length
                    };

                    logDiv.innerHTML += `
                        <div class="alert alert-success">
                            <h6>Archivo: ${file.name}</h6>
                            <p>‚úì ${stats.total} productos extra√≠dos correctamente</p>
                            <div class="stats-detail">
                                <small>
                                    ‚Ä¢ Productos con cantidad v√°lida: ${stats.cantidadValida}<br>
                                    ‚Ä¢ Productos con c√≥digo v√°lido: ${stats.codigoValido}<br>
                                    ‚Ä¢ Productos con descripci√≥n completa: ${stats.descripcionCompleta}
                                </small>
                            </div>
                        </div>`;
                } else {
                    logDiv.innerHTML += `
                        <div class="alert alert-warning">
                            <h6>Archivo: ${file.name}</h6>
                            <p>‚ö†Ô∏è No se pudieron extraer productos v√°lidos</p>
                        </div>`;
                }

            } catch (fileError) {
                console.error(`Error procesando archivo ${file.name}:`, fileError);
                logDiv.innerHTML += `
                    <div class="alert alert-danger">
                        <h6>Error en archivo: ${file.name}</h6>
                        <p>${fileError.message}</p>
                    </div>`;
            }
        }

        if (escaneosActuales.length > 0) {
            mostrarEscaneosPendientes();
        }
        
    } catch (error) {
        console.error('Error general:', error);
        logDiv.innerHTML += `
            <div class="alert alert-danger">
                <h6>Error en el procesamiento</h6>
                <p>${error.message}</p>z
                <small>Revisa la consola para m√°s detalles</small>
            </div>`;
    }
}
// Funci√≥n auxiliar para generar resumen final
function generarResumenFinal(escaneos) {
    const stats = escaneos.reduce((acc, item) => {
        acc.totalProductos++;
        acc.totalCantidad += item.Cantidad;
        acc.tiposLlanta[item.TipoLlanta] = (acc.tiposLlanta[item.TipoLlanta] || 0) + 1;
        return acc;
    }, { totalProductos: 0, totalCantidad: 0, tiposLlanta: {} });

    return `
        <div class="alert alert-info mt-3">
            <h5>Resumen Final</h5>
            <p>Total de productos procesados: ${stats.totalProductos}</p>
            <p>Cantidad total de llantas: ${stats.totalCantidad}</p>
            <h6>Distribuci√≥n por tipo:</h6>
            <ul>
                ${Object.entries(stats.tiposLlanta)
                    .map(([tipo, cant]) => `<li>${tipo}: ${cant} productos</li>`)
                    .join('')}
            </ul>
        </div>`;
}

// Funci√≥n auxiliar para preprocesar im√°genes
async function preprocessImage(imageData) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = imageData.width;
    canvas.height = imageData.height;
    
    // Aplicar filtros para mejorar la legibilidad
    ctx.filter = 'contrast(1.2) brightness(1.1) grayscale(1)';
    ctx.drawImage(imageData, 0, 0);
    
    return canvas;
}

// Funci√≥n para mostrar los escaneos pendientes
function mostrarEscaneosPendientes() {
    const div = document.getElementById('extractedData');
    if (escaneosActuales.length === 0) {
        div.innerHTML = '<p class="alert alert-warning">No hay datos para mostrar.</p>';
        return;
    }

    let html = `
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Escaneos Pendientes (${escaneosActuales.length} productos)</h5>
                <div>
                    <input type="text" class="form-control" id="nombreBloqueEspecial" 
                           placeholder="Nombre del bloque">
                    <button class="btn btn-success mt-2" onclick="guardarBloqueEspecial()">
                        Guardar como Bloque
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Archivo</th>
                            <th>Fecha</th>
                            <th>Cantidad</th>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${escaneosActuales.map((row, idx) => `
                            <tr>
                                <td>${row.Archivo}</td>
                                <td>${row.Fecha}</td>
                                <td>${row.Cantidad}</td>
                                <td>${row.Codigo}</td>
                                <td>${row.Descripcion}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" 
                                            onclick="eliminarEscaneoPendiente(${idx})">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    div.innerHTML = html;
}

// Funci√≥n para guardar el bloque
async function guardarBloqueEspecial() {
    const nombreBloque = document.getElementById('nombreBloqueEspecial').value.trim();
    if (!nombreBloque) {
        alert('Por favor, ingrese un nombre para el bloque');
        return;
    }

    // Cambiar esta validaci√≥n para usar escaneosActuales
    if (escaneosActuales.length === 0) {
        alert('No hay datos para guardar en el bloque');
        return;
    }

    try {
        // Preparar datos para guardar usando escaneosActuales
        const datosBloque = escaneosActuales.map(item => ({
            Nombre: nombreBloque,
            Archivo: item.Archivo,
            Fecha: item.Fecha,
            Cantidad: item.Cantidad,
            C√≥digo: item.Codigo,
            Descripci√≥n: item.Descripcion
        }));

        // Guardar en SheetDB
        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: datosBloque })
        });

        if (!response.ok) throw new Error('Error al guardar en SheetDB');

        alert('Bloque guardado exitosamente');
        escaneosActuales = []; // Limpiar escaneos actuales
        document.getElementById('fileInput').value = ''; // Limpiar input file
        document.getElementById('nombreBloqueEspecial').value = ''; // Limpiar nombre
        mostrarEscaneosPendientes();
        cargarEscaneosGuardados(); // Actualizar lista de bloques guardados

    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar el bloque: ' + error.message);
    }
}

// Funci√≥n para eliminar un escaneo pendiente
function eliminarEscaneoPendiente(idx) {
    escaneosActuales.splice(idx, 1);
    mostrarEscaneosPendientes();
}

// Funci√≥n de extracci√≥n mejorada
async function extractDataFromPDF(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    let fullText = "";
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        fullText += textContent.items.map(item => item.str).join(" ") + "\n";
    }

    // Extraer fecha
    const fechaRegex = /FECHA DE EXPEDICI√ìN\s*([\d]{4}-[\d]{2}-[\d]{2})/i;
    let fechaMatch = fullText.match(fechaRegex);
    let fecha = fechaMatch ? fechaMatch[1] : new Date().toISOString().split('T')[0];

    // Extraer productos
    const productoRegex = /(\d+)\s*(pz|PZ|un|UN|UN\.|u[nN]\.?)\s+([A-Z0-9\-]+)\s+([A-Z0-9\s.\-\/]+)/g;
    const productos = [];
    let match;
    while ((match = productoRegex.exec(fullText)) !== null) {
        const cantidad = parseInt(match[1]);
        const codigo = match[3].trim();
        const descripcion = match[4].trim().replace(/\s+/g, " ");
        productos.push({ cantidad, codigo, descripcion });
    }

    return { fecha, productos };
}

// Funci√≥n para calcular el volumen de una llanta basado en su descripci√≥n
async function calcularVolumenLlanta(descripcion) {
    const desc = descripcion.toUpperCase();
    let volumen = 0;

    // Patrones para diferentes tipos de llantas
    const patrones = [
        {
            regex: /^(\d{2})L-(\d{2})\s*(?:\((\d{1,2})\))?\s*((?:SKS|F3|IND|AGRO|CT).*)?/i,
            calc: (m) => {
                const ancho = Number(m[1]) * 25.4 * 1.15 / 1000;
                const rin = Number(m[2]) * 0.0254;
                const capas = m[3] ? Number(m[3]) : 12;
                return Math.PI * Math.pow((rin + ancho)/2, 2) * ancho * 1.9;
            }
        },
        {
            regex: /^[P]?(\d{3})[\/\s\-](\d{2})[\/\s\-]?R?(\d{2})/,
            calc: (m) => {
                const ancho = Number(m[1]) / 1000;
                const perfil = Number(m[2]) / 100;
                const rin = Number(m[3]) * 0.0254;
                return Math.PI * Math.pow((rin + ancho * perfil)/2, 2) * ancho * 1.3;
            }
        }
        // Agregar m√°s patrones seg√∫n sea necesario
    ];

    // Buscar patr√≥n coincidente y calcular volumen
    for (const patron of patrones) {
        const match = desc.match(patron.regex);
        if (match) {
            volumen = patron.calc(match);
            break;
        }
    }

    return volumen.toFixed(4);
}

// Funci√≥n para agregar productos nuevos al inventario
async function agregarProductosNuevosAlInventario(productos) {
    try {
        const datosParaGuardar = productos.map(p => ({
            clave: p.Codigo,
            descripcion: p.Descripcion,
            linea: determinarTipoLlanta(p.Descripcion),
            peso: '',  // Se deja vac√≠o para llenado manual posterior
            volumen: p.Volumen,
            valor: ''  // Se deja vac√≠o para llenado manual posterior
        }));

        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: datosParaGuardar })
        });

        if (!response.ok) throw new Error('Error al agregar productos al inventario');

        alert(`Se agregaron ${productos.length} productos nuevos al inventario`);
        await fetchInventario(); // Actualizar el inventario local

    } catch (error) {
        console.error('Error:', error);
        alert('Error al agregar productos al inventario: ' + error.message);
    }
}

// Funci√≥n para cargar autom√°ticamente los escaneos cuando se activa la pesta√±a
function inicializarPestanaEscaneos() {
    // Buscar todos los elementos que cambian a la pesta√±a de escaneos
    document.querySelectorAll('[data-tab="escaneos-traspasos"]').forEach(tab => {
        tab.addEventListener('click', () => {
            console.log('Pesta√±a de escaneos activada - cargando datos...');
            cargarEscaneosGuardados();
        });
    });
}

// Llamar a la funci√≥n de inicializaci√≥n cuando el documento est√© listo
document.addEventListener('DOMContentLoaded', () => {
    inicializarPestanaEscaneos();
    // Cargar los datos inicialmente si estamos en la pesta√±a de escaneos
    if (document.querySelector('[data-tab="escaneos-traspasos"].active')) {
        cargarEscaneosGuardados();
    }
});

// Variable para controlar el intervalo de actualizaci√≥n
let intervaloActualizacionEscaneos = null;

// Funci√≥n para iniciar la actualizaci√≥n autom√°tica
function iniciarActualizacionAutomatica() {
    // Detener cualquier intervalo existente
    if (intervaloActualizacionEscaneos) {
        clearInterval(intervaloActualizacionEscaneos);
    }

    // Crear nuevo intervalo que actualiza cada 30 segundos
    intervaloActualizacionEscaneos = setInterval(() => {
        if (document.querySelector('[data-tab="escaneos-traspasos"].active')) {
            console.log('Actualizando autom√°ticamente los escaneos...');
            cargarEscaneosGuardados(true);
        }
    }, 30000);
}

async function cargarEscaneosGuardados(filtro = '', silencioso = false) {
    try {
        if (!silencioso) {
            console.log('Iniciando carga de escaneos guardados...');
        }
        
        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales');
        if (!response.ok) throw new Error('Error al cargar escaneos');
        
        const datos = await response.json();
        if (!silencioso) {
            console.log('Datos de escaneos cargados:', datos);
        }
        
        // Agrupar por nombre de escaneo
        const escaneosAgrupados = datos.reduce((grupos, item) => {
            if (!grupos[item.Nombre]) {
                grupos[item.Nombre] = [];
            }
            grupos[item.Nombre].push(item);
            return grupos;
        }, {});

        // Filtrar por b√∫squeda si hay filtro
        const nombresEscaneos = Object.keys(escaneosAgrupados)
            .filter(nombre => nombre.toLowerCase().includes(filtro.toLowerCase()));

        // Mostrar resultados
        const contenedorEscaneos = document.getElementById('escaneosGuardados');
        if (!contenedorEscaneos) {
            console.error('No se encontr√≥ el contenedor de escaneos guardados');
            return;
        }

        contenedorEscaneos.innerHTML = nombresEscaneos.length === 0 ? 
            '<div class="alert alert-info">No se encontraron escaneos guardados</div>' :
            nombresEscaneos.map(nombre => `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${nombre}</h5>
                        <button class="btn btn-danger btn-sm" onclick="eliminarEscaneo('${nombre}')">
                            Eliminar
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Archivo</th>
                                    <th>Fecha</th>
                                    <th>C√≥digo</th>
                                    <th>Descripci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${escaneosAgrupados[nombre].map(item => `
                                    <tr>
                                        <td>${item.Archivo || ''}</td>
                                        <td>${item.Fecha || ''}</td>
                                        <td>${item.C√≥digo || ''}</td>
                                        <td>${item.Descripci√≥n || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');

    } catch (error) {
        console.error('Error:', error);
        document.getElementById('escaneosGuardados').innerHTML = 
            '<div class="alert alert-danger">Error al cargar escaneos guardados</div>';
    }
}
// Funci√≥n para mostrar resultados en tabla
function renderTable() {
    const div = document.getElementById('extractedData');
    if (extractedData.length === 0) {
        div.innerHTML = '<p class="alert alert-warning">No se encontraron datos para mostrar.</p>';
        return;
    }

    div.innerHTML = `
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>Archivo</th>
                    <th>Fecha</th>
                    <th>Cantidad</th>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                </tr>
            </thead>
            <tbody>
                ${extractedData.map(row => `
                    <tr>
                        <td>${row.Archivo}</td>
                        <td>${row.Fecha}</td>
                        <td>${row.Cantidad}</td>
                        <td>${row.Codigo}</td>
                        <td>${row.Descripcion}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function mostrarBloquesGuardadosEspeciales() {
    const container = document.getElementById('bloquesGuardadosEspeciales');
    
    fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales')
        .then(response => response.json())
        .then(datos => {
            // Agrupar por nombre de bloque
            const bloques = datos.reduce((acc, item) => {
                if (!acc[item.Nombre]) {
                    acc[item.Nombre] = [];
                }
                acc[item.Nombre].push(item);
                return acc;
            }, {});

            let html = Object.entries(bloques).map(([nombre, items]) => `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${nombre}</h6>
                        <button class="btn btn-danger btn-sm" 
                                onclick="eliminarBloqueEspecial('${nombre}')">
                            Eliminar Bloque
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Archivo</th>
                                    <th>Fecha</th>
                                    <th>Cantidad</th>
                                    <th>C√≥digo</th>
                                    <th>Descripci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td>${item.Archivo}</td>
                                        <td>${item.Fecha}</td>
                                        <td>${item.Cantidad}</td>
                                        <td>${item.C√≥digo}</td>
                                        <td>${item.Descripci√≥n}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="alert alert-info">No hay bloques guardados</div>';
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<div class="alert alert-danger">Error al cargar bloques guardados</div>';
        });
}

async function eliminarBloqueEspecial(nombre) {
    if (!confirm(`¬øEst√° seguro de eliminar el bloque "${nombre}"?`)) return;

    try {
        const response = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/Nombre/${encodeURIComponent(nombre)}?sheet=Escaneados especiales`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Error al eliminar');

        alert('Bloque eliminado exitosamente');
        mostrarEscaneosPendientes();
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el bloque: ' + error.message);
    }
}

function eliminarEscaneoPendiente(idx) {
    extractedData.splice(idx, 1);
    mostrarEscaneosPendientes();
}
// Agregar despu√©s de la funci√≥n renderTable()
// Funci√≥n principal para guardar escaneo
function guardarEscaneoEspecial() {
    if (extractedData.length === 0) {
        alert('No hay datos para guardar');
        return;
    }

    // Limpiar cualquier modal existente
    limpiarModales();


    // Primero, limpiar cualquier modal existente
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');

    const modalHTML = `
        <div class="modal" id="modalNombreEscaneo" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Guardar Escaneo</h5>
                        <button type="button" class="btn-close" onclick="cerrarModalEscaneo()" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="nombreEscaneo">Nombre del escaneo:</label>
                            <input type="text" class="form-control" id="nombreEscaneo" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModalEscaneo()">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="confirmarGuardadoEscaneo()">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remover modal anterior si existe
    const modalAnterior = document.getElementById('modalNombreEscaneo');
    if (modalAnterior) {
        modalAnterior.remove();
    }

    // Agregar el nuevo modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Mostrar el modal de manera manual
    const modalElement = document.getElementById('modalNombreEscaneo');
    modalElement.style.display = 'block';
    modalElement.classList.add('show');
    modalElement.style.backgroundColor = 'rgba(0,0,0,0.5)';

    // Enfocar el input
    document.getElementById('nombreEscaneo').focus();
}

// Funci√≥n para cerrar el modal
function cerrarModalEscaneo() {
    const modalElement = document.getElementById('modalNombreEscaneo');
    if (modalElement) {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.remove();
        
        // Limpiar backdrop y clases del body
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
    }
}

// Funci√≥n para confirmar el guardado
async function confirmarGuardadoEscaneo() {
    const nombreEscaneo = document.getElementById('nombreEscaneo').value.trim();
    if (!nombreEscaneo) {
        alert('Por favor ingresa un nombre para el escaneo');
        return;
    }

    try {
        // Obtener la fecha actual en formato YYYY-MM-DD
        const fechaActual = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD

        // Preparar datos para guardar con los nombres exactos de las columnas
        const datosParaGuardar = extractedData.map(item => ({
            Nombre: nombreEscaneo,
            Archivo: item.Archivo || '',
            Fecha: fechaActual,
            Cantidad: item.Cantidad || '',
            C√≥digo: item.Codigo || '',     // Notar la tilde en 'C√≥digo'
            Descripci√≥n: item.Descripcion || ''  // Notar la tilde en 'Descripci√≥n'
        }));

        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: datosParaGuardar })
        });

        if (!response.ok) throw new Error('Error al guardar en SheetDB');

        // Cerrar el modal
        cerrarModalEscaneo();

        // Limpiar datos y UI
        alert('Escaneo guardado exitosamente');
        extractedData = [];
        document.getElementById('extractedData').innerHTML = '';
        document.getElementById('fileInput').value = '';
        
        // Actualizar lista de escaneos
        await cargarEscaneosGuardados();

    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar el escaneo: ' + error.message);
    }
}

function cerrarModalEscaneo() {
    const modalElement = document.getElementById('modalNombreEscaneo');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
        setTimeout(() => {
            modalElement.remove();
            limpiarModales();
        }, 300);
    }
}

// Funci√≥n para eliminar escaneo
async function eliminarEscaneo(nombre) {
    if (!confirm(`¬øEst√°s seguro de que deseas eliminar el escaneo "${nombre}"?`)) return;

    try {
        const response = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/Nombre/${encodeURIComponent(nombre)}?sheet=Escaneados especiales`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Error al eliminar');

        alert('Escaneo eliminado exitosamente');
        cargarEscaneosGuardados();

    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el escaneo: ' + error.message);
    }
}
// Agregar despu√©s de la funci√≥n calcularCombinaciones()
function limpiarCalculadoraRapida() {
    const panelHTML = `
        <div class="card mb-3">
            <div class="card-body" id="combinacionesPanel">
                <div class="row mb-2 combinacion-row">
                    <div class="col-md-3">
                        <label>Cantidad</label>
                        <input type="number" class="form-control cantidad-llanta" value="1" min="1">
                    </div>
                    <div class="col-md-3">
                        <label>Tipo de Llanta</label>
                        <select class="form-control tipo-llanta">
                            <option value="AUTO">Auto particular</option>
                            <option value="SUV_CAMIONETA">SUVs y camionetas</option>
                            <option value="COMERCIAL_LIGERO">Veh√≠culo comercial ligero y camiones peque√±os</option>
                            <option value="PESADO">Camiones pesados y tractocamiones</option>
                            <option value="AGRICOLA_MINERO">Agr√≠cola y minero</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-danger btn-sm" onclick="eliminarCombinacion(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-success" onclick="agregarCombinacion()">
                    <i class="bi bi-plus-circle"></i> Agregar combinaci√≥n
                </button>
                <button class="btn btn-primary" onclick="calcularCombinaciones()">
                    <i class="bi bi-calculator"></i> Calcular capacidad
                </button>
                <button class="btn btn-danger" onclick="limpiarCalculadoraRapida()">
                    <i class="bi bi-trash"></i> Limpiar todo
                </button>
            </div>
        </div>
    `;

    // Reemplazar el panel existente
    const panelActual = document.getElementById('verificacionRapidaPanel');
    panelActual.innerHTML = panelHTML;

    // Remover cualquier resultado previo
    const resultadoExistente = panelActual.querySelector('.alert');
    if (resultadoExistente) {
        resultadoExistente.remove();
    }
}
    // ----- Gr√°ficas -----
    const ctxVolumen = document.getElementById('graphVolumen').getContext('2d');
    const ctxCarga = document.getElementById('graphCarga').getContext('2d');
    let chartVolumen = new Chart(ctxVolumen, {
        type: 'doughnut',
        data: { labels: ['Usado', 'Disponible'],
            datasets: [{ data: [0, 100], backgroundColor: ['#75c286', '#f3f3f3'], borderWidth: 1 }]
        },
        options: { plugins: {legend: {display: true}}, cutout: '70%' }
    });
    let chartCarga = new Chart(ctxCarga, {
        type: 'doughnut',
        data: { labels: ['Usado', 'Disponible'],
            datasets: [{ data: [0, 100], backgroundColor: ['#7ad4a2', '#f3f3f3'], borderWidth: 1 }]
        },
        options: { plugins: {legend: {display: true}}, cutout: '70%' }
    });   
 function verificarCapacidad(totalVolumen, totalPeso) {
    if (!pedidoCamion) return;
    
    // Ya no mostramos alertas aqu√≠
    // Solo actualizamos las gr√°ficas a trav√©s de actualizarGraficas()
    // que ya maneja la visualizaci√≥n del excedente con colores rojos
    return;
}

// Reemplazar la funci√≥n actualizarGraficas() existente
function actualizarGraficas() {
    if (!pedidoCamion) {
        chartVolumen.data.datasets[0].data = [0, 100];
        chartCarga.data.datasets[0].data = [0, 100];
        chartVolumen.update();
        chartCarga.update();
        document.querySelector('#graphVolumen + p').innerHTML = 'Espacio usado';
        document.querySelector('#graphCarga + p').innerHTML = 'Carga Usada';
        return;
    }

    // Calcular totales
    let totalVolumen = pedidosEnCurso.reduce((acc, cur) => acc + (parseFloat(cur.volumen) || 0), 0);
    let totalPeso = pedidosEnCurso.reduce((acc, cur) => acc + (parseFloat(cur.peso) || 0), 0);
    let volTotal = parseFloat(pedidoCamion.volumen || 0);
    let pesoTotal = parseFloat(pedidoCamion["capacidad de carga (kg)"] || pedidoCamion.carga || 0);

    // Calcular porcentajes
    let porcentajeVolumen = (totalVolumen / volTotal) * 100;
    let porcentajePeso = (totalPeso / pesoTotal) * 100;

    // Mostrar alerta si supera 70%
    if (porcentajeVolumen > 0 || porcentajePeso > 70) {
        mostrarAlertaCapacidad(
            volTotal - totalVolumen,
            pesoTotal - totalPeso,
            porcentajeVolumen,
            porcentajePeso
        );
    }

    // Actualizar gr√°ficas
    chartVolumen.data.datasets[0].data = [
        Math.min(totalVolumen, volTotal),
        Math.max(0, volTotal - totalVolumen)
    ];
    chartCarga.data.datasets[0].data = [
        Math.min(totalPeso, pesoTotal),
        Math.max(0, pesoTotal - totalPeso)
    ];

    // Actualizar colores seg√∫n excedentes
    chartVolumen.data.datasets[0].backgroundColor = porcentajeVolumen > 100 ? 
        ['#ff6b6b', '#f3f3f3'] : ['#75c286', '#f3f3f3'];
    chartCarga.data.datasets[0].backgroundColor = porcentajePeso > 100 ? 
        ['#ff6b6b', '#f3f3f3'] : ['#7ad4a2', '#f3f3f3'];

    chartVolumen.update();
    chartCarga.update();

    // Actualizar textos
    const volumenText = document.querySelector('#graphVolumen + p');
    const cargaText = document.querySelector('#graphCarga + p');

    volumenText.innerHTML = `Espacio usado<br>${totalVolumen.toFixed(2)}/${volTotal.toFixed(2)} m¬≥ (${porcentajeVolumen.toFixed(1)}%)`;
    cargaText.innerHTML = `Carga Usada<br>${totalPeso.toFixed(2)}/${pesoTotal.toFixed(2)} kg (${porcentajePeso.toFixed(1)}%)`;
}
// Agregar despu√©s de la funci√≥n actualizarGraficas()
// Modificar la funci√≥n mostrarAlertaCapacidad() existente
function agregarEstilosAlertas() {
    if (!document.getElementById('estilosAlertas')) {
        const estilos = document.createElement('style');
        estilos.id = 'estilosAlertas';
        estilos.innerHTML = `
            .alerta-flotante {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                border: 2px solid #ff4444;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.5s ease-out;
            }

            @keyframes slideIn {
                from { transform: translateX(100%); }
                to { transform: translateX(0); }
            }

            .alerta-flotante button {
                position: absolute;
                top: 5px;
                right: 5px;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 18px;
            }
        `;
        document.head.appendChild(estilos);
    }
}

function mostrarAlertaCapacidad(espacioRestante, pesoRestante, pctVolumen, pctPeso) {
    agregarEstilosAlertas();

    // Remover alerta anterior si existe
    const alertaAnterior = document.querySelector('.alerta-flotante');
    if (alertaAnterior) alertaAnterior.remove();

    const alerta = document.createElement('div');
    alerta.className = 'alerta-flotante';
    
    // Determinar nivel y color de alerta seg√∫n los nuevos rangos
    let nivelAlerta, colorAlerta;
    const maxPct = Math.max(pctVolumen, pctPeso);

    if (maxPct > 95) {
        nivelAlerta = '‚ö†Ô∏è ¬°ADVERTENCIA!';
        colorAlerta = '#ff4444'; // Rojo
    } else if (maxPct > 85) {
        nivelAlerta = '‚ö†Ô∏è Precauci√≥n';
        colorAlerta = '#ffa500'; // Amarillo
    } else { 
        nivelAlerta = '‚úÖ √ìptimo';
        colorAlerta = '#4CAF50'; // Verde
    }

    alerta.style.borderColor = colorAlerta;

    // Clasificar pedidos actuales con patrones mejorados
    const resumenPedidos = pedidosEnCurso.reduce((acc, pedido) => {
        const desc = (pedido.descripcion || '').toUpperCase();
        const linea = (pedido.linea || '').toUpperCase();
        let categoria;

        // Determinar categor√≠a usando patrones mejorados
        if (desc.match(/AGRICOLA|TRACTOR|R-1|AGR/) || linea.includes('AGRICOLA')) {
            categoria = 'AGRICOLA';
        }
        else if (desc.match(/CAMION|TRAILER|22\.5|24\.5|17\.5|19\.5/) || linea.includes('CAMION')) {
            categoria = 'CAMION';
        }
        else if (desc.match(/OTR|INDUSTRIAL|L-[2-5]|E-[2-4]|25"|33"|35"|49"|SKS|CT85/) || linea.includes('OTR')) {
            categoria = 'OTR/INDUSTRIAL';
        }
        else if (desc.match(/4X4|AT|MT|LT|SUV|PICKUP/) || linea.includes('4X4')) {
            categoria = 'CAMIONETA/SUV';
        }
        else if (desc.match(/AUTO|R13|R14|R15|R16/) || linea.includes('AUTO')) {
            categoria = 'AUTO';
        }
        else {
            categoria = 'OTROS';
        }

        if (!acc[categoria]) acc[categoria] = 0;
        acc[categoria] += pedido.cantidad;
        return acc;
    }, {});

    alerta.innerHTML = `
        <button onclick="this.parentElement.remove()">√ó</button>
        <h4 style="color:${colorAlerta};margin:0 0 10px 0">
            ${nivelAlerta}
        </h4>
        <div style="background:#f5f5f5;padding:12px;border-radius:4px;margin-bottom:10px">
            ${Object.entries(resumenPedidos)
                .filter(([_, cantidad]) => cantidad > 0)
                .map(([categoria, cantidad]) => `
                    <p style="margin:3px 0;font-size:15px;">
                        <b>${categoria}:</b> ${cantidad} llantas
                    </p>
                `).join('')}
        </div>
        <div style="margin:5px 0">
            <p style="color:${colorAlerta}">
                <b>Volumen:</b> ${pctVolumen.toFixed(1)}%
                ${espacioRestante < 0 ? ' (¬°Excedido!)' : ''}
            </p>
            <p style="color:${colorAlerta}">
                <b>Peso:</b> ${pctPeso.toFixed(1)}%
                ${pesoRestante < 0 ? ' (¬°Excedido!)' : ''}
            </p>
        </div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid #eee">
            <p style="margin:5px 0;color:#666;">
                <b>Espacio disponible:</b> ${espacioRestante.toFixed(2)} m¬≥
            </p>
            <p style="margin:5px 0;color:#666;">
                <b>Peso disponible:</b> ${pesoRestante.toFixed(2)} kg
            </p>
        </div>
    `;

    document.body.appendChild(alerta);

    // Auto-eliminar despu√©s de 10 segundos
    setTimeout(() => {
        if (alerta.parentElement) alerta.remove();
    }, 10000);
}

// Agregar esta funci√≥n auxiliar al inicio del archivo
function agregarEstilosAlertas() {
    if (!document.getElementById('estilosAlertas')) {
        const estilos = document.createElement('style');
        estilos.id = 'estilosAlertas';
        estilos.innerHTML = `
            .alerta-flotante {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                border: 2px solid #ff4444;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.5s ease-out;
            }

            @keyframes slideIn {
                from { transform: translateX(100%); }
                to { transform: translateX(0); }
            }

            .alerta-flotante button {
                position: absolute;
                top: 5px;
                right: 5px;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 18px;
            }
        `;
        document.head.appendChild(estilos);
    }
}
function calcularSugerenciasLlantas(espacioRestante, pesoRestante) {
    let sugerencias = [];
    
    // Filtrar llantas que podr√≠an caber
    inventario.forEach(llanta => {
        if (!llanta.volumen || !llanta.peso) return;
        
        const volumenUnitario = parseFloat(llanta.volumen);
        const pesoUnitario = parseFloat(llanta.peso);
        
        if (volumenUnitario > 0 && pesoUnitario > 0) {
            // Calcular cu√°ntas cabr√≠an por volumen y por peso
            const cantidadPorVolumen = Math.floor(espacioRestante / volumenUnitario);
            const cantidadPorPeso = Math.floor(pesoRestante / pesoUnitario);
            
            // Tomar el menor de los dos
            const cantidadPosible = Math.min(cantidadPorVolumen, cantidadPorPeso);
            
            if (cantidadPosible > 0) {
                sugerencias.push({
                    descripcion: llanta.descripcion,
                    cantidad: cantidadPosible
                });
            }
        }
    });

    // Ordenar por cantidad (mayor a menor) y limitar a 5 sugerencias
    return sugerencias
        .sort((a, b) => b.cantidad - a.cantidad)
        .slice(0, 5);
}

// Modificada funci√≥n aceptarPedido para guardar en SheetDB Apartados
async function aceptarPedido() {
    if (!pedidoCamion) {
        alert('Debe seleccionar un cami√≥n v√°lido para aceptar el pedido.');
        return;
    }
    if (pedidosEnCurso.length === 0) {
        alert('El pedido est√° vac√≠o.');
        return;
    }

    try {
        // Solicitar nombre de quien hace el pedido
        const nombrePedido = prompt("Por favor, ingrese el nombre de quien hace el pedido:");
        if (!nombrePedido) {
            throw new Error('Se requiere ingresar un nombre para el pedido');
        }

        // Calcular totales
        let totalVolumen = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.volumen), 0);
        let totalPeso = pedidosEnCurso.reduce((acc, cur) => acc + safeNum(cur.peso), 0);
        let totalCantidad = pedidosEnCurso.reduce((acc, cur) => acc + cur.cantidad, 0);

        // Crear descripci√≥n con vi√±etas
        const descripcionLlantas = pedidosEnCurso.map(p => 
            `‚Ä¢ ${p.cantidad} x ${p.descripcion}`
        ).join('\n');

        // Debug: ver estructura de pedidoCamion
        console.log('Estructura de pedidoCamion:', pedidoCamion);
        
        // Asegurarse de obtener el n√∫mero econ√≥mico correcto
        let numEconomico = '';
        if (pedidoCamion && pedidoCamion.economico) {
            numEconomico = pedidoCamion.economico.toString();
        }
        // Si no lo encontramos en pedidoCamion, intentar obtenerlo del input
        if (!numEconomico) {
            numEconomico = document.getElementById('inputPedidoNumEconomico').value.trim();
        }
        console.log('N√∫mero econ√≥mico a enviar:', numEconomico);
        
        // Preparar los datos en el nuevo formato
        const pedidoConfirmado = {
            "Fecha": new Date().toLocaleDateString(),
            "Unidad": pedidoCamion.unidad || "",
            "Econ√≥mico": numEconomico || "3504",  // Usar el n√∫mero econ√≥mico encontrado con tilde
            "Nombre": nombrePedido,
            "Llantas": String(totalCantidad),
            "Descripcion": descripcionLlantas,
            "Volumen": String(totalVolumen.toFixed(2)),
            "Peso": String(totalPeso.toFixed(2))
        };

        // Enviar los datos a la hoja de c√°lculo de Apartados
        const response = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Apartados', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                data: [pedidoConfirmado]
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error respuesta SheetDB:', {
                status: response.status,
                statusText: response.statusText,
                body: errorText
            });
            throw new Error(`Error al guardar en Apartados: ${response.status} ${errorText}`);
        }

        // Si todo sali√≥ bien, limpiar el pedido en curso
        pedidosEnCurso = [];
        renderPedidosActuales();
        
        // Actualizar la vista de pedidos Apartados
        await fetchPedidosApartados();
        
        // Limpiar la informaci√≥n del cami√≥n
        pedidoCamion = null;
        document.getElementById('datosCamionPedido').innerText = '';
        document.getElementById('inputPedidoNumEconomico').value = '';
        
        // Cambiar a la pesta√±a de Apartados
        document.querySelector('[data-tab="pedidos-Apartados"]').click();
        
        alert('Pedido guardado exitosamente');
            document.getElementById('inputPedidoNumEconomico').value = '';
            renderPedidosActuales();
            actualizarGraficas();
            alert('Pedido aceptado y guardado en pedidos Apartados.');
            renderPedidosApartados();
        } catch (error) {
            alert('Error al guardar el pedido confirmado: ' + error.message);
        }
    }

    // -- Renderizar pedidos Apartados --
function renderPedidosApartados() {
    const tbody = document.querySelector('#tabla tbody');
    tbody.innerHTML = '';
    pedidosApartados.forEach((pedido, idx) => {
        const tr = document.createElement('tr');
        
        // Separar las descripciones y cantidades
        const descripciones = pedido.Descripcion ? pedido.Descripcion.split(' || ') : [];
        const cantidades = pedido.Cantidad ? pedido.Cantidad.split(' || ') : [];
        
        // Crear una lista formateada de descripciones y cantidades
        const detallesLlantas = descripciones.map((desc, i) => {
            const cantidad = cantidades[i] || '0';
            return `<li>${desc}: ${cantidad} unidades</li>`;
        }).join('');

        tr.innerHTML = `
            <td>${pedido.Unidad || pedido.camion || ''}</td>
            <td>${pedido.Llantas || ''}</td>
            <td>
                <ul style="padding-left:18px;margin:0;list-style-type:none;">
                    ${detallesLlantas}
                </ul>
            </td>
            <td>
                <ul style="padding-left:18px;margin:0;">
                    ${cantidades.map(q => `<li style="text-align:left;">${q.trim()} unidades</li>`).join('')}
                </ul>
            </td>
            <td>${pedido.Llantas || pedido["total,cantidad"] || ''}</td>
            <td>${pedido.linea || ''}</td>
            <td>${Number(pedido.Volumen || pedido.volumen).toLocaleString('es-MX', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
            <td>${Number(pedido.peso).toLocaleString('es-MX', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
            <td>$${Number(pedido.valor).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>${pedido.fecha || ''}</td>
            <td style="min-width: 300px;">
               <button onclick="editarPedidoConfirmado(${idx})" class="btn btn-sm btn-primary">Editar</button>
                <button onclick="cancelarPedido(${idx})" class="btn btn-sm btn-danger">Quitar</button>
            </td>`;
        tbody.appendChild(tr);
    }); 
}
    function cancelarPedido(idx) {
        if (confirm('¬øSeguro que desea cancelar este pedido?')) {
            const pedidoACancelar = pedidosApartados[idx];
            // Opcional: Podr√≠as agregar l√≥gica para eliminar en SheetDB tambi√©n
            pedidosApartados.splice(idx, 1);
            renderPedidosApartados();
        }
    }
    // Modificar la funci√≥n reservarPedido()
    async function reservarPedido(idx) {
    const pedido = pedidosApartados[idx];
    if (!pedido) return;

    try {
        // Pedir el nombre del bloque al usuario
        const nombreBloque = prompt("Ingrese el nombre para el bloque de reserva:", "");
        if (!nombreBloque) {
            alert("Debe ingresar un nombre para el bloque");
            return;
        }
        
        // Usar el nombre del bloque + _1 como identificador
        const nombreReserva = `${nombreBloque}_1`;
        
        const llantas = pedido.llantas.split(',').map(l => l.trim());
        const descripciones = pedido.descripcion.split(',').map(d => d.trim());
        const cantidades = pedido.cantidad.split(',').map(c => c.trim());
        const lineas = pedido.linea.split(',').map(l => l.trim());

        const registrosReserva = llantas.map((llanta, i) => ({
            nombre: nombreReserva, // Usar el nuevo nombre
            C√≥digo: llanta,
            Descripci√≥n: descripciones[i] || '',
            L√≠nea: lineas[i] || '',
            Cantidad: cantidades[i] || '0',
            'Volumen Total': (Number(pedido.volumen) / llantas.length).toFixed(3),
            'Peso Total': (Number(pedido.peso) / llantas.length).toFixed(3),
            'Valor Total ($)': (Number(pedido.valor) / llantas.length).toFixed(2)
        }));

        const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=reservados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: registrosReserva })
        });

        if (!res.ok) throw new Error('Error al guardar reserva');

        await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/camion/${pedido.camion}?sheet=Apartados`, {
            method: 'DELETE'
        });

        pedidosApartados.splice(idx, 1);
        renderPedidosApartados();
        alert('Pedido reservado exitosamente como: ' + nombreReserva);

    } catch (error) {
        console.error('Error al reservar:', error);
        alert('Error al reservar el pedido: ' + error.message);
    }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
<script>
// ...existing code...

// Variables globales para el sistema de facturas
const facturaPdfInput = document.getElementById('facturaPdfInput');
const facturaScanBtn = document.getElementById('facturaScanBtn');
const facturaResultDiv = document.getElementById('facturaResult');
const facturaLoadingDiv = document.getElementById('facturaLoading');
const facturaClearBtn = document.getElementById('facturaClearBtn');
const facturaProgressBar = document.getElementById('facturaProgressBar');

// Variables globales para el manejo de datos
let bloquesFacturas = []; 
let archivosEscaneados = []; 
let facturasParaGuardar = [];
let llantasAcumuladasEnBloque = []; // Variable para acumular llantas en el modo de b√∫squeda

// Variables nuevas para el sistema de bloques
let extractedData = [];
let escaneosActuales = []; // Para almacenar temporalmente los escaneos antes de formar el bloque


// Event listener para el bot√≥n de limpiar cach√©
document.getElementById('facturasEspecialesCacheClearBtn').onclick = () => {
    if (confirm('¬øEst√°s seguro de que deseas eliminar todos los datos en cach√© de facturas especiales?')) {
        const cacheKeys = Object.keys(localStorage).filter(key => 
            key.startsWith('factura_especial_')
        );
        
        if (cacheKeys.length > 0) {
            cacheKeys.forEach(key => localStorage.removeItem(key));
            alert('Cach√© de facturas especiales limpiado exitosamente');
            
            // Limpiar tambi√©n la interfaz
            document.getElementById('extractedData').innerHTML = '';
            document.getElementById('log').style.display = 'none';
            document.getElementById('fileInput').value = '';
        } else {
            alert('No hay datos en cach√© para limpiar');
        }
    }
};

// Agregar con los otros event listeners
document.getElementById('facturaCacheClearBtn').onclick = () => {
    if (confirm('¬øEst√°s seguro de que deseas eliminar todos los datos en cach√©?')) {
        const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('pdf_'));
        cacheKeys.forEach(key => localStorage.removeItem(key));
        alert('Cach√© limpiado exitosamente');
    }
};

// Agregar estas funciones para manejo de cach√©
function getCacheKey(file) {
    return `pdf_${file.name}_${file.lastModified}_${file.size}`;
}

function getCache(key) {
    try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        // Verificar si el cach√© tiene m√°s de 24 horas
        if (Date.now() - data.timestamp > 24 * 60 * 60 * 1000) {
            localStorage.removeItem(key);
            return null;
        }
        return data.content;
    } catch (e) {
        console.error('Error al leer cach√©:', e);
        return null;
    }
}

function setCache(key, data) {
    try {
        const cacheData = {
            timestamp: Date.now(),
            content: data
        };
        localStorage.setItem(key, JSON.stringify(cacheData));
    } catch (e) {
        console.error('Error al guardar cach√©:', e);
    }
}

// Modificar el onclick del bot√≥n de escaneo
facturaScanBtn.onclick = async () => {
    const files = Array.from(facturaPdfInput.files);
    if (files.length === 0) {
        alert('Por favor, selecciona al menos un archivo PDF.');
        return;
    }

    // Agregar opciones de cach√©
    const usarCache = confirm('¬øDeseas usar datos en cach√© si est√°n disponibles? (Selecciona "No" para forzar un nuevo escaneo)');

    facturaLoadingDiv.style.display = 'block';
    facturaProgressBar.style.display = 'block';

    try {
        const BATCH_SIZE = 2;
        for (let i = 0; i < files.length; i += BATCH_SIZE) {
            const batch = files.slice(i, i + BATCH_SIZE);
            await Promise.all(batch.map(async file => {
                const cacheKey = getCacheKey(file);
                
                // Verificar cach√© solo si el usuario lo permite
                if (usarCache) {
                    const cachedData = getCache(cacheKey);
                    if (cachedData) {
                        console.log(`Usando cach√© para ${file.name}`);
                        archivosEscaneados.push(cachedData);
                        mostrarArchivosEscaneados();
                        return;
                    }
                }

                // Si no hay cach√© o no se quiere usar, procesar el archivo
                console.log(`Escaneando ${file.name}`);
                
                // ... resto del c√≥digo de procesamiento ...
                
                // Al final del procesamiento exitoso:
                const resultado = { nombreArchivo: file.name, productos };
                setCache(cacheKey, resultado);
                archivosEscaneados.push(resultado);
                mostrarArchivosEscaneados();
            }));
        }

        // ... resto del c√≥digo ...

    } catch (e) {
        console.error('Error en procesamiento:', e);
        alert('Ocurri√≥ un error durante el escaneo: ' + e.message);
    } finally {
        facturaLoadingDiv.style.display = 'none';
        facturaProgressBar.style.display = 'none';
    }
};

// Agregar bot√≥n para limpiar cach√©
function agregarBotonLimpiarCache() {
    const botonLimpiarCache = document.createElement('button');
    botonLimpiarCache.className = 'btn btn-warning';
    botonLimpiarCache.innerHTML = '<i class="bi bi-trash"></i> Limpiar Cach√©';
    botonLimpiarCache.onclick = () => {
        if (confirm('¬øEst√°s seguro de que deseas eliminar todos los datos en cach√©?')) {
            const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('pdf_'));
            cacheKeys.forEach(key => localStorage.removeItem(key));
            alert('Cach√© limpiado exitosamente');
        }
    };
    
    // Insertar el bot√≥n junto a los otros controles
    const controlsContainer = document.querySelector('#facturaScanBtn').parentElement;
    controlsContainer.appendChild(botonLimpiarCache);
}

// Llamar a esta funci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    agregarBotonLimpiarCache();
    // Cargar los bloques de facturas al iniciar la p√°gina
    actualizarBloquesFacturas().then(success => {
        if (!success) {
            console.error('No se pudieron cargar los bloques de facturas inicialmente');
        }
    });
});
// Agregar antes de facturaScanBtn.onclick (aproximadamente l√≠nea 1850)
async function compressImage(canvas) {
    return new Promise((resolve) => {
        canvas.toBlob((blob) => {
            resolve(blob);
        }, 'image/jpeg', 0.7);
    });
}
// Bot√≥n Limpiar
// ...existing code...
facturaClearBtn.onclick = () => {
    facturaPdfInput.value = '';
    facturaResultDiv.textContent = '';
    archivosEscaneados = [];
    facturasParaGuardar = [];
    mostrarArchivosEscaneados();
    facturaLoadingDiv.style.display = 'none'; // <-- agrega esto para ocultar el spinner
    facturaProgressBar.style.display = 'none';
    // NO borres bloquesFacturas aqu√≠
};
// ...existing code...

// Modificar la funci√≥n agregarNuevosProductosAlInventario
async function agregarNuevosProductosAlInventario(productos) {
    try {
        if (!Array.isArray(productos) || productos.length === 0) {
            console.log('No hay productos para procesar');
            return 0;
        }

        // Obtener inventario actual
        const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o');
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
        const inventarioActual = await res.json();

        // Crear Set de c√≥digos existentes
        const codigosInventario = new Set(
            inventarioActual.map(item => item.clave?.toString().trim())
                .filter(Boolean)
        );

        // Filtrar productos nuevos
        const nuevos = productos.filter(p => {
            const codigo = p.C√≥digo?.toString().trim();
            return codigo && !codigosInventario.has(codigo);
        });

        console.log(`Se encontraron ${nuevos.length} productos nuevos`);

        // Array para productos que no se pudieron procesar
        const fallos = [];
        let procesados = 0;

        // Procesar en lotes de 50
        const BATCH_SIZE = 50;
        for (let i = 0; i < nuevos.length; i += BATCH_SIZE) {
            const lote = nuevos.slice(i, i + BATCH_SIZE);
            
            // Preparar productos con volumen calculado
            const productosValidos = [];
            
            for (const producto of lote) {
                try {
                    const desc = producto.Descripci√≥n?.trim().toUpperCase();
                    if (!desc) continue;

                    // Calcular volumen basado en la descripci√≥n
                    let volumen = 0;
                    const medidasMatch = desc.match(/(\d+)[\/\s]?(?:x|\/)?(\d+)?[\/\s]?[R]?(\d+\.?\d*)/);
                    
                    if (medidasMatch) {
                        const ancho = Number(medidasMatch[1]) * 25.4 / 1000;
                        const perfil = medidasMatch[2] ? Number(medidasMatch[2])/100 : 0.80;
                        const rin = Number(medidasMatch[3]) * 0.0254;
                        
                        const alturaFlanco = ancho * perfil;
                        const diametroExterno = rin + (2 * alturaFlanco);
                        volumen = Math.PI * Math.pow(diametroExterno/2, 2) * ancho * 1.05;
                    }

                    productosValidos.push({
                        clave: producto.C√≥digo?.trim(),
                        descripcion: desc,
                        linea: determinarTipoLlanta(desc),
                        peso: '', // Para llenado manual
                        volumen: volumen.toFixed(4),
                        valor: '' // Para llenado manual
                    });

                } catch (error) {
                    fallos.push({
                        codigo: producto.C√≥digo,
                        error: error.message
                    });
                }
            }

            if (productosValidos.length > 0) {
                try {
                    const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: productosValidos })
                    });

                    if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
                    procesados += productosValidos.length;

                    // Actualizar inventario local
                    inventario.push(...productosValidos);

                } catch (error) {
                    console.error('Error al agregar lote:', error);
                    fallos.push(...productosValidos.map(p => ({
                        codigo: p.clave,
                        error: 'Error al guardar en base de datos'
                    })));
                }
            }
        }

        // Mostrar resumen
        const mensaje = `
            Proceso completado:
            - Total productos nuevos: ${nuevos.length}
            - Productos agregados: ${procesados}
            - Productos fallidos: ${fallos.length}
        `;
        
        console.log(mensaje);
        alert(mensaje);

        if (fallos.length > 0) {
            console.log('Productos fallidos:', fallos);
        }

        return procesados;

    } catch (error) {
        console.error('Error general:', error);
        alert('Error al procesar productos: ' + error.message);
        return 0;
    }
}

// Funciones auxiliares
function determinarTipoLlanta(descripcion = '') {
    const desc = descripcion.toUpperCase();
    if (desc.match(/AGRICOLA|TRACTOR|R-1|AGR/)) return 'AGRICOLA';
    if (desc.match(/OTR|INDUSTRIAL|L-[2-5]|E-[2-4]|25"|33"|35"|49"/)) return 'OTR';
    if (desc.match(/CAMION|TRAILER|22.5|24.5|17.5|19.5/)) return 'CAMION';
    if (desc.match(/4X4|AT|MT|LT|SUV|PICKUP/)) return '4X4';
    return 'AUTO'; 
}

async function calcularVolumenProducto(producto) {
    // ... l√≥gica existente de c√°lculo de volumen ...
    // Se mantiene igual pero en funci√≥n separada para mejor organizaci√≥n
}
  
// ...dentro de facturaScanBtn.onclick...
// Escanear y mostrar tabla + barra para nombre
// ...existing code...
facturaScanBtn.onclick = async () => {
    const files = Array.from(facturaPdfInput.files);
    if (files.length === 0) {
        alert('Por favor, selecciona al menos un archivo PDF.');
        return;
    }

    facturaLoadingDiv.style.display = 'block';
    facturaProgressBar.style.display = 'block';

    try {
        // Procesar PDFs en lotes
        const BATCH_SIZE = 2;
        for (let i = 0; i < files.length; i += BATCH_SIZE) {
            const batch = files.slice(i, i + BATCH_SIZE);
            await Promise.all(batch.map(async file => {
                // Verificar cach√©
                const cacheKey = `pdf_${file.name}_${file.lastModified}`;
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const cachedData = JSON.parse(cached);
                    archivosEscaneados.push(cachedData);
                    mostrarArchivosEscaneados();
                    return;
                }

                const reader = new FileReader();
                await new Promise(resolve => {
                    reader.onload = async function() {
                        // Configuraci√≥n optimizada para el PDF
                        const pdfOptions = {
                            scale: 1.5,
                            maxImageSize: 2000
                        };

                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let extractedText = '';

                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const viewport = page.getViewport({ scale: pdfOptions.scale });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            
                            // Limitar tama√±o m√°ximo
                            const ratio = Math.min(pdfOptions.maxImageSize / viewport.width, 
                                                 pdfOptions.maxImageSize / viewport.height);
                            canvas.width = viewport.width * ratio;
                            canvas.height = viewport.height * ratio;
                            
                            await page.render({ 
                                canvasContext: context, 
                                viewport: viewport,
                                transform: [ratio, 0, 0, ratio, 0, 0]
                            }).promise;

                            // Comprimir imagen antes del OCR
                            const compressedDataUrl = await compressImage(canvas);
                            
                            // OCR optimizado
                            const { data: { text } } = await Tesseract.recognize(
                                compressedDataUrl, 
                                'spa',
                                {
                                    logger: m => {
                                        facturaProgressBar.value = Math.round(m.progress * 100);
                                        facturaLoadingDiv.innerHTML = `
                                            <div class="spinner-border text-info"></div>
                                            <p>PDF ${i+1}/${files.length} - P√°gina ${pageNum}/${pdf.numPages}: ${Math.round(m.progress*100)}%</p>
                                        `;
                                    },
                                    tessedit_pageseg_mode: '1',
                                    tessedit_ocr_engine_mode: '2'
                                }
                            );
                            extractedText += text + '\n';
                        }

                        // Extraer datos con expresiones regulares optimizadas
                        const extraerDato = (regex) => (extractedText.match(regex) || [])[1] || '';
                        const datos = {
                            folio: extraerDato(/FOLIO\s*[:\-]?\s*([A-Za-z0-9\-]+)/i),
                            fecha: extraerDato(/FECHA DE EMISION\s*[:\-]?\s*([0-9\/\:\. ]+)/i),
                            usuario: extraerDato(/USUARIO\s*[:\-]?\s*([A-Za-z\s]+)/i)
                        };

                        // Procesar productos con regex mejorado
                        const textoLimpio = extractedText
                            .replace(/\r/g, '')
                            .replace(/[ ]{2,}/g, ' ')
                            .replace(/^\s*$/gm, '');

                        const productos = [];
                        const productoRegex = /^\s*(\d+)\s+([A-Za-z0-9\-]+)\s+(.+)$/gm;
                        let match;

                        while ((match = productoRegex.exec(textoLimpio)) !== null) {
                            if (!match[2] || !match[3] || 
                                match[2].toUpperCase() === 'C√ìDIGO' || 
                                match[3].toUpperCase() === 'DESCRIPCI√ìN') continue;

                            productos.push({
                                Folio: datos.folio,
                                "Fecha de Emisi√≥n": datos.fecha,
                                Usuario: datos.usuario,
                                Cantidad: match[1],
                                C√≥digo: match[2],
                                Descripci√≥n: match[3].trim()
                            });
                        }

                        const resultado = { nombreArchivo: file.name, productos };
                        
                        // Guardar en cach√©
                        localStorage.setItem(cacheKey, JSON.stringify(resultado));
                        
                        archivosEscaneados.push(resultado);
                        mostrarArchivosEscaneados();
                        resolve();
                    };
                    reader.readAsArrayBuffer(file);
                });
            }));
        }

        // Actualizar productos para guardar
        facturasParaGuardar = archivosEscaneados.flatMap(a => a.productos);
        
        // Mostrar resumen
        mostrarResumenEscaneo();

    } catch (e) {
        console.error('Error en procesamiento:', e);
        alert('Ocurri√≥ un error durante el escaneo: ' + e.message);
    } finally {
        facturaLoadingDiv.style.display = 'none';
        facturaProgressBar.style.display = 'none';
    }
};
// Funci√≥n auxiliar para comprimir im√°genes
async function compressImage(canvas) {
    return new Promise((resolve) => {
        canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.7);
    });
}

// Funci√≥n para mostrar resumen del escaneo
function mostrarResumenEscaneo() {
    let html = `
        <h5 class="mt-4 mb-2">Productos acumulados en el bloque:</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Folio</th>
                    <th>Fecha de Emisi√≥n</th>
                    <th>Usuario</th>
                    <th>Cantidad</th>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    facturasParaGuardar.forEach(p => {
        html += `
            <tr>
                <td>${p.Folio}</td>
                <td>${p["Fecha de Emisi√≥n"]}</td>
                <td>${p.Usuario}</td>
                <td>${p.Cantidad}</td>
                <td>${p.C√≥digo}</td>
                <td>${p.Descripci√≥n}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    facturaResultDiv.innerHTML = html;
}
// ...existing code...
document.getElementById('btnTerminarBloqueFactura').onclick = async () => {
    const nombreBloque = document.getElementById('nombreBloqueFactura').value.trim() || 'Sin nombre';
    facturasParaGuardar = archivosEscaneados.flatMap(a => a.productos);
    if (facturasParaGuardar.length === 0) {
        alert('No hay productos para guardar.');
        return;
    }
    // Agrega el nombre del bloque a cada producto
     facturasParaGuardar.forEach(p => p.Nombre = nombreBloque);

    bloquesFacturas.push({ nombre: nombreBloque, datos: facturasParaGuardar });
    await guardarFacturasEnSheetDB(facturasParaGuardar);
    await agregarNuevosProductosAlInventario(facturasParaGuardar);
    facturaResultDiv.textContent = '';
    archivosEscaneados = [];
    facturasParaGuardar = [];
    mostrarArchivosEscaneados();
    mostrarBloquesFacturas();
};
// ...existing code...
// filepath: c:\Users\mg296\OneDrive\Escritorio\cubicaja\Proyecto_de_residencia_profesional.html
// ...existing code...
// Guardar en SheetDB (m√°s r√°pido: POST en lote)
async function guardarFacturasEnSheetDB(facturas) {
    try {
        await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=facturas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: facturas }) // Enviar array
        });
    } catch (e) {
        console.error('Error al guardar facturas:', e);
    }
}
// ...existing code...
function mostrarArchivosEscaneados() {
    let html = `<h5 class="mt-4 mb-2">Archivos escaneados:</h5>`;
    archivosEscaneados.forEach((archivo, idx) => {
        html += `
            <div style="margin-bottom:8px;">
                <b>${archivo.nombreArchivo}</b>
                <button class="btn btn-danger btn-sm" onclick="eliminarArchivoEscaneado(${idx})">Eliminar</button>
                <table class="table table-bordered mt-2">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Fecha de Emisi√≥n</th>
                            <th>Usuario</th>
                            <th>Cantidad</th>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${archivo.productos.map(p => `
                            <tr>
                                <td>${p.Folio}</td>
                                <td>${p["Fecha de Emisi√≥n"]}</td>
                                <td>${p.Usuario}</td>
                                <td>${p.Cantidad}</td>
                                <td>${p.C√≥digo}</td>
                                <td>${p.Descripci√≥n}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    });
    
    facturaResultDiv.innerHTML = html;


}

// Agregar esta nueva funci√≥n para manejar el toggle
function toggleDetalleArchivo(idx) {
    const detalle = document.getElementById(`detalleArchivo${idx}`);
    const icon = document.querySelector(`.toggle-icon-archivo-${idx}`);
    
    if (detalle.classList.contains('show')) {
        detalle.classList.remove('show');
        icon.textContent = '‚ñº';
    } else {
        detalle.classList.add('show');
        icon.textContent = '‚ñ≤';
    }
}

function eliminarArchivoEscaneado(idx) {
    archivosEscaneados.splice(idx, 1);
    facturaPdfInput.value = ''; // Limpia el input de archivos
    mostrarArchivosEscaneados();
}

// Mostrar todos los bloques en la p√°gina
// Modificar la funci√≥n mostrarBloquesFacturas()
function mostrarBloquesFacturas(filtro = '') {
    console.log('Mostrando bloques de facturas, total:', bloquesFacturas?.length || 0);
    
    const container = document.getElementById('facturaGroupsContainer');
    if (!container) {
        console.error('No se encontr√≥ el contenedor de facturas');
        return;
    }
    
    // Limpiar el contenedor primero
    container.innerHTML = '';

    if (!bloquesFacturas || bloquesFacturas.length === 0) {
        console.log('No hay bloques de facturas para mostrar');
        container.innerHTML = '<div class="alert alert-info">No hay bloques de facturas guardados.</div>';
        return;
    }

    console.log('Bloques a mostrar:', bloquesFacturas);

    // Eliminar duplicados bas√°ndose en el nombre del bloque
    const bloquesSinDuplicados = bloquesFacturas.reduce((acc, current) => {
        const x = acc.find(item => item.nombre === current.nombre);
        if (!x) {
            acc.push(current);
        }
        return acc;
    }, []);

    // Mostrar bloques filtrados y sin duplicados
    bloquesSinDuplicados
        .filter(b => b.nombre.toLowerCase().includes(filtro.toLowerCase()))
        .forEach((bloque, idx) => {
            const bloqueHTML = `
                <div class="card mb-2" id="bloqueFactura${idx}">
                    <div class="card-header d-flex justify-content-between align-items-center" 
                         style="cursor:pointer;" 
                         onclick="toggleDetalleBloque(${idx})">
                        <strong>${bloque.nombre}</strong>
                        <span class="toggle-icon">‚ñº</span>
                        <button class="btn btn-danger btn-sm" 
                                onclick="event.stopPropagation(); eliminarBloqueFactura(${idx})">
                            Eliminar bloque
                        </button>
                    </div>
                    <div class="card-body collapse" id="detalleBloque${idx}">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Folio</th>
                                    <th>Fecha de Emisi√≥n</th>
                                    <th>Usuario</th>
                                    <th>Cantidad</th>
                                    <th>C√≥digo</th>
                                    <th>Descripci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bloque.datos.map((f, idx) => `
                                    <tr>
                                        <td>${idx === 0 ? f.Folio : ''}</td>
                                        <td>${idx === 0 ? f["Fecha de Emisi√≥n"] : ''}</td>
                                        <td>${idx === 0 ? f.Usuario : ''}</td>
                                        <td>${f.Cantidad || ''}</td>
                                        <td>${f.C√≥digo || ''}</td>
                                        <td>${f.Descripci√≥n || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.innerHTML += bloqueHTML;
        });
}
async function actualizarBloquesFacturas() {
    try {
        console.log('Iniciando actualizaci√≥n de bloques de facturas...');
        
        const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=facturas');
        if (!res.ok) throw new Error(`No se pudo cargar facturas. Status: ${res.status}`);
        
        const facturas = await res.json();
        console.log('Datos recibidos de la hoja:', facturas);

        if (!Array.isArray(facturas) || facturas.length === 0) {
            console.log('No hay facturas para mostrar');
            bloquesFacturas = [];
            mostrarBloquesFacturas();
            return true;
        }

        bloquesFacturas = [];
        let grupos = {};
        
        // Agrupar facturas por nombre/folio
        facturas.forEach(f => {
            if (!f) return; // Ignorar registros nulos
            
            // Intentar obtener un identificador v√°lido para el grupo
            const grupo = f.Nombre || f.Folio || f["Fecha de Emisi√≥n"] || 'Sin nombre';
            console.log('Procesando factura para grupo:', grupo, f);
            
            if (!grupos[grupo]) {
                grupos[grupo] = [];
            }
            grupos[grupo].push(f);
        });
        
        // Convertir grupos en bloques
        for (const nombre in grupos) {
            if (grupos[nombre].length > 0) {
                bloquesFacturas.push({
                    nombre,
                    datos: grupos[nombre]
                });
            }
        }
        
        console.log('Bloques procesados:', bloquesFacturas);
        
        // Actualizar la visualizaci√≥n
        mostrarBloquesFacturas();
        return true;
    } catch (error) {
        console.error('Error actualizando bloques:', error);
        console.error('Stack trace:', error.stack);
        // Mostrar mensaje de error en la interfaz
        const container = document.getElementById('facturaGroupsContainer');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error al cargar los bloques: ${error.message}
                </div>
            `;
        }
        return false;
    }
}
// Modificar la funci√≥n toggleDetalleBloque()
function toggleDetalleBloque(idx) {
    const detalle = document.getElementById(`detalleBloque${idx}`);
    const icon = detalle.parentElement.querySelector('.toggle-icon');
    
    if (detalle.style.display === 'none' || !detalle.style.display) {
        detalle.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        detalle.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Agrega esta funci√≥n para expandir/colapsar el detalle
function mostrarDetalles(idx) {
    const detalle = document.getElementById(`detalles_${idx}`);
    const bloque = bloquesFacturas[idx];
    
    if (detalle.style.display === 'none') {
        // Generar contenido de detalles
        detalle.innerHTML = `
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Cantidad</th>
                        <th>C√≥digo</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${bloque.datos.map(item => `
                        <tr>
                            <td>${item.Cantidad || ''}</td>
                            <td>${item.C√≥digo || ''}</td>
                            <td>${item.Descripci√≥n || ''}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        detalle.style.display = 'block';
    } else {
        detalle.style.display = 'none';
    }
}

// Funciones para el manejo de modos en Sugerencia de Unidad
function cambiarModoSugerencia(modo) {
    const modoCalculadora = document.getElementById('modoCalculadora');
    const modoBusqueda = document.getElementById('modoBusqueda');
    const btnCalculadora = document.getElementById('btnModoCalculadora');
    const btnBusqueda = document.getElementById('btnModoBusqueda');

    if (modo === 'calculadora') {
        modoCalculadora.style.display = 'block';
        modoBusqueda.style.display = 'none';
        btnCalculadora.classList.add('active');
        btnBusqueda.classList.remove('active');
    } else {
        modoCalculadora.style.display = 'none';
        modoBusqueda.style.display = 'block';
        btnCalculadora.classList.remove('active');
        btnBusqueda.classList.add('active');
    }
}

// Funci√≥n para buscar bloques
function calcularTotalesBloque(datos) {
    let totalVolumen = 0;
    let totalPeso = 0;
    let cantidadTotal = 0;
    
    datos.forEach(item => {
        const cantidad = parseInt(item.Cantidad) || 0;
        cantidadTotal += cantidad;
        
        // Aqu√≠ deber√≠as obtener el volumen y peso por tipo de llanta
        const tipoLlanta = determinarTipoLlanta(item.Descripci√≥n);
        const { volumen, peso } = obtenerMedidasPorTipo(tipoLlanta);
        
        totalVolumen += cantidad * volumen;
        totalPeso += cantidad * peso;
    });
    
    return { totalVolumen, totalPeso, cantidadTotal };
}

function determinarTipoLlanta(descripcion) {
    // L√≥gica para determinar el tipo de llanta basado en la descripci√≥n
    descripcion = descripcion.toLowerCase();
    if (descripcion.includes('auto') || descripcion.includes('compacto')) return 'AUTO';
    if (descripcion.includes('suv') || descripcion.includes('camioneta')) return 'SUV_CAMIONETA';
    if (descripcion.includes('comercial')) return 'COMERCIAL_LIGERO';
    if (descripcion.includes('camion')) return 'PESADO';
    if (descripcion.includes('agricola') || descripcion.includes('minero')) return 'AGRICOLA_MINERO';
    return 'AUTO'; // por defecto
}

function obtenerMedidasPorTipo(tipo) {
    const medidas = {
        'AUTO': { volumen: 0.047, peso: 7 },
        'SUV_CAMIONETA': { volumen: 0.075, peso: 15 },
        'COMERCIAL_LIGERO': { volumen: 0.12, peso: 25 },
        'PESADO': { volumen: 0.25, peso: 50 },
        'AGRICOLA_MINERO': { volumen: 0.5, peso: 100 }
    };
    return medidas[tipo] || medidas['AUTO'];
}

function seleccionarBloque(idx) {
    const bloque = bloquesFacturas[idx];
    
    // Limpiar b√∫squeda y ocultar resultados
    document.getElementById('busquedaBloque').value = '';
    document.getElementById('resultadosBusqueda').innerHTML = '';
    
    // Mostrar la secci√≥n de unidad sugerida para el modo b√∫squeda
    const seccionUnidadSugerida = document.getElementById('seccionUnidadSugeridaBusqueda');
    if (seccionUnidadSugerida) {
        seccionUnidadSugerida.style.display = 'block';
        
        // Mostrar expl√≠citamente la tabla y sus contenedores
        const tableResponsive = seccionUnidadSugerida.querySelector('.table-responsive');
        const table = seccionUnidadSugerida.querySelector('table');
        
        if (tableResponsive) tableResponsive.style.display = 'block';
        if (table) table.style.display = 'table';
        
        // Asegurarse de que la secci√≥n tenga altura suficiente
        seccionUnidadSugerida.style.minHeight = '200px';
    }
    
    // Variables globales para acumular bloques
    if (!window.bloquesAcumulados) {
        window.bloquesAcumulados = {
            llantas: [],
            volumenTotal: 0,
            pesoTotal: 0,
            totalLlantas: 0
        };
    }

    let volumenTotalBloque = 0;
    let pesoTotalBloque = 0;
    let totalLlantas = 0;
    
        function limpiarBloquesAcumulados() {
        // Reiniciar los valores acumulados
        window.bloquesAcumulados = {
            llantas: [],
            volumenTotal: 0,
            pesoTotal: 0,
            totalLlantas: 0
        };

        // Limpiar la tabla de sugerencias
        const tablaLlantas = document.getElementById('tablaLlantasSeleccionadas').querySelector('tbody');
        if (tablaLlantas) {
            tablaLlantas.innerHTML = '';
        }

        // Limpiar las unidades sugeridas
        const tablaSugerencias = document.getElementById('tablaUnidadesSugeridasBusqueda');
        if (tablaSugerencias) {
            tablaSugerencias.innerHTML = '';
        }

        // Ocultar el resumen de carga
        const totalLlantasDiv = document.getElementById('totalLlantas');
        if (totalLlantasDiv) {
            totalLlantasDiv.style.display = 'none';
        }

        // Mostrar mensaje al usuario
        mostrarAlerta('Bloques limpiados exitosamente', 'success');
    }

    // Calcular totales para cada llanta
    const llantas = bloque.datos.map(item => {
        const cantidad = parseInt(item.Cantidad) || 0;
        totalLlantas += cantidad;
        
        // Buscar la llanta en el inventario para obtener valores reales
        const llantaInventario = inventario.find(l => l.clave === item.C√≥digo);
        let volumenUnitario = 0;
        let pesoUnitario = 0;
        
        if (llantaInventario) {
            volumenUnitario = parseFloat(llantaInventario.volumen) || 0;
            pesoUnitario = parseFloat(llantaInventario.peso) || 0;
        } else {
            // Si no se encuentra en inventario, usar medidas estimadas
            const medidas = obtenerMedidasPorTipo(determinarTipoLlanta(item.Descripci√≥n));
            volumenUnitario = medidas.volumen;
            pesoUnitario = medidas.peso;
        }
        
        const volumenTotal = volumenUnitario * cantidad;
        const pesoTotal = pesoUnitario * cantidad;
        
        volumenTotalBloque += volumenTotal;
        pesoTotalBloque += pesoTotal;
        
        return {
            descripcion: item.Descripci√≥n,
            cantidad: cantidad,
            codigo: item.C√≥digo,
            volumenUnitario: volumenUnitario,
            pesoUnitario: pesoUnitario,
            volumenTotal: volumenTotal,
            pesoTotal: pesoTotal
        };
    });
    
    // Acumular los datos en las variables globales
    window.bloquesAcumulados.llantas = window.bloquesAcumulados.llantas.concat(llantas);
    window.bloquesAcumulados.volumenTotal += volumenTotalBloque;
    window.bloquesAcumulados.pesoTotal += pesoTotalBloque;
    window.bloquesAcumulados.totalLlantas += totalLlantas;

    // Calcular totales generales (ahora usando los acumulados)
    const totalVolumen = window.bloquesAcumulados.volumenTotal;
    const totalPeso = window.bloquesAcumulados.pesoTotal;
    const cantidadTotal = window.bloquesAcumulados.totalLlantas;
    
    // Actualizar tabla de llantas seleccionadas
    const tablaLlantas = document.getElementById('tablaLlantasSeleccionadas').querySelector('tbody');
    tablaLlantas.innerHTML = llantas.map(item => `
        <tr>
            <td>
                ${item.descripcion || ''}<br>
                <small class="text-muted">C√≥digo: ${item.codigo || 'N/A'}</small>
            </td>
            <td class="text-center">${item.cantidad || ''}</td>
            <td>
                ${item.volumenUnitario.toFixed(4)} m¬≥ √ó ${item.cantidad} = 
                <strong>${item.volumenTotal.toFixed(2)} m¬≥</strong>
            </td>
            <td>
                ${item.pesoUnitario.toFixed(2)} kg √ó ${item.cantidad} = 
                <strong>${item.pesoTotal.toFixed(2)} kg</strong>
            </td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarFila(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');

    // Mostrar el total de llantas
    const totalLlantasDiv = document.getElementById('totalLlantas');
    totalLlantasDiv.style.display = 'block';
    totalLlantasDiv.innerHTML = `
        <div class="alert alert-info">
            <strong>Resumen de carga:</strong><br>
            ‚Ä¢ Total de llantas: ${totalLlantas}<br>
            ‚Ä¢ Volumen total: ${volumenTotalBloque.toFixed(2)} m¬≥<br>
            ‚Ä¢ Peso total: ${pesoTotalBloque.toFixed(2)} kg
        </div>
    `;

    // Obtener y mostrar las unidades sugeridas
    const tablaSugerencias = document.getElementById('tablaUnidadesSugeridasBusqueda');
    if (!tablaSugerencias) {
        console.error('No se encontr√≥ la tabla de sugerencias');
        return;
    }
    
    // Asegurarse de que los totales sean n√∫meros v√°lidos
    volumenTotalBloque = parseFloat(volumenTotalBloque) || 0;
    pesoTotalBloque = parseFloat(pesoTotalBloque) || 0;

    console.log('Totales calculados:', {
        volumenTotal: volumenTotalBloque,
        pesoTotal: pesoTotalBloque
    });
    
    console.log('Obteniendo unidades de flota...');
    
    // Obtener unidades confirmadas
    const unidadesConfirmadas = new Set(pedidosApartados.map(pedido => 
        String(pedido['Econ√≥mico'] || pedido.Economico || pedido.economico || pedido.c√≥digo || '').trim()
    ));
    
    console.log('Unidades confirmadas:', Array.from(unidadesConfirmadas));
    
    // Filtrar unidades disponibles excluyendo las confirmadas
    const unidadesDisponibles = obtenerUnidadesFlota().filter(unidad => {
        const codigoUnidad = String(unidad.codigo || unidad.econ√≥mico || '').trim();
        return !unidadesConfirmadas.has(codigoUnidad);
    });
    console.log('Unidades disponibles:', unidadesDisponibles);

    console.log('Volumen total del bloque:', volumenTotalBloque);
    console.log('Peso total del bloque:', pesoTotalBloque);
    console.log('Unidades disponibles:', unidadesDisponibles);
    
    // Depuraci√≥n de valores iniciales
    console.log('Valores para filtrado:', {
        volumenTotalBloque,
        pesoTotalBloque,
        unidadesDisponibles: unidadesDisponibles.map(u => ({
            nombre: u.nombre,
            codigo: u.codigo,
            capacidadVolumen: u.capacidadVolumen,
            capacidadPeso: u.capacidadPeso
        }))
    });

    // Filtrar unidades v√°lidas y ordenar por eficiencia
    const unidadesOptimas = unidadesDisponibles
        .filter(u => {
            // Convertir las capacidades a n√∫meros para asegurar comparaciones v√°lidas
            const capVolumen = parseFloat(u.capacidadVolumen) || 0;
            const capPeso = parseFloat(u.capacidadPeso) || 0;
            
            const esValida = capVolumen >= volumenTotalBloque && capPeso >= pesoTotalBloque;
            
            console.log(`Evaluando unidad ${u.nombre} (${u.codigo}):`, {
                capacidadVolumen: capVolumen,
                volumenRequerido: volumenTotalBloque,
                capacidadPeso: capPeso,
                pesoRequerido: pesoTotalBloque,
                cumpleVolumen: capVolumen >= volumenTotalBloque,
                cumplePeso: capPeso >= pesoTotalBloque,
                esValida
            });
            
            return esValida;
        })
        .sort((a, b) => {
            // Calcular eficiencia como porcentaje de uso
            const eficienciaVolumenA = (volumenTotalBloque / parseFloat(a.capacidadVolumen)) * 100;
            const eficienciaPesoA = (pesoTotalBloque / parseFloat(a.capacidadPeso)) * 100;
            const eficienciaA = Math.min(eficienciaVolumenA, eficienciaPesoA);

            const eficienciaVolumenB = (volumenTotalBloque / parseFloat(b.capacidadVolumen)) * 100;
            const eficienciaPesoB = (pesoTotalBloque / parseFloat(b.capacidadPeso)) * 100;
            const eficienciaB = Math.min(eficienciaVolumenB, eficienciaPesoB);

            console.log(`Comparando eficiencias:`, {
                unidadA: `${a.nombre} (${a.codigo})`,
                eficienciaA: eficienciaA.toFixed(2) + '%',
                unidadB: `${b.nombre} (${b.codigo})`,
                eficienciaB: eficienciaB.toFixed(2) + '%'
            });

            return eficienciaB - eficienciaA;
        });

    console.log('Unidades √≥ptimas encontradas:', unidadesOptimas);

    if (unidadesOptimas.length === 0) {
        tablaSugerencias.innerHTML = `
            <tr>
                <td colspan="8" class="text-center">
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        No se encontr√≥ ninguna unidad que pueda transportar esta carga.
                        <br>
                        <small>
                            Volumen requerido: ${volumenTotalBloque.toFixed(2)} m¬≥ 
                            | Peso requerido: ${pesoTotalBloque.toFixed(2)} kg
                        </small>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tablaSugerencias.innerHTML = unidadesOptimas.map(unidad => {
        const usoVolumen = (volumenTotalBloque/unidad.capacidadVolumen * 100).toFixed(1);
        const usoPeso = (pesoTotalBloque/unidad.capacidadPeso * 100).toFixed(1);
        const eficiencia = Math.min(parseFloat(usoVolumen), parseFloat(usoPeso));

        console.log(`Generando fila para unidad ${unidad.nombre}:`, {
            usoVolumen,
            usoPeso,
            eficiencia
        });
        
        return `
            <tr>
                <td>${unidad.nombre}</td>
                <td>${unidad.codigo}</td>
                <td>${unidad.capacidadVolumen} m¬≥</td>
                <td>${unidad.capacidadPeso} kg</td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-primary" 
                             role="progressbar" 
                             style="width: ${usoVolumen}%" 
                             title="Uso de volumen: ${usoVolumen}%">
                            ${usoVolumen}%
                        </div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-warning" 
                             role="progressbar" 
                             style="width: ${usoPeso}%" 
                             title="Uso de peso: ${usoPeso}%">
                            ${usoPeso}%
                        </div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" 
                             role="progressbar" 
                             style="width: ${eficiencia}%" 
                             title="Eficiencia global: ${eficiencia}%">
                            ${eficiencia}%
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <button class="btn btn-success w-100 fw-bold" 
                            onclick="apartarUnidadConDetalles('${unidad.codigo}', window.llantasAgregadas, ${volumenTotalBloque}, ${pesoTotalBloque})">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Apartar Unidad
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Mostrar totales separados por tipo de llanta
    const tiposPorSeparado = llantasAgregadas.reduce((grupos, llanta) => {
        const tipo = llanta.descripcion;
        if (!grupos[tipo]) {
            grupos[tipo] = {
                cantidad: 0,
                volumen: 0,
                peso: 0
            };
        }
        grupos[tipo].cantidad += llanta.cantidad;
        grupos[tipo].volumen += llanta.volumenTotal;
        grupos[tipo].peso += llanta.pesoTotal;
        return grupos;
    }, {});

    document.getElementById('totalLlantas').innerHTML = `
        <div class="alert alert-info">
            <strong>Resumen Detallado por Tipo de Llanta:</strong><br>
            <div class="mt-3">
                ${Object.entries(tiposPorSeparado).map(([tipo, datos]) => `
                    <div class="mb-2 border-bottom pb-2">
                        <strong>${tipo}</strong><br>
                        ‚Ä¢ Cantidad: ${datos.cantidad} llantas<br>
                        ‚Ä¢ Volumen: ${datos.volumen.toFixed(2)} m¬≥<br>
                        ‚Ä¢ Peso: ${datos.peso.toFixed(2)} kg
                    </div>
                `).join('')}
            </div>
            <div class="mt-3 pt-2 border-top">
                <strong>Totales Generales:</strong><br>
                ‚Ä¢ Volumen total: ${totalVolumen.toFixed(2)} m¬≥<br>
                ‚Ä¢ Peso total: ${totalPeso.toFixed(2)} kg<br>
                ‚Ä¢ Total de llantas: ${cantidadTotal} unidades
            </div>
        </div>
    `;
    
    // Calcular y mostrar unidad sugerida
    const resultadoDiv = document.getElementById('resultadoSugerencia');
    resultadoDiv.classList.remove('d-none');
    
    // Obtener las unidades disponibles de la flota
    const unidades = obtenerUnidadesFlota();
    
    // Encontrar la unidad m√°s eficiente
    const unidadesValidas = unidades.filter(u => 
        u.capacidadVolumen >= totalVolumen && u.capacidadPeso >= totalPeso
    );
    
    const detallesDiv = document.getElementById('unidadSugeridaDetalles');
    
    if (unidadesValidas.length === 0) {
        detallesDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No se encontr√≥ una unidad adecuada para esta carga.
            </div>
        `;
        return;
    }
    
    const mejorUnidad = unidadesValidas.sort((a, b) => {
        const eficienciaA = Math.min(totalVolumen/a.capacidadVolumen, totalPeso/a.capacidadPeso);
        const eficienciaB = Math.min(totalVolumen/b.capacidadVolumen, totalPeso/b.capacidadPeso);
        return eficienciaB - eficienciaA;
    })[0];
    
    const usoVolumen = (totalVolumen/mejorUnidad.capacidadVolumen * 100).toFixed(1);
    const usoPeso = (totalPeso/mejorUnidad.capacidadPeso * 100).toFixed(1);
    const eficiencia = Math.min(
        (totalVolumen/mejorUnidad.capacidadVolumen * 100),
        (totalPeso/mejorUnidad.capacidadPeso * 100)
    ).toFixed(1);
    
    // Guardar los datos del bloque seleccionado globalmente
    window.bloqueSeleccionado = {
        llantas: llantas,
        volumenTotal: totalVolumen,
        pesoTotal: totalPeso,
        unidad: mejorUnidad
    };

    // Mostrar la informaci√≥n de la unidad seleccionada
    detallesDiv.innerHTML = `
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Unidad Seleccionada</h5>
            </div>
            <div class="card-body">
                <p><strong>Unidad:</strong> ${mejorUnidad.nombre || mejorUnidad.unidad}</p>
                <p><strong>Econ√≥mico:</strong> ${mejorUnidad.codigo || mejorUnidad.economico}</p>
                <p><strong>Uso de Volumen:</strong> ${usoVolumen}%</p>
                <p><strong>Uso de Peso:</strong> ${usoPeso}%</p>
                <p><strong>Eficiencia Global:</strong> ${eficiencia}%</p>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="apartarUnidadConDetalles(window.bloqueSeleccionado.unidad, window.bloqueSeleccionado.llantas, window.bloqueSeleccionado.volumenTotal, window.bloqueSeleccionado.pesoTotal)">
                        <i class="bi bi-box-arrow-right"></i> Apartar esta unidad
                    </button>
                </div>
            </div>
        </div>
    `;
    }

    let htmlUnidades = '';
    distribucion.unidades.forEach((info, index) => {
        const usoVolumen = (info.volumen/info.unidad.capacidadVolumen * 100).toFixed(1);
        const usoPeso = (info.peso/info.unidad.capacidadPeso * 100).toFixed(1);
        
        htmlUnidades += `
            <div class="card mb-3">
                <div class="card-header bg-${index === 0 ? 'primary' : 'success'} text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        ${index === 0 ? 'Unidad Principal' : 'Unidad Auxiliar'}
                    </h5>
                    <button class="btn btn-light" 
                            onclick='apartarUnidad(
                                {"nombre": "${info.unidad.nombre}", "codigo": "${info.unidad.codigo}"}, 
                                ${JSON.stringify(llantasAgregadas)}, 
                                ${info.volumen}, 
                                ${info.peso}
                            )'>
                        <i class="bi bi-box-arrow-right"></i> Apartar Esta Unidad
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Unidad</th>
                                <th>Econ√≥mico</th>
                                <th>Capacidad</th>
                                <th>Carga Asignada</th>
                                <th>Uso</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${info.unidad.nombre}</td>
                                <td>${info.unidad.codigo}</td>
                                <td>
                                    <div>Volumen: ${info.unidad.capacidadVolumen} m¬≥</div>
                                    <div>Peso: ${info.unidad.capacidadPeso} kg</div>
                                </td>
                                <td>
                                    <div>Volumen: ${info.volumen.toFixed(2)} m¬≥</div>
                                    <div>Peso: ${info.peso.toFixed(2)} kg</div>
                                </td>
                                <td>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-primary" 
                                             role="progressbar" 
                                             style="width: ${usoVolumen}%" 
                                             title="Uso de volumen: ${usoVolumen}%">
                                            Vol: ${usoVolumen}%
                                        </div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning" 
                                             role="progressbar" 
                                             style="width: ${usoPeso}%" 
                                             title="Uso de peso: ${usoPeso}%">
                                            Peso: ${usoPeso}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-2">
                        <strong>Eficiencia de la unidad:</strong>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" 
                                 role="progressbar" 
                                 style="width: ${info.eficiencia}%" 
                                 title="Eficiencia: ${info.eficiencia.toFixed(1)}%">
                                ${info.eficiencia.toFixed(1)}%
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" 
                                onclick="apartarUnidad(
                                    {nombre: '${info.unidad.nombre}', codigo: '${info.unidad.codigo}'}, 
                                    ${JSON.stringify(llantasAgregadas)}, 
                                    ${info.volumen}, 
                                    ${info.peso}
                                )">
                            <i class="bi bi-box-arrow-right"></i> Apartar Esta Unidad
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    detallesDiv.innerHTML = `
        <div class="alert alert-info mb-3">
            <strong>Distribuci√≥n √≥ptima encontrada</strong><br>
            Eficiencia global: ${distribucion.eficienciaTotal.toFixed(1)}%
        </div>
        ${htmlUnidades}
                            </div>
                        </td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: ${eficiencia}%" 
                                     aria-valuenow="${eficiencia}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${eficiencia}%
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;


function calcularUnidadSugerida(volumenTotal, pesoTotal) {
    // Obtener las unidades de la flota
    const unidades = obtenerUnidadesFlota();
    
    const resultadoDiv = document.getElementById('resultadoSugerencia');
    const detallesDiv = document.getElementById('unidadSugeridaDetalles');
    
    // Encontrar las unidades v√°lidas y no apartadas
    const unidadesValidas = unidades.filter(u => 
        u.capacidadVolumen >= volumenTotal && 
        u.capacidadPeso >= pesoTotal &&
        !estaUnidadApartada(u.codigo)
    );

    detallesDiv.innerHTML = `
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Unidad Sugerida</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Unidad</th>
                            <th>Econ√≥mico</th>
                            <th>Cap. Volumen</th>
                            <th>Cap. Peso</th>
                            <th style="width: 120px">Uso Volumen</th>
                            <th style="width: 120px">Uso Peso</th>
                            <th style="width: 120px">Eficiencia</th>
                            <th style="width: 120px">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    if (unidadesValidas.length === 0) {
        detallesDiv.innerHTML += `
                    </tbody>
                </table>
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    No se encontr√≥ ninguna unidad que pueda transportar esta carga.
                </div>
            </div>
        </div>`;
    } else {
        // Ordenar por eficiencia
        const unidadesOrdenadas = unidadesValidas.sort((a, b) => {
            const eficienciaA = Math.min(volumenTotal/a.capacidadVolumen, pesoTotal/a.capacidadPeso);
            const eficienciaB = Math.min(volumenTotal/b.capacidadVolumen, pesoTotal/b.capacidadPeso);
            return eficienciaB - eficienciaA;
        });

        // Mostrar las unidades ordenadas por eficiencia
        const htmlUnidades = unidadesOrdenadas.map(unidad => {
            const usoVolumen = (volumenTotal/unidad.capacidadVolumen * 100).toFixed(1);
            const usoPeso = (pesoTotal/unidad.capacidadPeso * 100).toFixed(1);
            const eficiencia = Math.min(parseFloat(usoVolumen), parseFloat(usoPeso));
            
            return `
                <tr>
                    <td>${unidad.nombre}</td>
                    <td>${unidad.codigo}</td>
                    <td>${unidad.capacidadVolumen} m¬≥</td>
                    <td>${unidad.capacidadPeso} kg</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-primary" 
                                 role="progressbar" 
                                 style="width: ${usoVolumen}%" 
                                 title="Uso de volumen: ${usoVolumen}%">
                                ${usoVolumen}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" 
                                 role="progressbar" 
                                 style="width: ${usoPeso}%" 
                                 title="Uso de peso: ${usoPeso}%">
                                ${usoPeso}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" 
                                 role="progressbar" 
                                 style="width: ${eficiencia}%" 
                                 title="Eficiencia global: ${eficiencia}%">
                                ${eficiencia}%
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-success w-100 fw-bold" 
                                style="font-size: 0.9rem;"
                                onclick="apartarUnidad(
                                    {
                                        nombre: '${unidad.nombre}',
                                        codigo: '${unidad.codigo}',
                                        capacidadVolumen: ${unidad.capacidadVolumen},
                                        capacidadPeso: ${unidad.capacidadPeso}
                                    }, 
                                    window.llantasAgregadas,
                                    ${volumenTotal},
                                    ${pesoTotal}
                                )">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Apartar Unidad
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        detallesDiv.innerHTML += htmlUnidades + `
                    </tbody>
                </table>
            </div>
        </div>`;
    }

    resultadoDiv.classList.remove('d-none');
}

function limpiarCalculadora() {
    // Confirmar con el usuario
    if (!confirm('¬øEst√°s seguro de que quieres limpiar todos los datos de la calculadora?')) {
        return;
    }

    // Limpiar las llantas agregadas globalmente
    llantasAgregadas = [];
    
    // Limpiar tabla de llantas agregadas
    const tablaLlantas = document.getElementById('tablaLlantasAgregadas').querySelector('tbody');
    tablaLlantas.innerHTML = '';
    
    // Resetear valores de entrada
    document.getElementById('sugestionCantidad').value = '1';
    document.getElementById('sugestionTipoLlanta').selectedIndex = 0;
    
    // Limpiar totales
    const totalLlantasDiv = document.getElementById('totalLlantas');
    if (totalLlantasDiv) {
        totalLlantasDiv.innerHTML = '';
    }
    
    // Ocultar y limpiar resultados de sugerencia
    const resultadoSugerencia = document.getElementById('resultadoSugerencia');
    if (resultadoSugerencia) {
        resultadoSugerencia.classList.add('d-none');
    }
    
    const unidadSugeridaDetalles = document.getElementById('unidadSugeridaDetalles');
    if (unidadSugeridaDetalles) {
        unidadSugeridaDetalles.innerHTML = '';
    }
    
    // Ocultar y limpiar secci√≥n de unidad sugerida
    const seccionUnidadSugerida = document.getElementById('seccionUnidadSugeridaCalculadora');
    if (seccionUnidadSugerida) {
        seccionUnidadSugerida.style.display = 'none';
    }
    
    // Limpiar totales
    document.getElementById('totalLlantas').innerHTML = '';
}

function limpiarBusquedaBloques() {
    // Confirmar con el usuario
    if (!confirm('¬øEst√°s seguro de que quieres limpiar todos los datos de la b√∫squeda?')) {
        return;
    }

    // Limpiar campo de b√∫squeda
    document.getElementById('busquedaBloque').value = '';
    
    // Limpiar resultados de b√∫squeda
    document.getElementById('resultadosBusqueda').innerHTML = '';
    
    // Limpiar tabla de llantas seleccionadas
    const tablaLlantas = document.getElementById('tablaLlantasSeleccionadas');
    if (tablaLlantas) {
        const tbody = tablaLlantas.querySelector('tbody');
        if (tbody) tbody.innerHTML = '';
    }
    
    // Ocultar y limpiar secci√≥n de unidad sugerida
    const seccionUnidadSugerida = document.getElementById('seccionUnidadSugeridaBusqueda');
    if (seccionUnidadSugerida) {
        seccionUnidadSugerida.style.display = 'none';
    }
    
    // Limpiar totales
    const totalLlantas = document.getElementById('totalLlantas');
    if (totalLlantas) {
        totalLlantas.style.display = 'none';
        totalLlantas.innerHTML = '';
    }
}

function limpiarSeleccion() {
    // Limpiar tabla de llantas agregadas
    const tablaLlantas = document.getElementById('tablaLlantasAgregadas').querySelector('tbody');
    tablaLlantas.innerHTML = '';
    
    // Ocultar resultado de sugerencia
    const resultadoDiv = document.getElementById('resultadoSugerencia');
    resultadoDiv.classList.add('d-none');
    
    // Limpiar totales
    document.getElementById('totalLlantas').innerHTML = '';
}

function obtenerUnidadesFlota() {
    try {
        // Obtener los datos directamente de la tabla de flota
        const tabla = document.querySelector('#tablaFlota tbody');
        if (!tabla) {
            console.error('No se encontr√≥ la tabla de flota (#tablaFlota tbody)');
            return [];
        }
        
        console.log('Tabla de flota encontrada');
        console.log('N√∫mero de filas encontradas:', tabla.rows.length);
        
        // Convertir las filas de la tabla en objetos de unidades
        const unidadesDisponibles = [];
        
        for (let i = 0; i < tabla.rows.length; i++) {
            const row = tabla.rows[i];
            
            // Verificar que la fila tenga todas las celdas necesarias (necesitamos al menos 8 columnas)
            if (row.cells.length < 8) {
                console.warn(`Fila ${i} tiene estructura incorrecta:`, row.cells.length, 'celdas');
                continue;
            }

            try {
                // Los datos est√°n en el orden: Econ√≥mico, Unidad, Asignado, Modelo, ID, Ubicaci√≥n, Cap. Peso, Volumen
                const economico = row.cells[0].textContent.trim();          // Econ√≥mico (primera columna)
                const nombreUnidad = row.cells[1].textContent.trim();       // Unidad (segunda columna)
                const capacidadPeso = parseFloat(row.cells[6].textContent.trim()) || 0;    // Capacidad de carga en kg (s√©ptima columna)
                const capacidadVolumen = parseFloat(row.cells[7].textContent.trim()) || 0;  // Volumen en m¬≥ (octava columna)

                console.log(`Procesando fila ${i}:`, {
                    nombre: nombreUnidad,
                    codigo: economico,
                    capacidadVolumen: capacidadVolumen,
                    capacidadPeso: capacidadPeso
                });

                const unidad = {
                    nombre: nombreUnidad,
                    codigo: economico,
                    capacidadVolumen: capacidadVolumen, // Volumen fijo por ahora
                    capacidadPeso: capacidadPeso, // Peso de la columna 3
                    estado: 'Disponible' // Por defecto disponible
                };

                console.log('Unidad procesada correctamente:', unidad);
                unidadesDisponibles.push(unidad);
            } catch (error) {
                console.error(`Error al procesar fila ${i}:`, error);
            }
        }

        console.log('Total de unidades procesadas:', unidadesDisponibles.length);
        console.log('Unidades disponibles:', unidadesDisponibles);
        
        return unidadesDisponibles;
    } catch (error) {
        console.error('Error general en obtenerUnidadesFlota:', error);
        return [];
    }

    // Obtener los n√∫meros econ√≥micos de las unidades confirmadas
    const unidadesConfirmadas = new Set(pedidosApartados.map(pedido => 
        String(pedido['Econ√≥mico'] || pedido.Economico || pedido.economico || pedido.c√≥digo || '').trim().toLowerCase()
    ));

    // Filtrar unidades que est√©n disponibles Y NO est√©n en la lista de confirmadas
    console.log('Unidades disponibles antes de filtrar:', unidadesDisponibles);
    console.log('Unidades confirmadas:', Array.from(unidadesConfirmadas));
    
    const unidadesFiltradas = unidadesDisponibles.filter(u => {
        const codigoUnidad = String(u.codigo || '').trim().toLowerCase();
        const estaDisponible = u.estado === "Disponible";
        const noEstaConfirmada = !unidadesConfirmadas.has(codigoUnidad);
        
        console.log(`Unidad ${u.nombre} (${codigoUnidad}):`, {
            estaDisponible,
            noEstaConfirmada,
            estado: u.estado
        });
        
        return estaDisponible && noEstaConfirmada;
    });
    
    console.log('Unidades filtradas final:', unidadesFiltradas);
    return unidadesFiltradas;
}

function buscarBloques() {
    const busqueda = document.getElementById('busquedaBloque').value.toLowerCase();
    const resultados = document.getElementById('resultadosBusqueda');
    
    // Si no hay t√©rmino de b√∫squeda, limpiamos los resultados
    if (!busqueda) {
        resultados.innerHTML = '<div class="alert alert-info">Ingresa el nombre del bloque o alg√∫n detalle para buscarlo.</div>';
        return;
    }

    // Obtener los n√∫meros econ√≥micos de las unidades confirmadas
    const unidadesConfirmadas = new Set(pedidosApartados.map(pedido => 
        String(pedido['Econ√≥mico'] || pedido.Economico || pedido.economico || pedido.c√≥digo || '').trim().toLowerCase()
    ));
    
    console.log('Unidades confirmadas:', Array.from(unidadesConfirmadas));
    
    // Filtrar los bloques y excluir unidades confirmadas
    const bloquesFiltrados = bloquesFacturas.filter(bloque => {
        // Primero verificamos si el bloque coincide con la b√∫squeda
        const nombre = (bloque.nombre || '').toLowerCase();
        const datos = bloque.datos || [];
        
        // Verificar si la unidad est√° en Apartados (considerando diferentes formatos de c√≥digo)
        const codigoUnidad = String(bloque.economico || bloque.codigo || '').trim().toLowerCase();
        if (codigoUnidad && unidadesConfirmadas.has(codigoUnidad)) {
            console.log('Bloque excluido por unidad confirmada:', codigoUnidad);
            return false;
        }
        
        // Solo si la unidad no est√° confirmada, verificamos si coincide con la b√∫squeda
        const contenidoMatch = datos.some(item => {
            const descripcion = (item.Descripci√≥n || '').toLowerCase();
            const codigo = (item.C√≥digo || '').toLowerCase();
            return descripcion.includes(busqueda) || codigo.includes(busqueda);
        });

        return nombre.includes(busqueda) || contenidoMatch;
    });
    
    // Mostrar resultados
    if (bloquesFiltrados.length === 0) {
        resultados.innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-triangle"></i> No se encontraron bloques disponibles</h6>
                <p>Esto puede deberse a:</p>
                <ul>
                    <li>No hay bloques que coincidan con la b√∫squeda "${busqueda}"</li>
                    <li>Los bloques encontrados est√°n asignados a unidades en uso</li>
                </ul>
            </div>`;
        return;
    }

    // Generar HTML para los resultados
    resultados.innerHTML = bloquesFiltrados.map((bloque, idx) => `
        <div class="card mb-3 rounded">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${bloque.nombre || 'Sin nombre'}</h6>
                    <div>
                        <button class="btn btn-primary me-2" onclick="seleccionarBloque(${idx})">
                            Seleccionar Bloque
                        </button>
                        <button class="btn btn-info" onclick="mostrarDetalles(${idx})">
                            Ver detalles
                        </button>
                    </div>
                </div>
            </div>
            <div id="detalles_${idx}" class="card-body border-top" style="display: none;">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Cantidad</th>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bloque.datos.map(f => `
                            <tr>
                                <td>${f.Cantidad || ''}</td>
                                <td>${f.C√≥digo || ''}</td>
                                <td>${f.Descripci√≥n || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `).join('');
}

// Eliminar bloque de la p√°gina y de la hoja de c√°lculo
// filepath: c:\Users\mg296\OneDrive\Escritorio\cubicaja\Proyecto_de_residencia_profesional.html
// ...existing code...
async function eliminarBloqueFactura(idx) {
    if (!confirm('¬øSeguro que deseas eliminar este bloque de facturas?')) return;
    const bloque = bloquesFacturas[idx];
    const nombreBloque = (bloque.nombre || '').trim().toLowerCase();

    // 1. Obt√©n todas las filas con ese nombre
    let errores = 0;
    try {
        const res = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/Nombre/${encodeURIComponent(nombreBloque)}?sheet=facturas`);
        const facturas = await res.json();
        // 2. Elimina cada una por su row_id
        for (const factura of facturas) {
            if (factura.row_id) {
                const delRes = await fetch(`https://sheetdb.io/api/v1/w4fnfd0um1c3o/row_id/${factura.row_id}?sheet=facturas`, {
                    method: 'DELETE'
                });
                if (!delRes.ok) errores++;
            }
        }
    } catch (e) {
        errores = bloque.datos.length;
    }
    bloquesFacturas.splice(idx, 1);
    mostrarBloquesFacturas();
    if (errores > 0) {
        alert(`El bloque se elimin√≥ de la p√°gina, pero ${errores} factura(s) no se pudieron eliminar de la hoja de c√°lculo.`);
    } else {
        alert('Bloque eliminado correctamente de la p√°gina y la hoja de c√°lculo.');
    }
}
// ...existing code...
// Buscar bloques por nombre
document.getElementById('facturaSearchFolio').addEventListener('input', function() {
    mostrarBloquesFacturas(this.value);
});

// Al cargar la pesta√±a, carga los bloques desde SheetDB
document.querySelector('button[data-tab="facturas"]').addEventListener('click', async () => {
    try {
        const res = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=facturas');
        if (!res.ok) throw new Error('No se pudo cargar facturas');
        const facturas = await res.json();
        bloquesFacturas = [];
        let grupos = {};
        facturas.forEach(f => {
            // Agrupa por 'Nombre' (may√∫scula inicial)
            const grupo = f.Nombre || f.Folio || f["Fecha de Emisi√≥n"] || 'Sin nombre';
            if (!grupos[grupo]) grupos[grupo] = [];
            grupos[grupo].push(f);
        });
        for (const nombre in grupos) {
            bloquesFacturas.push({ nombre, datos: grupos[nombre] });
        }
        mostrarBloquesFacturas();
    } catch (e) {
        document.getElementById('facturaGroupsContainer').innerHTML = '<div class="alert alert-danger">No se pudo cargar facturas guardadas.</div>';
    }
});

// Funci√≥n para limpiar la b√∫squeda y las llantas acumuladas
function limpiarBusquedaBloqueEnModo() {
    document.getElementById('inputBusquedaBloqueNuevo').value = '';
    document.getElementById('resultadoBusquedaBloqueNuevo').innerHTML = '';
    llantasAcumuladasEnBloque = [];
    actualizarTablaLlantasBloque([]);
}

// Funci√≥n modificada para agregar bloques
async function agregarBloqueEnModo(continuarAgregando = true) {
    const folio = document.getElementById('inputBusquedaBloqueNuevo').value.trim().toLowerCase();
    const divResultado = document.getElementById('resultadoBusquedaBloqueNuevo');
    
    if (!folio) {
        divResultado.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle"></i> Por favor, ingrese un folio v√°lido.
            </div>`;
        return;
    }

    try {
        let llantasParaAgregar = [];

        // Buscar en todas las fuentes
        const facturasRecientes = facturasParaGuardar.filter(f => 
            f.Nombre?.toLowerCase() === folio ||
            f.Folio?.toLowerCase() === folio
        );
        if (facturasRecientes.length > 0) {
            llantasParaAgregar = llantasParaAgregar.concat(facturasRecientes);
        }

        const resEscaneados = await fetch('https://sheetdb.io/api/v1/w4fnfd0um1c3o?sheet=Escaneados especiales');
        const escaneados = await resEscaneados.json();
        const escaneadosDelFolio = escaneados.filter(r => 
            r.Nombre?.toLowerCase() === folio ||
            r.nombre?.toLowerCase() === folio
        );
        if (escaneadosDelFolio.length > 0) {
            llantasParaAgregar = llantasParaAgregar.concat(escaneadosDelFolio);
        }

        const bloquesFactura = bloquesFacturas.filter(b => 
            b.nombre.toLowerCase() === folio
        );
        if (bloquesFactura.length > 0) {
            llantasParaAgregar = llantasParaAgregar.concat(bloquesFactura[0].datos || []);
        }

        if (llantasParaAgregar.length > 0) {
            // Acumular las nuevas llantas con las existentes
            llantasAcumuladasEnBloque = llantasAcumuladasEnBloque.concat(llantasParaAgregar);
            
            // Actualizar la tabla con todas las llantas acumuladas
            actualizarTablaLlantasBloque(llantasAcumuladasEnBloque);
            
            // Mostrar mensaje de √©xito
            divResultado.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 
                    Se agregaron ${llantasParaAgregar.length} llantas al bloque. Total acumulado: ${llantasAcumuladasEnBloque.length} llantas.
                </div>`;
            document.getElementById('inputBusquedaBloqueNuevo').value = '';
        } else {
            divResultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> No se encontraron llantas para agregar con el folio "${folio}".
                </div>`;
        }
    } catch (error) {
        console.error('Error al agregar bloque:', error);
        divResultado.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error al agregar el bloque: ${error.message}
            </div>`;
    }
}
</script>

<!-- Bootstrap y otros scripts -->      
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
