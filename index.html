<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Volumen de Llantas</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  h1 {
    color: #333;
  }
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 1em; 
  }
  th, td { 
    border: 1px solid #ccc; 
    padding: 0.5em; 
    text-align: center; 
  }
  th { 
    background-color: #eee; 
  }
  button { 
    margin-top: 1em; 
    padding: 0.5em 1em; 
    font-size: 1em; 
    cursor: pointer;
  }
  #loading {
    margin-top: 1em;
    font-style: italic;
    color: #555;
    display: none;
  }
</style>
</head>
<body>

<h1>Inventario de Llantas</h1>
<button id="btnCalcular">Calcular Volumen</button>
<div id="loading">Calculando volúmenes, por favor espere...</div>

<table id="tablaInventario">
  <thead>
    <tr>
      <th>Clave</th>
      <th>Descripción</th>
      <th>Peso</th>
      <th>Volumen (m³)</th>
      <th>Valor</th>
      <th>Línea</th>
    </tr>
  </thead>
  <tbody>
    <!-- Datos se insertan aquí -->
  </tbody>
</table>

<script>
const API_BASE = 'https://sheetdb.io/api/v1/tblylxi4mrvid';
let inventario = [];

async function cargarInventario() {
  try {
    const res = await fetch(API_BASE);
    inventario = await res.json();
    renderInventario();
  } catch (error) {
    alert('Error al cargar inventario: ' + error);
  }
}

function renderInventario() {
  const tbody = document.querySelector('#tablaInventario tbody');
  tbody.innerHTML = '';
  inventario.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.clave}</td>
      <td>${item.descripcion}</td>
      <td>${item.peso}</td>
      <td>${item.volumen || ''}</td>
      <td>${item.valor}</td>
      <td>${item.linea}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function calcularVolumenInventario() {
  document.getElementById('loading').style.display = 'block';
  inventario.sort((a, b) => Number(a.clave) - Number(b.clave));
  let noCalculadas = [];
  const margenLogistico = 1.90; // 90% extra por logística

  for (const llanta of inventario) {
    if (!llanta.volumen || Number(llanta.volumen) === 0) {
      let ancho, perfil, rin;
      let desc = llanta.descripcion.replace(/[()]/g, '').toUpperCase();

      // 1. 185 60 R14 o 185/60 R14
      let m = desc.match(/(\d{3})[\/\s\-](\d{2})[\/\s\-]?R?(\d{2,2}\.?\d*)/);
      if (m) {
        ancho = Number(m[1]) / 1000; // a metros
        perfil = Number(m[2]) / 100;
        rin = Number(m[3]) * 0.0254; // a metros
      }
      // 2. 11R22.5, 12R24.5, 295 75 R22.5
      else if ((m = desc.match(/(\d{2,3})R(\d{2,2}\.?\d*)/))) {
        ancho = Number(m[1]) * 25.4 / 1000; // pulgadas a metros
        perfil = 0.80; // asume 80%
        rin = Number(m[2]) * 0.0254;
      }
      // 3. 31X10.50 R15, 33X12.50 R15
      else if ((m = desc.match(/(\d{2,3})[Xx](\d{2,3}\.?\d*)\s*R?(\d{2,2})/))) {
        rin = Number(m[1]) * 0.0254;
        ancho = Number(m[2]) * 25.4 / 1000;
        perfil = 0.80;
      }
      // 4. 7.50-16, 12.5/80-18, 14.9-24, 12-16.5
      else if ((m = desc.match(/(\d{1,2}\.?\d*)[\/\-](\d{2,3})[\- ](\d{2,2}\.?\d*)/))) {
        ancho = Number(m[1]) * 25.4 / 1000;
        perfil = 0.80;
        rin = Number(m[3]) * 0.0254;
      }
      // 5. 285/75 R24.5, 295/80 R22.5
      else if ((m = desc.match(/(\d{3})\/(\d{2})\s*R?(\d{2,2}\.?\d*)/))) {
        ancho = Number(m[1]) / 1000;
        perfil = Number(m[2]) / 100;
        rin = Number(m[3]) * 0.0254;
      }
      // 6. 14.9-24, 12-16.5 (sin perfil)
      else if ((m = desc.match(/(\d{1,2}\.?\d*)[\- ](\d{2,2}\.?\d*)/))) {
        ancho = Number(m[1]) * 25.4 / 1000;
        perfil = 0.80;
        rin = Number(m[2]) * 0.0254;
      }
      else {
        noCalculadas.push(llanta.descripcion);
        continue;
      }

      // Altura flanco
      let alturaFlanco = perfil * ancho;
      // Diámetro externo
      let diametroExterno = rin + 2 * alturaFlanco;

      // Volumen tipo cubicaje (como en la imagen), con margen logístico
      let volumen_m3 = diametroExterno * diametroExterno * ancho * margenLogistico;

      // Actualiza en SheetDB
      try {
        const patchRes = await fetch(`https://sheetdb.io/api/v1/tblylxi4mrvid/clave/${llanta.clave}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: { volumen: volumen_m3.toFixed(4) } })
        });
        if (!patchRes.ok) throw new Error('Error al actualizar volumen en API');
        llanta.volumen = volumen_m3.toFixed(4);
      } catch (error) {
        noCalculadas.push(llanta.descripcion + ' (error actualización)');
      }
    }
  }
  renderInventario();
  document.getElementById('loading').style.display = 'none';

  if (noCalculadas.length > 0) {
    alert('No se pudo calcular el volumen de las siguientes llantas:\n' + noCalculadas.slice(0, 10).join('\n') + (noCalculadas.length > 10 ? '\n...y más' : ''));
  } else {
    alert('Volumen calculado y actualizado para todas las llantas que tenían volumen vacío (con margen de seguridad).');
  }
}

document.getElementById('btnCalcular').addEventListener('click', calcularVolumenInventario);

cargarInventario();
</script>

</body>
</html>
